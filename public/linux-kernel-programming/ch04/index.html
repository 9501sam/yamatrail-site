<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Ch04: Writing Your First Kernel Module - LKMs Part 1 | Yama&#39;s Trail</title>
<meta name="keywords" content="">
<meta name="description" content="Understanding kernel architecture – part 1
Exploring LKMs
The LKM framework

Kernel modules within the kernel source tree

kernel modules 存放於 /lib/modules/$(uname -r)/

以我的例子來說，正在運行 95 個 modules，可以發現跟書上的範例 5359 差很多，我的推測是我使用的是 server 版，書上使用的是 desktop 版。

其中一個大量使用 modules 這種方式的是 device driver，例如可以看 kernel/drivers/net/ethernet


原先 Ubuntu 18.04 的 netword drivers:



我自己編譯的 5.4.1-llkd01 的 device drivers:

明顯少了許多，這是因為當初在 build 時，是使用 lsmod 抓取正在運行中的 module，並不像 ubuntu 需要考慮各種可能的情境


其中的個有名的 driver 是 Intel 1GbE Network Interface Card (NIC)


lsmod | grep e1000
">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/linux-kernel-programming/ch04/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e1f5c4cae44599655f7ff95195ff89c8cb3adbda94f2b1581a434ab2b4d4e6cf.css" integrity="sha256-4fXEyuRFmWVff/lRlf&#43;JyMs629qU8rFYGkNKsrTU5s8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon_io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon_io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon_io/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon_io/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/linux-kernel-programming/ch04/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Yama&#39;s Trail (Alt + H)">Yama&#39;s Trail</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/dev-log/" title="這個網站的誕生">
                    <span>這個網站的誕生</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/leetcode/" title="LeetCode 解題">
                    <span>LeetCode 解題</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xv6/" title="xv6 學習紀錄">
                    <span>xv6 學習紀錄</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/linux-kernel-programming/" title="Linux Kernel Programming">
                    <span>Linux Kernel Programming</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Ch04: Writing Your First Kernel Module - LKMs Part 1
    </h1>
    <div class="post-meta"><span title='2025-12-08 08:39:49 +0800 CST'>December 8, 2025</span>

</div>
  </header> 
  <div class="post-content"><h1 id="understanding-kernel-architecture--part-1">Understanding kernel architecture – part 1<a hidden class="anchor" aria-hidden="true" href="#understanding-kernel-architecture--part-1">#</a></h1>
<h1 id="exploring-lkms">Exploring LKMs<a hidden class="anchor" aria-hidden="true" href="#exploring-lkms">#</a></h1>
<h2 id="the-lkm-framework">The LKM framework<a hidden class="anchor" aria-hidden="true" href="#the-lkm-framework">#</a></h2>
<p><img alt="4.3.png" loading="lazy" src="/linux-kernel-programming/ch04/4.3.png"></p>
<h2 id="kernel-modules-within-the-kernel-source-tree">Kernel modules within the kernel source tree<a hidden class="anchor" aria-hidden="true" href="#kernel-modules-within-the-kernel-source-tree">#</a></h2>
<ul>
<li>kernel modules 存放於 <code>/lib/modules/$(uname -r)/</code>
<img alt="152.png" loading="lazy" src="/linux-kernel-programming/ch04/152.png">
以我的例子來說，正在運行 95 個 modules，可以發現跟書上的範例 5359 差很多，我的推測是我使用的是 server 版，書上使用的是 desktop 版。</li>
</ul>
<p>其中一個大量使用 modules 這種方式的是 device driver，例如可以看 <code>kernel/drivers/net/ethernet</code></p>
<ul>
<li>
<p>原先 Ubuntu 18.04 的 netword drivers:
<img alt="153-1.png" loading="lazy" src="/linux-kernel-programming/ch04/153-1.png"></p>
</li>
<li>
<p>我自己編譯的 <code>5.4.1-llkd01</code> 的 device drivers:
<img alt="153-2.png" loading="lazy" src="/linux-kernel-programming/ch04/153-2.png">
明顯少了許多，這是因為當初在 build 時，是使用 <code>lsmod</code> 抓取正在運行中的 module，並不像 ubuntu 需要考慮各種可能的情境</p>
</li>
<li>
<p>其中的個有名的 driver 是 Intel 1GbE Network Interface Card (NIC)</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>lsmod | grep e1000
</span></span></code></pre></div><p><img alt="153-3.png" loading="lazy" src="/linux-kernel-programming/ch04/153-3.png"></p>
<ul>
<li>使用 <code>modinfo</code> 可以獲取更多的資訊</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ls -l /lib/modules/5.4.1-llkd01/kernel/drivers/net/ethernet/intel/e1000
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>modinfo /lib/modules/5.4.1-llkd01/kernel/drivers/net/ethernet/intel/e1000/e1000.ko
</span></span></code></pre></div><p><img alt="154.png" loading="lazy" src="/linux-kernel-programming/ch04/154.png"></p>
<h1 id="writing-our-very-first-kernel-module">Writing our very first kernel module<a hidden class="anchor" aria-hidden="true" href="#writing-our-very-first-kernel-module">#</a></h1>
<p>這節開始很俗氣的來寫 Hello World
怕打錯字的話，可以用連結
<a href="https://github.com/PacktPublishing/Linux-Kernel-Programming">https://github.com/PacktPublishing/Linux-Kernel-Programming</a></p>
<h2 id="introducing-our-hello-world-lkm-c-code">Introducing our Hello, world LKM C code<a hidden class="anchor" aria-hidden="true" href="#introducing-our-hello-world-lkm-c-code">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ch4/helloworld_lkm/helloworld_lkm.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> ***************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * This program is part of the source code released for the book
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  &#34;Linux Kernel Programming&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  (c) Author: Kaiwan N Billimoria
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  Publisher:  Packt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  GitHub repository:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  https://github.com/PacktPublishing/Linux-Kernel-Programming
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * From: Ch 4: Writing your First Kernel Module - LKMs Part 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> ****************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Brief Description:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Our very first kernel module, the &#39;Hello, world&#39; of course! The
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * idea being to explain the essentials of the Linux kernel&#39;s LKM
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * framework.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * For details, please refer the book, Ch 4.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/init.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/kernel.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/module.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MODULE_AUTHOR</span>(<span style="color:#e6db74">&#34;&lt;insert your name here&gt;&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MODULE_DESCRIPTION</span>(<span style="color:#e6db74">&#34;LKP book:ch4/helloworld_lkm: hello, world, our first LKM&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MODULE_LICENSE</span>(<span style="color:#e6db74">&#34;Dual MIT/GPL&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MODULE_VERSION</span>(<span style="color:#e6db74">&#34;0.1&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> __init <span style="color:#a6e22e">helloworld_lkm_init</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printk</span>(KERN_INFO <span style="color:#e6db74">&#34;Hello, world</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;		<span style="color:#75715e">/* success */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> __exit <span style="color:#a6e22e">helloworld_lkm_exit</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printk</span>(KERN_INFO <span style="color:#e6db74">&#34;Goodbye, world</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">module_init</span>(helloworld_lkm_init);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">module_exit</span>(helloworld_lkm_exit);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cd ~/Linux-Kernel-Programming/ch4/helloworld_lkm
</span></span><span style="display:flex;"><span>../../lkm helloworld_lkm
</span></span></code></pre></div><p><img alt="hw.png" loading="lazy" src="/linux-kernel-programming/ch04/hw.png"></p>
<h2 id="breaking-it-down">Breaking it down<a hidden class="anchor" aria-hidden="true" href="#breaking-it-down">#</a></h2>
<h3 id="kernel-headers">Kernel headers<a hidden class="anchor" aria-hidden="true" href="#kernel-headers">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/init.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/kernel.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/module.h&gt;</span><span style="color:#75715e">
</span></span></span></code></pre></div><p>這三個 include，實際上是 include <code>/lib/modules/$(uname -r)/build/include/</code> 中的檔案
<img alt="157.png" loading="lazy" src="/linux-kernel-programming/ch04/157.png"></p>
<ul>
<li>
<p>實際上也就是這三個檔案
<img alt="157-2.png" loading="lazy" src="/linux-kernel-programming/ch04/157-2.png">
<img alt="157-3.png" loading="lazy" src="/linux-kernel-programming/ch04/157-3.png"></p>
</li>
<li>
<p>include <code>/lib/modules/5.4.1-llkd01/build/include</code> 這裡的檔案</p>
</li>
<li>
<p>也是 <code>/home/user/kernels/linux-5.4/include</code> 的意思</p>
</li>
</ul>
<h3 id="module-macros">Module macros<a hidden class="anchor" aria-hidden="true" href="#module-macros">#</a></h3>
<p>這四個 macro 也都蠻直觀的</p>
<ul>
<li><code>MODULE_AUTHOR()</code></li>
<li><code>MODULE_DESCRIPTION()</code></li>
<li><code>MODULE_LICENSE()</code></li>
<li><code>MODULE_VERSION()</code></li>
</ul>
<h3 id="entry-and-exit-points">Entry and exit points<a hidden class="anchor" aria-hidden="true" href="#entry-and-exit-points">#</a></h3>
<ul>
<li>並不像是寫 application 時會使用 <code>main()</code>，module 則是使用這兩個 macro 來指定 entry and exit points</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">module_init</span>(helloworld_lkm_init);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">module_exit</span>(helloworld_lkm_exit);
</span></span></code></pre></div><p>可以想成有點像是 C++ 中的 constructor/destructor</p>
<h3 id="return-values">Return values<a hidden class="anchor" aria-hidden="true" href="#return-values">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> __init <span style="color:#f92672">&lt;</span>modulename<span style="color:#f92672">&gt;</span><span style="color:#a6e22e">_init</span>(<span style="color:#66d9ef">void</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> __exit <span style="color:#f92672">&lt;</span>modulename<span style="color:#f92672">&gt;</span><span style="color:#a6e22e">_exit</span>(<span style="color:#66d9ef">void</span>);
</span></span></code></pre></div><p>注意這裡的 <code>__init()</code> 跟 <code>__exit()</code> 長成這個樣子，在技術上來說並不是必須的，不過這是一個好的 naming practice</p>
<h4 id="the-0-e-return-conventio">The 0/-E return conventio<a hidden class="anchor" aria-hidden="true" href="#the-0-e-return-conventio">#</a></h4>
<ul>
<li>如果成功，回傳 0</li>
<li>失敗則回傳 <code>errno</code></li>
<li><code>include/uapi/asm-generic/errno-base.h</code> 與 <code>include/uapi/asm-generic/errno.h</code> 定義了一些 <code>errono</code></li>
</ul>
<p>例如可能像是下面這種使用方式，像是 <code>ENOMEM</code> 就定義在 <code>include/uapi/asm-generic/errno.h</code> 中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>[...]
</span></span><span style="display:flex;"><span>ptr <span style="color:#f92672">=</span> <span style="color:#a6e22e">kmalloc</span>(<span style="color:#ae81ff">87</span>, GFP_KERNEL);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ptr) {
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pr_warning</span>(<span style="color:#e6db74">&#34;%s:%s:%d: kmalloc failed!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, __FILE__, __func__,
</span></span><span style="display:flex;"><span>__LINE__);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>[...]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">/* success */</span>
</span></span></code></pre></div><ul>
<li>如果 <code>CONFIG_MODULE_FORCE_UNLOAD</code> 設為 disable，則 <code>module_exit()</code> 有可能可以放入一些無法 unload 的程式碼（當然這是不理想的情況）</li>
</ul>
<h4 id="the-err_ptr-and-ptr_err-macros">The <code>ERR_PTR</code> and <code>PTR_ERR</code> macros<a hidden class="anchor" aria-hidden="true" href="#the-err_ptr-and-ptr_err-macros">#</a></h4>
<p>這裡主要要解決的問題是如果我希望這個 function 要回傳像是 address，這樣可能會把 address 誤認為錯誤碼，所以需要一些macro 來處理及判斷。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> mystruct <span style="color:#f92672">*</span> <span style="color:#a6e22e">myfunc</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> mystruct <span style="color:#f92672">*</span>mys <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 嘗試分配記憶體
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mys <span style="color:#f92672">=</span> <span style="color:#a6e22e">kzalloc</span>(<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> mystruct), GFP_KERNEL);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 檢查記憶體分配是否失敗
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>mys)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 失敗時，返回一個偽裝成指標的錯誤碼：-ENOMEM
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ERR_PTR</span>(<span style="color:#f92672">-</span>ENOMEM); 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    [...]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 成功時，返回實際的結構體指標
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> mys;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>[...]
</span></span><span style="display:flex;"><span>gmys <span style="color:#f92672">=</span> <span style="color:#a6e22e">myfunc</span>(); <span style="color:#75715e">// 接收返回值，它可能是指標或錯誤碼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 檢查返回的「指標」是否是一個錯誤碼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">IS_ERR</span>(gmys)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pr_warn</span>(<span style="color:#e6db74">&#34;%s: myfunc alloc failed, aborting...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, OURMODNAME);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 將偽裝的錯誤碼指標還原為原始的整數錯誤碼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    stat <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTR_ERR</span>(gmys); <span style="color:#75715e">/* sets &#39;stat&#39; to the value -ENOMEM */</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> out_fail_1;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 程式碼繼續執行 (如果 gmys 是有效指標)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>[...]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> stat;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>out_fail_1:
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> stat;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="the-__init-and-__exit-keywords">The <code>__init</code> and <code>__exit</code> keywords<a hidden class="anchor" aria-hidden="true" href="#the-__init-and-__exit-keywords">#</a></h4>
<ul>
<li><code>__init</code>: 代表這個 function 只會使用一次，使用之後就可以利用 <code>free_initmem()</code> 刪除掉</li>
<li><code>__exit</code>: 在這個 function 結束之後，all the memory is freed</li>
</ul>
<h1 id="common-operations-on-kernel-modules">Common operations on kernel modules<a hidden class="anchor" aria-hidden="true" href="#common-operations-on-kernel-modules">#</a></h1>
<p>這裡要開始說明如何 build, load, unload kernel modules</p>
<h2 id="building-the-kernel-module">Building the kernel module<a hidden class="anchor" aria-hidden="true" href="#building-the-kernel-module">#</a></h2>
<ul>
<li>先 clone 這個 repo <a href="https://github.com/PacktPublishing/Linux-Kernel-Programming">https://github.com/PacktPublishing/Linux-Kernel-Programming</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cd ~/Linux-Kernel-Programming/ch4/helloworld_lkm
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>make
</span></span></code></pre></div><p><img alt="164.png" loading="lazy" src="/linux-kernel-programming/ch04/164.png"></p>
<p>出現了一個 <code>helloworld_lkm.ko</code></p>
<h2 id="running-the-kernel-module">Running the kernel module<a hidden class="anchor" aria-hidden="true" href="#running-the-kernel-module">#</a></h2>
<p>為了要啟用這個 kernle module, 我們需要把 <code>helloworld_lkm.ko</code> 載入到記憶體，有數種方式，像是 <code>init_module</code> system call，或是這本書使用的工具 <code>insmod</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo insmod ./helloworld_lkm.ko
</span></span></code></pre></div><p><img loading="lazy" src="/linux-kernel-programming/ch04/165.png"></p>
<p>現在成功載入這個 module 了</p>
<p>可能會讓 <code>init_module</code> 失敗的原因有幾個：</p>
<ul>
<li>權限不足</li>
<li><code>/proc/sys/kernel/modules_disabled</code>, is set to 1 (it defaults to 0).</li>
<li>撞到相同的名子</li>
</ul>
<h2 id="a-quick-first-look-at-the-kernel-printk">A quick first look at the kernel <code>printk()</code><a hidden class="anchor" aria-hidden="true" href="#a-quick-first-look-at-the-kernel-printk">#</a></h2>
<p>跟 <code>printf()</code> 的用法很像，但是 <code>printf()</code> 會直接 print 到螢幕上，<code>printk()</code> 可能輸出到</p>
<ul>
<li>A kernel log buffer in RAM (volatile)</li>
<li>A log file, the kernel log file (non-volatile)</li>
<li>The console device</li>
</ul>
<p>使用 <code>dmesg</code> 可以看到 <code>printk()</code> 印出的東西
<img loading="lazy" src="/linux-kernel-programming/ch04/167.png"></p>
<h2 id="listing-the-live-kernel-modules">Listing the live kernel modules<a hidden class="anchor" aria-hidden="true" href="#listing-the-live-kernel-modules">#</a></h2>
<p>現在我們的 <code>helloworld_lkm.ko</code> 在輸出訊息之後，就不做任何事情了，它現在就單純的存在於 kernel memory and do nothing</p>
<p>使用 <code>lsmod</code> 可以看到現在還存在哪些 module
<img loading="lazy" src="/linux-kernel-programming/ch04/169.png"></p>
<h2 id="unloading-the-module-from-kernel-memory">Unloading the module from kernel memory<a hidden class="anchor" aria-hidden="true" href="#unloading-the-module-from-kernel-memory">#</a></h2>
<p>使用 <code>rmmod</code> 可以移除 module</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo rmmod helloworld_lkm
</span></span></code></pre></div><p><img loading="lazy" src="/linux-kernel-programming/ch04/170.png">
<code>rmmod</code> 失敗的情境如下</p>
<ul>
<li>Permissions</li>
<li>如果要刪除的 module 是其他 module 的 dependency</li>
<li>沒有 destructor <code>module_exit()</code> and <code>CONFIG_MODULE_FORCE_UNLOAD</code> is disable</li>
</ul>
<h2 id="our-lkm-convenience-script">Our lkm convenience script<a hidden class="anchor" aria-hidden="true" href="#our-lkm-convenience-script">#</a></h2>
<p><img loading="lazy" src="/linux-kernel-programming/ch04/172.png">
可以使用 <code>lkm</code> 這個腳本做 insert, 記得要用 <code>rmmod</code> 把 module 刪掉</p>
<h1 id="understanding-kernel-logging-and-printk">Understanding kernel logging and printk<a hidden class="anchor" aria-hidden="true" href="#understanding-kernel-logging-and-printk">#</a></h1>
<p>再複習一次 <code>printk()</code> 可能輸出的地方有：</p>
<ul>
<li>A kernel log buffer (in RAM; volatile)</li>
<li>A kernel log file (non-volatile)</li>
<li>The console device</li>
</ul>
<h2 id="using-the-kernel-memory-ring-buffer">Using the kernel memory ring buffer<a hidden class="anchor" aria-hidden="true" href="#using-the-kernel-memory-ring-buffer">#</a></h2>
<ul>
<li>存放於 kernel address space，也就是在 RAM 中，所以例如電腦突然關機，我們就會失去可以用來 debug 的資料</li>
<li>log buffer 大約只有 256 KB，並且是一個 ring buffer 所以有可能舊的資料會被洗掉</li>
</ul>
<h2 id="kernel-logging-and-systemds-journalctl">Kernel logging and systemd&rsquo;s journalctl<a hidden class="anchor" aria-hidden="true" href="#kernel-logging-and-systemds-journalctl">#</a></h2>
<p>為了解決 ring buffer 的問題，我們可以把資料寫到一個 file 中</p>
<ul>
<li>Red-Hat based: <code>/var/log/messages</code></li>
<li>Debian based: <code>/var/log/syslog</code></li>
<li>較舊的版本可使用 system logger daemon (<code>syslogd</code>)</li>
<li>比較新的版本使用 <code>systemd</code> 並且在 <code>systemd</code> 的框架下，使搭配 <code>systemd-journal</code>, <code>journalctl</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>journalctl -k | tail -n2
</span></span></code></pre></div><p><img loading="lazy" src="/linux-kernel-programming/ch04/177.png"></p>
<h2 id="using-printk-log-levels">Using printk log levels<a hidden class="anchor" aria-hidden="true" href="#using-printk-log-levels">#</a></h2>
<p>在 <code>helloworld_lkm</code> 的例子中，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>printk<span style="color:#f92672">(</span>KERN_INFO <span style="color:#e6db74">&#34;Hello, world\n&#34;</span><span style="color:#f92672">)</span>;
</span></span></code></pre></div><p>這裡的 <code>KERN_INFO</code> 表示了 log level，但是要注意這並不是一個 parameter，他並沒有用逗號隔開
在 <code>include/linux/kern_levels.h</code> 中可以看到這些 log level 的定義</p>
<p><img loading="lazy" src="/linux-kernel-programming/ch04/178.png">
要注意這裡的 log level 並不是 priority 的概念，而是單純的作為一種 filtering 的功能</p>
<ul>
<li>以 <code>hangcheck-timer</code> 作為例子</li>
<li><code>hangcheck-timer</code> 可以當成 watch dog 的功能</li>
<li>在 <code>drivers/char/hangcheck-timer.c</code>: 像是這裡，使用了 <code>KERN_CRIT</code> 的 log level
<img loading="lazy" src="/linux-kernel-programming/ch04/179.png"></li>
<li><code>printk</code> 的 default level 是 4 也就是 <code>KERN_WARNING</code></li>
</ul>
<h3 id="the-pr_foo-convenience-macros">The <code>pr_&lt;foo&gt;</code> convenience macros<a hidden class="anchor" aria-hidden="true" href="#the-pr_foo-convenience-macros">#</a></h3>
<p>如果每次都要用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">printk</span>(KERN_INFO <span style="color:#e6db74">&#34;Hello, world</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span></code></pre></div><p>會很麻煩，所以使用這時候就可以用 <code>pr_info()</code> 這個 macro, 同理這個系列有</p>
<ul>
<li><code>include/linux/printk.h</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#ifndef pr_fmt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_fmt(fmt) fmt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * These can be used to print at the various log levels.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * All of these will print unconditionally, although note that pr_debug()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * and other debug macros are compiled out unless either DEBUG is defined
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * or CONFIG_DYNAMIC_DEBUG is set.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_emerg(fmt, ...) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    printk(KERN_EMERG pr_fmt(fmt), ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_alert(fmt, ...) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    printk(KERN_ALERT pr_fmt(fmt), ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_crit(fmt, ...) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    printk(KERN_CRIT pr_fmt(fmt), ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_err(fmt, ...) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    printk(KERN_ERR pr_fmt(fmt), ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_warning(fmt, ...) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    printk(KERN_WARNING pr_fmt(fmt), ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_warn pr_warning
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_notice(fmt, ...) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    printk(KERN_NOTICE pr_fmt(fmt), ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_info(fmt, ...) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    printk(KERN_INFO pr_fmt(fmt), ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Like KERN_CONT, pr_cont() should only be used when continuing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * a line with no newline (&#39;\n&#39;) enclosed. Otherwise it defaults
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * back to KERN_DEFAULT.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_cont(fmt, ...) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    printk(KERN_CONT fmt, ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* pr_devel() should produce zero code unless DEBUG is defined */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef DEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_devel(fmt, ...) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    printk(KERN_DEBUG pr_fmt(fmt), ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define pr_devel(fmt, ...) \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    no_printk(KERN_DEBUG pr_fmt(fmt), ##__VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><p>可以做使用</p>
<h3 id="wiring-to-the-console">Wiring to the console<a hidden class="anchor" aria-hidden="true" href="#wiring-to-the-console">#</a></h3>
<p>再再次的回想一下，<code>printk()</code> 可以 output 的範圍有：</p>
<ul>
<li>The first being the kernel memory log buffer (always)</li>
<li>The second being non-volatile log files</li>
<li>The last one (that we&rsquo;ll address here): the console device</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">(</span>base<span style="color:#f92672">)</span> turtlegod@thinkpad:~$ cat /proc/sys/kernel/printk
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span>       <span style="color:#ae81ff">4</span>       <span style="color:#ae81ff">1</span>       <span style="color:#ae81ff">7</span>
</span></span></code></pre></div><p>這四個數字分別代表</p>
<ul>
<li>The current (console) log level
<ul>
<li>The implication being that all messages less than this value will appear on</li>
</ul>
</li>
<li>the console device!</li>
<li>The default level for messages that lack an explicit log level</li>
<li>The minimum allowed log level</li>
<li>The boot-time default log level</li>
</ul>
<ul>
<li>all printk instances lower than log level 4 will appear on the console device</li>
</ul>
<h3 id="writing-output-to-the-raspberry-pi-console">Writing output to the Raspberry Pi console<a hidden class="anchor" aria-hidden="true" href="#writing-output-to-the-raspberry-pi-console">#</a></h3>
<p>這裡需要一條 USB to TTL 的線才可以繼續做實驗</p>
<h3 id="enabling-the-pr_debug-kernel-messages">Enabling the <code>pr_debug()</code> kernel messages<a hidden class="anchor" aria-hidden="true" href="#enabling-the-pr_debug-kernel-messages">#</a></h3>
<h2 id="rate-limiting-the-printk-instances">Rate limiting the printk instances<a hidden class="anchor" aria-hidden="true" href="#rate-limiting-the-printk-instances">#</a></h2>
<h2 id="generating-kernel-messages-from-the-user-space">Generating kernel messages from the user space<a hidden class="anchor" aria-hidden="true" href="#generating-kernel-messages-from-the-user-space">#</a></h2>
<h2 id="standardizing-printk-output-via-the-pr_fmt-macro">Standardizing printk output via the <code>pr_fmt</code> macro<a hidden class="anchor" aria-hidden="true" href="#standardizing-printk-output-via-the-pr_fmt-macro">#</a></h2>
<h2 id="portability-and-the-printk-format-specifiers">Portability and the printk format specifiers<a hidden class="anchor" aria-hidden="true" href="#portability-and-the-printk-format-specifiers">#</a></h2>
<h1 id="understanding-the-basics-of-a-kernel-module-makefile">Understanding the basics of a kernel module Makefile<a hidden class="anchor" aria-hidden="true" href="#understanding-the-basics-of-a-kernel-module-makefile">#</a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-make" data-lang="make"><span style="display:flex;"><span><span style="color:#75715e"># ch4/printk_loglvl/Makefile
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>PWD          <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>shell pwd<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>obj-m        <span style="color:#f92672">+=</span> printk_loglvl.o
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enable the pr_debug() and pr_devel() as well by removing the comment from
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># one of the lines below
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#EXTRA_CFLAGS += -DDEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#CFLAGS_printk_loglvl.o := -DDEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">all</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    make -C /lib/modules/<span style="color:#66d9ef">$(</span>shell uname -r<span style="color:#66d9ef">)</span>/build/ M<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>PWD<span style="color:#66d9ef">)</span> modules
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">install</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    make -C /lib/modules/<span style="color:#66d9ef">$(</span>shell uname -r<span style="color:#66d9ef">)</span>/build/ M<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>PWD<span style="color:#66d9ef">)</span> modules_install
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">clean</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    make -C /lib/modules/<span style="color:#66d9ef">$(</span>shell uname -r<span style="color:#66d9ef">)</span>/build/ M<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>PWD<span style="color:#66d9ef">)</span> clean
</span></span></code></pre></div><p>可以注意到這裡並沒有使用 <code>gcc</code> 而是在這裡面用了 <code>make</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Makefile" data-lang="Makefile"><span style="display:flex;"><span><span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> [dependent-source-file(s)]
</span></span><span style="display:flex;"><span>    rule<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Yama&#39;s Trail</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

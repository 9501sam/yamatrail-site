<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>[xv6 學習紀錄 05] Lab: xv6 lazy page allocation | Yama&#39;s Trail</title>
<meta name="keywords" content="">
<meta name="description" content="
Lab 連結: Lab: xv6 lazy page allocation

Eliminate allocation from sbrk() (easy)

Your first task is to delete page allocation from the sbrk(n) system call implementation, which is the function sys_sbrk() in sysproc.c. The sbrk(n) system call grows the process&rsquo;s memory size by n bytes, and then returns the start of the newly allocated region (i.e., the old size). Your new sbrk(n) should just increment the process&rsquo;s size (myproc()-&gt;sz) by n and return the old size. It should not allocate memory &ndash; so you should delete the call to growproc() (but you still need to increase the process&rsquo;s size!).">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/xv6/lab5/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e1f5c4cae44599655f7ff95195ff89c8cb3adbda94f2b1581a434ab2b4d4e6cf.css" integrity="sha256-4fXEyuRFmWVff/lRlf&#43;JyMs629qU8rFYGkNKsrTU5s8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon_io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon_io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon_io/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon_io/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/xv6/lab5/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Yama&#39;s Trail (Alt + H)">Yama&#39;s Trail</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/dev-log/" title="這個網站的誕生">
                    <span>這個網站的誕生</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/leetcode/" title="LeetCode 解題">
                    <span>LeetCode 解題</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xv6/" title="xv6 學習紀錄">
                    <span>xv6 學習紀錄</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      [xv6 學習紀錄 05] Lab: xv6 lazy page allocation
    </h1>
    <div class="post-meta"><span title='2025-10-11 11:28:40 +0800 CST'>October 11, 2025</span>

</div>
  </header> 
  <div class="post-content"><ul>
<li>Lab 連結: <a href="https://pdos.csail.mit.edu/6.S081/2020/labs/lazy.html">Lab: xv6 lazy page allocation</a></li>
</ul>
<h2 id="eliminate-allocation-from-sbrk-easy">Eliminate allocation from sbrk() (easy)<a hidden class="anchor" aria-hidden="true" href="#eliminate-allocation-from-sbrk-easy">#</a></h2>
<blockquote>
<p>Your first task is to delete page allocation from the <code>sbrk(n)</code> system call implementation, which is the function <code>sys_sbrk()</code> in <code>sysproc.c</code>. The <code>sbrk(n)</code> system call grows the process&rsquo;s memory size by <code>n</code> bytes, and then returns the start of the newly allocated region (i.e., the old size). Your new <code>sbrk(n)</code> should just increment the process&rsquo;s size (<code>myproc()-&gt;sz</code>) by <code>n</code> and return the old size. It should not allocate memory &ndash; so you should delete the call to <code>growproc()</code> (but you still need to increase the process&rsquo;s size!).</p></blockquote>
<ul>
<li>origin <code>sys_sbrk()</code>:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_sbrk</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> addr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>n) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>()<span style="color:#f92672">-&gt;</span>sz;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">growproc</span>(n) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> addr;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>題目要我們改成這樣：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_sbrk</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 addr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>n);
</span></span><span style="display:flex;"><span>  addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>()<span style="color:#f92672">-&gt;</span>sz;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// if(growproc(n) &lt; 0)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//   return -1;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">myproc</span>()<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">+=</span> n;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> addr;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接著執行 <code>echo hi</code> 的結果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>xv6 kernel is booting
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>hart <span style="color:#ae81ff">2</span> starting
</span></span><span style="display:flex;"><span>hart <span style="color:#ae81ff">1</span> starting
</span></span><span style="display:flex;"><span>init: starting sh
</span></span><span style="display:flex;"><span>$ echo hi
</span></span><span style="display:flex;"><span>usertrap<span style="color:#f92672">()</span>: unexpected scause 0x000000000000000f pid<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>            sepc<span style="color:#f92672">=</span>0x00000000000012c4 stval<span style="color:#f92672">=</span>0x0000000000005008
</span></span><span style="display:flex;"><span>panic: uvmunmap: not mapped
</span></span></code></pre></div><h3 id="錯誤訊息解釋">錯誤訊息解釋<a hidden class="anchor" aria-hidden="true" href="#錯誤訊息解釋">#</a></h3>
<ul>
<li><code>usertrap()</code>:
<ul>
<li>這些錯誤訊息是從 <code>kernel/trap.c: usertrap()</code> 產生出來的</li>
</ul>
</li>
<li><code>unexpected scause 0x000000000000000f</code>:
<ul>
<li>register <code>scause</code> = 0x0f，是 page fault (TODO: 貼上來源)</li>
</ul>
</li>
<li><code>pid = 3</code> 是 <code>sh</code> 的 pid
<ul>
<li>在後面用 gdb 分析會知道這是 <code>sh</code></li>
</ul>
</li>
<li><code>sepc=0x00000000000012c4</code>:
<ul>
<li>對應到 <code>sh.asm</code> 中的 <code>12ac: ld	ra,56(sp)</code></li>
</ul>
</li>
<li><code>stval=0x0000000000004008</code>:
<ul>
<li>造成 page trap 的 virtual memory</li>
</ul>
</li>
</ul>
<h3 id="使用-gdb-解析">使用 <code>gdb</code> 解析<a hidden class="anchor" aria-hidden="true" href="#使用-gdb-解析">#</a></h3>
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">(gdb) b kernel/trap.c:70
(gdb) c
</code></pre><ul>
<li><code>scause</code></li>
<li><code>sepc</code></li>
<li><code>stval</code></li>
<li><code>struct proc p</code></li>
</ul>
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">(gdb) p *p
</code></pre><ul>
<li><code>malloc()</code></li>
</ul>
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">(gdb) add-symbol-file user/_sh
</code></pre><p><code>sh.c</code> 透過 <code>user/user.h</code> 引入 <code>user/umalloc.c</code> 的 <code>malloc.c</code></p>
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">(gdb) b user/umalloc.c:malloc
</code></pre><p>問題發生在 sh -&gt; malloc() -&gt; morecore()</p>
<p>(TODO: more detailed, 說明跟 sbrk() 的關係為何)</p>
<h2 id="lazy-allocation-moderate">Lazy allocation (moderate)<a hidden class="anchor" aria-hidden="true" href="#lazy-allocation-moderate">#</a></h2>
<blockquote>
<p>Modify the code in <code>trap.c</code> to respond to a page fault from user space by mapping a newly-allocated page of physical memory at the faulting address, and then returning back to user space to let the process continue executing. You should add your code just before the <code>printf</code> call that produced the &ldquo;<code>usertrap(): ...</code>&rdquo; message. Modify whatever other xv6 kernel code you need to in order to get <code>echo hi</code> to work.</p></blockquote>
<p>當 page fault 發生時：</p>
<ol>
<li>確認情形是正常的</li>
<li>allocate 一個新的 page 並且做 mapping</li>
<li>處理完 page fault 之後要回到原本的 user process 繼續執行</li>
<li>把程式碼加在這裡
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;usertrap(): unexpected scause %p pid=%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">r_scause</span>(), p<span style="color:#f92672">-&gt;</span>pid);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;            sepc=%p stval=%p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">r_sepc</span>(), <span style="color:#a6e22e">r_stval</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setkilled</span>(p);
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div></li>
</ol>
<p>處理完之後，<code>echo hi</code> 應該要可以正常執行</p>
<p>這裡我要先用 gdb debug 時，發現沒辦法設定到想要的地方，先把 <code>CFLAGS</code> 中的 <code>-O</code> 移除</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>make CFLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-Wall -Werror -fno-omit-frame-pointer -ggdb -gdwarf-2 -DSOL_TRAPS -DLAB_TRAPS -MD -mcmodel=medany -ffreestanding -fno-common -nostdlib -mno-relax -I. -fno-stack-protector -fno-pie -no-pie&#34;</span> qemu-gdb
</span></span></code></pre></div><p>(注意要先 <code>make clean</code> 之後才會有效果)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> p *myproc<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>$2 <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>lock <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>locked <span style="color:#f92672">=</span> 0, name <span style="color:#f92672">=</span> 0x8000b170 <span style="color:#e6db74">&#34;proc&#34;</span>, cpu <span style="color:#f92672">=</span> 0x0<span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  state <span style="color:#f92672">=</span> RUNNING, chan <span style="color:#f92672">=</span> 0x0, killed <span style="color:#f92672">=</span> 0, xstate <span style="color:#f92672">=</span> 0, pid <span style="color:#f92672">=</span> 3,
</span></span><span style="display:flex;"><span>  parent <span style="color:#f92672">=</span> 0x8000bea0 &lt;proc+360&gt;, kstack <span style="color:#f92672">=</span> 274877878272,
</span></span><span style="display:flex;"><span>  sz <span style="color:#f92672">=</span> 86016, pagetable <span style="color:#f92672">=</span> 0x87f73000, trapframe <span style="color:#f92672">=</span> 0x87f60000,
</span></span><span style="display:flex;"><span>  context <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>ra <span style="color:#f92672">=</span> 2147492142, sp <span style="color:#f92672">=</span> 274877882368, s0 <span style="color:#f92672">=</span> 0,
</span></span><span style="display:flex;"><span>    s1 <span style="color:#f92672">=</span> 0, s2 <span style="color:#f92672">=</span> 0, s3 <span style="color:#f92672">=</span> 0, s4 <span style="color:#f92672">=</span> 0, s5 <span style="color:#f92672">=</span> 0, s6 <span style="color:#f92672">=</span> 0, s7 <span style="color:#f92672">=</span> 0,
</span></span><span style="display:flex;"><span>    s8 <span style="color:#f92672">=</span> 0, s9 <span style="color:#f92672">=</span> 0, s10 <span style="color:#f92672">=</span> 0, s11 <span style="color:#f92672">=</span> 0<span style="color:#f92672">}</span>, ofile <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    0x8001ba68 &lt;ftable+24&gt;, 0x8001ba68 &lt;ftable+24&gt;,
</span></span><span style="display:flex;"><span>    0x8001ba68 &lt;ftable+24&gt;, 0x0 &lt;repeats <span style="color:#ae81ff">13</span> times&gt;<span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>  cwd <span style="color:#f92672">=</span> 0x80019e78 &lt;itable+24&gt;,
</span></span><span style="display:flex;"><span>  name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#e6db74">&#39;\000&#39;</span> &lt;repeats <span style="color:#ae81ff">13</span> times&gt;<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> p/x myproc<span style="color:#f92672">()</span>-&gt;sz
</span></span><span style="display:flex;"><span>$3 <span style="color:#f92672">=</span> 0x15000
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> p/x $stval
</span></span><span style="display:flex;"><span>$4 <span style="color:#f92672">=</span> 0x5008
</span></span></code></pre></div><p><img alt="vmprint.png" loading="lazy" src="/xv6/lab5/vmprint.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>page table 0x0000000087f73000
</span></span><span style="display:flex;"><span> ..0: pte 0x0000000021fdc001 pa 0x0000000087f70000
</span></span><span style="display:flex;"><span> .. ..0: pte 0x0000000021fd8401 pa 0x0000000087f61000
</span></span><span style="display:flex;"><span> .. .. ..0: pte 0x0000000021fdb85b pa 0x0000000087f6e000
</span></span><span style="display:flex;"><span> .. .. ..1: pte 0x0000000021fd885b pa 0x0000000087f62000
</span></span><span style="display:flex;"><span> .. .. ..2: pte 0x0000000021fd8cd7 pa 0x0000000087f63000
</span></span><span style="display:flex;"><span> .. .. ..3: pte 0x0000000021fdbc07 pa 0x0000000087f6f000
</span></span><span style="display:flex;"><span> .. .. ..4: pte 0x0000000021fd54d7 pa 0x0000000087f55000
</span></span><span style="display:flex;"><span> ..255: pte 0x0000000021fdc801 pa 0x0000000087f72000
</span></span><span style="display:flex;"><span> .. ..511: pte 0x0000000021fdc401 pa 0x0000000087f71000
</span></span><span style="display:flex;"><span> .. .. ..510: pte 0x0000000021fd80c7 pa 0x0000000087f60000 <span style="color:#75715e"># trapframe</span>
</span></span><span style="display:flex;"><span> .. .. ..511: pte 0x000000002000284b pa 0x000000008000a000 <span style="color:#75715e"># trampoline</span>
</span></span></code></pre></div><ol>
<li><code>myproc()-&gt;sz</code>: <code>0x15000</code></li>
<li><code>stval</code>: <code>0x5008</code></li>
<li>實際 pagetable 的內容，總共只有 5 個 page (不算 trampoline and trapframe)
<ul>
<li>實際 size 為 5 * <code>PGSIZE</code> = <code>0x5000</code> (所以想 access va <code>0x5008</code> 時會 page fault)</li>
</ul>
</li>
</ol>
<p>解決方法：</p>
<ul>
<li>
<p><code>sys_sbrk()</code></p>
<ul>
<li><code>growproc()</code>
<ul>
<li><code>uvmalloc()</code>
原本的呼叫如上，最終使用 <code>uvmalloc()</code>，因此學習 <code>uvmalloc()</code> 的作法，理論上可以讓 <code>echo hi</code> 正常執行</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>kernel/vm.c</code>:</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Allocate PTEs and physical memory to grow process from oldsz to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// newsz, which need not be page aligned.  Returns new size or 0 on error.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmalloc</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 oldsz, uint64 newsz, <span style="color:#66d9ef">int</span> xperm)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mem;
</span></span><span style="display:flex;"><span>  uint64 a;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(newsz <span style="color:#f92672">&lt;</span> oldsz)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> oldsz;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  oldsz <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDUP</span>(oldsz);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(a <span style="color:#f92672">=</span> oldsz; a <span style="color:#f92672">&lt;</span> newsz; a <span style="color:#f92672">+=</span> PGSIZE){
</span></span><span style="display:flex;"><span>    mem <span style="color:#f92672">=</span> <span style="color:#a6e22e">kalloc</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(mem <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">uvmdealloc</span>(pagetable, a, oldsz);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(mem, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(pagetable, a, PGSIZE, (uint64)mem, PTE_R<span style="color:#f92672">|</span>PTE_U<span style="color:#f92672">|</span>xperm) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">kfree</span>(mem);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">uvmdealloc</span>(pagetable, a, oldsz);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> newsz;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>原先版本中的 <code>uvmalloc()</code> 是多 alloc 了多個 page，現在在這裡的版本只需要多 alloc 現在這個 va (<code>$stval</code>) 這一個 page 就好，之後如果又有沒有 allocate 的 page，就一樣會來到 page fault 的這裡，然後一樣專注於一個 page 的處理</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">usertrap</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>((which_dev <span style="color:#f92672">=</span> <span style="color:#a6e22e">devintr</span>()) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ok
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>(<span style="color:#a6e22e">r_scause</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">13</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">r_scause</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">15</span>){
</span></span><span style="display:flex;"><span>    uint64 va <span style="color:#f92672">=</span> <span style="color:#a6e22e">r_stval</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lazy_alloc</span>(va);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;usertrap(): unexpected scause %p pid=%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">r_scause</span>(), p<span style="color:#f92672">-&gt;</span>pid);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;            sepc=%p stval=%p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">r_sepc</span>(), <span style="color:#a6e22e">r_stval</span>());
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">-&gt;</span>killed <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Returns 0 on success, -1 if not
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lazy_alloc</span>(uint64 va)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mem;
</span></span><span style="display:flex;"><span>  uint64 a;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  a <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(va);
</span></span><span style="display:flex;"><span>  mem <span style="color:#f92672">=</span> <span style="color:#a6e22e">kalloc</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(mem, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(<span style="color:#a6e22e">myproc</span>()<span style="color:#f92672">-&gt;</span>pagetable, a, PGSIZE, (uint64)mem, PTE_R<span style="color:#f92672">|</span>PTE_U<span style="color:#f92672">|</span>PTE_W) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>(mem);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmunmap</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, uint64 npages, <span style="color:#66d9ef">int</span> do_free)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 a;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>((va <span style="color:#f92672">%</span> PGSIZE) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmunmap: not aligned&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(a <span style="color:#f92672">=</span> va; a <span style="color:#f92672">&lt;</span> va <span style="color:#f92672">+</span> npages<span style="color:#f92672">*</span>PGSIZE; a <span style="color:#f92672">+=</span> PGSIZE){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(pagetable, a, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// panic(&#34;uvmunmap: walk&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// panic(&#34;uvmunmap: not mapped&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">PTE_FLAGS</span>(<span style="color:#f92672">*</span>pte) <span style="color:#f92672">==</span> PTE_V)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmunmap: not a leaf&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(do_free){
</span></span><span style="display:flex;"><span>      uint64 pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)pa);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在 lazy allocation 的設計底下，<code>PTE_V == 0</code> 本來就是正常的
<img alt="lazy-allocation.png" loading="lazy" src="/xv6/lab5/lazy-allocation.png"></p>
<h2 id="lazytests-and-usertests-moderate">Lazytests and Usertests (moderate)<a hidden class="anchor" aria-hidden="true" href="#lazytests-and-usertests-moderate">#</a></h2>
<blockquote>
<p>We&rsquo;ve supplied you with <code>lazytests</code>, an xv6 user program that tests some specific situations that may stress your lazy memory allocator. Modify your kernel code so that all of both <code>lazytests</code> and <code>usertests</code> pass.</p>
<ul>
<li>Handle negative <code>sbrk()</code> arguments.</li>
<li>Kill a process if it page-faults on a virtual memory address higher than any allocated with <code>sbrk()</code>.</li>
<li>Handle the parent-to-child memory copy in <code>fork()</code> correctly.</li>
<li>Handle the case in which a process passes a valid address from <code>sbrk()</code> to a system call such as read or write, but the memory for that address has not yet been allocated.</li>
<li>Handle out-of-memory correctly: if <code>kalloc()</code> fails in the page fault handler, kill the current process.</li>
<li>Handle faults on the invalid page below the user stack.</li>
</ul></blockquote>
<p>目前的 lazy test 還有很多破綻，現在來一個一個的解決</p>
<blockquote>
<ul>
<li>Handle negative <code>sbrk()</code> arguments.</li>
</ul></blockquote>
<ul>
<li><code>kernel/sysproc.c: sys_sbrk()</code>: 縮小的時候就還是跟原版的一樣使用 <code>growproc()</code> 去處裡就行了，<code>growproc()</code> 會有幫我們 <code>kfree</code> 不需要的 page 的作用</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_sbrk</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 addr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  addr <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>sz;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>n))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">+</span> n <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">growproc</span>(n) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">myproc</span>()<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">+=</span> n;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> addr;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<ul>
<li>Kill a process if it page-faults on a virtual memory address higher than any allocated with <code>sbrk()</code>.</li>
</ul></blockquote>
<p><code>usertrap()</code> 在處理 page fualt 時，也不是所有 page fault 都符合，lazy allocation 的條件，例如 <code>stval</code> 中的 va 大於 size 的時候，就還是一個確確實實的錯誤情況，在這個情況下，把這個 process kill 掉</p>
<p>以下幾種方情況並不是 lazy allocation 的情形</p>
<ol>
<li><code>va</code> &gt; <code>MAXVA</code></li>
<li>如果一個 page 的 <code>PTE_V</code> == 1 那麼他就一定不是 lazy alloc, 因為它已經被分配了</li>
<li><code>va</code> &gt;= <code>p-&gt;sz</code> 因為並沒有藉由 <code>sbrk()</code> 去新增位置</li>
</ol>
<p>解決方法:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">is_lazy_addr</span>(<span style="color:#66d9ef">int</span> va)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (va <span style="color:#f92672">&gt;</span> MAXVA)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(p<span style="color:#f92672">-&gt;</span>pagetable, va, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (pte <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">PGROUNDDOWN</span>(va) <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(p<span style="color:#f92672">-&gt;</span>sz))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>kernel/trap.c: usertrap()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">usertrap</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>((which_dev <span style="color:#f92672">=</span> <span style="color:#a6e22e">devintr</span>()) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ok
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span>(<span style="color:#a6e22e">r_scause</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">13</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">r_scause</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">15</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>    uint64 va <span style="color:#f92672">=</span> <span style="color:#a6e22e">r_stval</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_lazy_addr</span>(va)) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">lazy_alloc</span>(va) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>killed <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      p<span style="color:#f92672">-&gt;</span>killed <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;usertrap(): unexpected scause %p pid=%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">r_scause</span>(), p<span style="color:#f92672">-&gt;</span>pid);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;            sepc=%p stval=%p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">r_sepc</span>(), <span style="color:#a6e22e">r_stval</span>());
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">-&gt;</span>killed <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><blockquote>
<ul>
<li>Handle the parent-to-child memory copy in <code>fork()</code> correctly.</li>
</ul></blockquote>
<p>主要在講 <code>kernel/proc.c: fork()</code> 中的呼叫的，<code>kernel/vm.c: uvmcopy</code>
原本的 <code>uvmcopy</code> 是 copy 一段連續的 memory, 可是現在使用 lazy alloc 了話，就不一定是連續的</p>
<ul>
<li><code>kernel/proc.c: fork()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fork</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i, pid;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>np;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Allocate process.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>((np <span style="color:#f92672">=</span> <span style="color:#a6e22e">allocproc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Copy user memory from parent to child.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 這裡使用 uvmcopy()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">uvmcopy</span>(p<span style="color:#f92672">-&gt;</span>pagetable, np<span style="color:#f92672">-&gt;</span>pagetable, p<span style="color:#f92672">-&gt;</span>sz) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">freeproc</span>(np);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>np<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  np<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>sz;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// copy saved user registers.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">*</span>(np<span style="color:#f92672">-&gt;</span>trapframe) <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(p<span style="color:#f92672">-&gt;</span>trapframe);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Cause fork to return 0 in the child.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  np<span style="color:#f92672">-&gt;</span>trapframe<span style="color:#f92672">-&gt;</span>a0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// increment reference counts on open file descriptors.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NOFILE; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>ofile[i])
</span></span><span style="display:flex;"><span>      np<span style="color:#f92672">-&gt;</span>ofile[i] <span style="color:#f92672">=</span> <span style="color:#a6e22e">filedup</span>(p<span style="color:#f92672">-&gt;</span>ofile[i]);
</span></span><span style="display:flex;"><span>  np<span style="color:#f92672">-&gt;</span>cwd <span style="color:#f92672">=</span> <span style="color:#a6e22e">idup</span>(p<span style="color:#f92672">-&gt;</span>cwd);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">safestrcpy</span>(np<span style="color:#f92672">-&gt;</span>name, p<span style="color:#f92672">-&gt;</span>name, <span style="color:#66d9ef">sizeof</span>(p<span style="color:#f92672">-&gt;</span>name));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  pid <span style="color:#f92672">=</span> np<span style="color:#f92672">-&gt;</span>pid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>np<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>wait_lock);
</span></span><span style="display:flex;"><span>  np<span style="color:#f92672">-&gt;</span>parent <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>wait_lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>np<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>  np<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> RUNNABLE;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>np<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pid;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>kernel/vm.c: uvmcopy</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmcopy</span>(<span style="color:#66d9ef">pagetable_t</span> old, <span style="color:#66d9ef">pagetable_t</span> new, uint64 sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>  uint64 pa, i;
</span></span><span style="display:flex;"><span>  uint flags;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mem;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> sz; i <span style="color:#f92672">+=</span> PGSIZE){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在 lazy allocation 的設計中，沒有找到對應的 pte 是正常的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(old, i, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// panic(&#34;uvmcopy: pte should exist&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在 lazy allocation 的設計中，PTE_V == 0 是正常的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// panic(&#34;uvmcopy: page not present&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>    flags <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE_FLAGS</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((mem <span style="color:#f92672">=</span> <span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> err;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memmove</span>(mem, (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pa, PGSIZE);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(new, i, PGSIZE, (uint64)mem, flags) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">kfree</span>(mem);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> err;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> err:
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(new, <span style="color:#ae81ff">0</span>, i <span style="color:#f92672">/</span> PGSIZE, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<ul>
<li>Handle the case in which a process passes a valid address from <code>sbrk()</code> to a system call such as read or write, but the memory for that address has not yet been allocated.</li>
</ul></blockquote>
<p>這裡在說的是如果是在 system call 如 <code>read()</code> 或是 <code>write()</code> 的過程中使用 lazy address，會發生問題，因為目前只有處理 user program 所產生的 page fault, 並沒有處理 system call 所產生的 page fault</p>
<p>例如可以像是</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">1024</span>];
</span></span></code></pre></div><p>像是這種時候，<code>buf</code> 有可能是 lazy allocation，在之後如果利用 <code>write</code> 對於 <code>buf</code> 的操作會造成 page fault 但這時候已經進入到 supervisor mode 了，會無法進入到我們目前處理 page fault 的 <code>usertrap()</code></p>
<p>流程:</p>
<ul>
<li>
<p><code>kernel/sysfile.c: sys_write()</code></p>
<ul>
<li><code>kernel/file.c: filewrite()</code>
<ul>
<li><code>kernel/pipe.c: pipewrite()</code>
<ul>
<li><code>kernel/vm.c: copyin()</code>
<ul>
<li><code>kernel/vm.c: walkaddr()</code>
<ul>
<li><code>kernel/vm.c: walk()</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>kernel/vm.c: copyin()</code></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Copy from user to kernel.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Copy len bytes to dst from virtual address srcva in a given page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Return 0 on success, -1 on error.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">copyin</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>dst, uint64 srcva, uint64 len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 n, va0, pa0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>(len <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    va0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(srcva);
</span></span><span style="display:flex;"><span>    pa0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">walkaddr</span>(pagetable, va0); <span style="color:#75715e">// 這個 va0 有可能是一個 lazy address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(pa0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> PGSIZE <span style="color:#f92672">-</span> (srcva <span style="color:#f92672">-</span> va0);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(n <span style="color:#f92672">&gt;</span> len)
</span></span><span style="display:flex;"><span>      n <span style="color:#f92672">=</span> len;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memmove</span>(dst, (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)(pa0 <span style="color:#f92672">+</span> (srcva <span style="color:#f92672">-</span> va0)), n);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    len <span style="color:#f92672">-=</span> n;
</span></span><span style="display:flex;"><span>    dst <span style="color:#f92672">+=</span> n;
</span></span><span style="display:flex;"><span>    srcva <span style="color:#f92672">=</span> va0 <span style="color:#f92672">+</span> PGSIZE;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>kernel/vm.c: walkaddr()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Look up a virtual address, return the physical address,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// or 0 if not mapped.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Can only be used to look up user pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">walkaddr</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>  uint64 pa;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(va <span style="color:#f92672">&gt;=</span> MAXVA)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(pagetable, va, <span style="color:#ae81ff">0</span>); <span style="color:#75715e">// 如果是 lazy address 這裡應該會 walk 不出來
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(pte <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_U) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pa;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>kernel/vm.c: walk()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">walk</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, <span style="color:#66d9ef">int</span> alloc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(va <span style="color:#f92672">&gt;=</span> MAXVA)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;walk&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> level <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; level <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; level<span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pagetable[<span style="color:#a6e22e">PX</span>(level, va)];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) {
</span></span><span style="display:flex;"><span>      pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pagetable_t</span>)<span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 在 lazy address 的情況下，因為還沒有 allocate 所以會進入到這裡來
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// 最終會回傳 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>alloc <span style="color:#f92672">||</span> (pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pde_t</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memset</span>(pagetable, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">PA2PTE</span>(pagetable) <span style="color:#f92672">|</span> PTE_V;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>pagetable[<span style="color:#a6e22e">PX</span>(<span style="color:#ae81ff">0</span>, va)];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>解決方法：在 <code>walkaddr()</code> 遇到一個 lazy address 時，allocate 一個 page</p>
<ul>
<li><code>kernel/vm.c: walkaddr()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">walkaddr</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>  uint64 pa;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(va <span style="color:#f92672">&gt;=</span> MAXVA)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(pagetable, va, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (pte <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> (<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(va <span style="color:#f92672">&gt;=</span> p<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">||</span> va <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">PGROUNDUP</span>(p<span style="color:#f92672">-&gt;</span>trapframe<span style="color:#f92672">-&gt;</span>sp)) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    pa <span style="color:#f92672">=</span> (uint64)<span style="color:#a6e22e">kalloc</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (pa <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mappages</span>(p<span style="color:#f92672">-&gt;</span>pagetable, va, PGSIZE, pa, PTE_W<span style="color:#f92672">|</span>PTE_R<span style="color:#f92672">|</span>PTE_U<span style="color:#f92672">|</span>PTE_X) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)pa);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pa;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_U) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pa;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>(TODO: more detailed)</p>
<blockquote>
<ul>
<li>Handle out-of-memory correctly: if <code>kalloc()</code> fails in the page fault handler, kill the current process.</li>
</ul></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Returns 0 on success, -1 if not
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lazy_alloc</span>(uint64 va)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mem;
</span></span><span style="display:flex;"><span>  uint64 a;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  a <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(va);
</span></span><span style="display:flex;"><span>  mem <span style="color:#f92672">=</span> <span style="color:#a6e22e">kalloc</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (mem <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(mem, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(<span style="color:#a6e22e">myproc</span>()<span style="color:#f92672">-&gt;</span>pagetable, a, PGSIZE, (uint64)mem, PTE_W<span style="color:#f92672">|</span>PTE_R<span style="color:#f92672">|</span>PTE_X<span style="color:#f92672">|</span>PTE_U) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>(mem);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<ul>
<li>Handle faults on the invalid page below the user stack.</li>
</ul></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Returns 0 on success, -1 if not
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lazy_alloc</span>(uint64 va)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mem;
</span></span><span style="display:flex;"><span>  uint64 a;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  a <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(va);
</span></span><span style="display:flex;"><span>  mem <span style="color:#f92672">=</span> <span style="color:#a6e22e">kalloc</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (mem <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(mem, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(<span style="color:#a6e22e">myproc</span>()<span style="color:#f92672">-&gt;</span>pagetable, a, PGSIZE, (uint64)mem, PTE_W<span style="color:#f92672">|</span>PTE_R<span style="color:#f92672">|</span>PTE_X<span style="color:#f92672">|</span>PTE_U) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>(mem);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>(TODO: more detailed)</p>
<p><img alt="ac1.png" loading="lazy" src="/xv6/lab5/ac1.png">
<img alt="ac2.png" loading="lazy" src="/xv6/lab5/ac2.png">
<img alt="ac3.png" loading="lazy" src="/xv6/lab5/ac3.png"></p>
<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<ul>
<li><a href="https://pdos.csail.mit.edu/6.S081/2020/schedule.html">6.S081 2020</a></li>
<li><a href="https://pdos.csail.mit.edu/6.S081/2020/labs/lazy.html">Lab lazy</a></li>
<li><a href="https://pdos.csail.mit.edu/6.S081/2020/xv6/book-riscv-rev1.pdf">xv6 book</a></li>
<li><a href="https://youtu.be/KSYO-gTZo0A">video</a></li>
<li><a href="https://ttzytt.com/2022/07/xv6_lab5_record/">Lazy Page Allocation 实验记录</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/xv6/lab5.1/">
    <span class="title">« Prev</span>
    <br>
    <span>[xv6 學習紀錄 05-1] Page Fault</span>
  </a>
  <a class="next" href="http://localhost:1313/xv6/lab6.1/">
    <span class="title">Next »</span>
    <br>
    <span>[xv6 學習紀錄 06-1] Interrupts</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Yama&#39;s Trail</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

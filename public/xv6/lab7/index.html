<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>[xv6 學習紀錄 07] Lab thread: Multithreading | Yama&#39;s Trail</title>
<meta name="keywords" content="">
<meta name="description" content="Lab 連結：Lab: Multithreading
Uthread: switching between threads (moderate)

In this exercise you will design the context switch mechanism for a user-level threading system, and then implement it. To get you started, your xv6 has two files user/uthread.c and user/uthread_switch.S, and a rule in the Makefile to build a uthread program. uthread.c contains most of a user-level threading package, and code for three simple test threads. The threading package is missing some of the code to create a thread and to switch between threads.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/xv6/lab7/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e1f5c4cae44599655f7ff95195ff89c8cb3adbda94f2b1581a434ab2b4d4e6cf.css" integrity="sha256-4fXEyuRFmWVff/lRlf&#43;JyMs629qU8rFYGkNKsrTU5s8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon_io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon_io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon_io/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon_io/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/xv6/lab7/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Yama&#39;s Trail (Alt + H)">Yama&#39;s Trail</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/dev-log/" title="這個網站的誕生">
                    <span>這個網站的誕生</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/leetcode/" title="LeetCode 解題">
                    <span>LeetCode 解題</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xv6/" title="xv6 學習紀錄">
                    <span>xv6 學習紀錄</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      [xv6 學習紀錄 07] Lab thread: Multithreading
    </h1>
    <div class="post-meta"><span title='2025-10-21 19:35:33 +0800 CST'>October 21, 2025</span>

</div>
  </header> 
  <div class="post-content"><p>Lab 連結：<a href="https://pdos.csail.mit.edu/6.S081/2022/labs/thread.html">Lab: Multithreading</a></p>
<h2 id="uthread-switching-between-threads-moderate">Uthread: switching between threads (moderate)<a hidden class="anchor" aria-hidden="true" href="#uthread-switching-between-threads-moderate">#</a></h2>
<blockquote>
<p>In this exercise you will design the context switch mechanism for a user-level threading system, and then implement it. To get you started, your xv6 has two files <code>user/uthread.c</code> and <code>user/uthread_switch.S</code>, and a rule in the <code>Makefile</code> to build a uthread program. uthread.c contains most of a user-level threading package, and code for three simple test threads. The threading package is missing some of the code to create a thread and to switch between threads.</p></blockquote>
<blockquote>
<p>Your job is to come up with a plan to create threads and save/restore registers to switch between threads, and implement that plan. When you&rsquo;re done, <code>make grade</code> should say that your solution passes the <code>uthread</code> test.</p></blockquote>
<p>這一題要我們做的是在 User Program 的 level 再做出一個多個 thread 的層級</p>
<ul>
<li><code>user/uthread.c</code>: 先來看 data structure</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* Possible states of a thread: */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define FREE        0x0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define RUNNING     0x1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define RUNNABLE    0x2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define STACK_SIZE  8192
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_THREAD  4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">thread</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span>       stack[STACK_SIZE]; <span style="color:#75715e">/* the thread&#39;s stack */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span>        state;             <span style="color:#75715e">/* FREE, RUNNING, RUNNABLE */</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">thread</span> all_thread[MAX_THREAD];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">thread</span> <span style="color:#f92672">*</span>current_thread;
</span></span></code></pre></div><ul>
<li><code>stack</code> 可供我們儲存這個 stack 的相關資訊
<ul>
<li>這裡功能的會是原先 memory layout 中的 stack</li>
<li><img alt="process_layout2.png" loading="lazy" src="/xv6/lab7/process_layout2.png"></li>
</ul>
</li>
<li><code>state</code> 可代表 這個 state 的狀態，跟 <code>proc.h</code> 中的類似</li>
<li>這裡的 <code>thread</code> 就很單純的用一個 fix-sized 的 array 存放</li>
<li><code>current_thread</code> 代表當前所運行的 thread</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">thread_switch</span>(uint64, uint64);
</span></span></code></pre></div><ul>
<li><code>extern</code> 只是宣告，真正的 <code>thread_switch</code> 寫在 <code>user/uthread_switch.S</code> 中</li>
</ul>
<p>接著看 <code>main()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  a_started <span style="color:#f92672">=</span> b_started <span style="color:#f92672">=</span> c_started <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  a_n <span style="color:#f92672">=</span> b_n <span style="color:#f92672">=</span> c_n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">thread_init</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">thread_create</span>(thread_a);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">thread_create</span>(thread_b);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">thread_create</span>(thread_c);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">thread_schedule</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol>
<li><code>thread_init()</code></li>
<li><code>thread_create()</code></li>
<li><code>thread_schedule()</code></li>
</ol>
<ul>
<li>先用 <code>thread_init()</code> 決定第一個運行的 thread</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">thread_init</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// main() is thread 0, which will make the first invocation to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// thread_schedule().  it needs a stack so that the first thread_switch() can
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// save thread 0&#39;s state.  thread_schedule() won&#39;t run the main thread ever
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// again, because its state is set to RUNNING, and thread_schedule() selects
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// a RUNNABLE thread.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  current_thread <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>all_thread[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  current_thread<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> RUNNING;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>thread_create()</code> 可以用一個 pointer to a function 作為參數
<ul>
<li>這部份需要我們自行實做完成</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">thread_create</span>(<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>func)())
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">thread</span> <span style="color:#f92672">*</span>t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (t <span style="color:#f92672">=</span> all_thread; t <span style="color:#f92672">&lt;</span> all_thread <span style="color:#f92672">+</span> MAX_THREAD; t<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (t<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">==</span> FREE) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  t<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> RUNNABLE;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// YOUR CODE HERE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li><code>thread_schedule()</code>: 可以持續的更換不同的 thread 執行</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">thread_schedule</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">thread</span> <span style="color:#f92672">*</span>t, <span style="color:#f92672">*</span>next_thread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* Find another runnable thread. */</span>
</span></span><span style="display:flex;"><span>  next_thread <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  t <span style="color:#f92672">=</span> current_thread <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> MAX_THREAD; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(t <span style="color:#f92672">&gt;=</span> all_thread <span style="color:#f92672">+</span> MAX_THREAD)
</span></span><span style="display:flex;"><span>      t <span style="color:#f92672">=</span> all_thread;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(t<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">==</span> RUNNABLE) {
</span></span><span style="display:flex;"><span>      next_thread <span style="color:#f92672">=</span> t;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> t <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (next_thread <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;thread_schedule: no runnable threads</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (current_thread <span style="color:#f92672">!=</span> next_thread) {         <span style="color:#75715e">/* switch threads?  */</span>
</span></span><span style="display:flex;"><span>    next_thread<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> RUNNING;
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> current_thread;
</span></span><span style="display:flex;"><span>    current_thread <span style="color:#f92672">=</span> next_thread;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* YOUR CODE HERE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Invoke thread_switch to switch from t to next_thread:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * thread_switch(??, ??);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    next_thread <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">thread_create</span>(<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>func)())
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">thread</span> <span style="color:#f92672">*</span>t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (t <span style="color:#f92672">=</span> all_thread; t <span style="color:#f92672">&lt;</span> all_thread <span style="color:#f92672">+</span> MAX_THREAD; t<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (t<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">==</span> FREE) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  t<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> RUNNABLE;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// YOUR CODE HERE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li><code>user/uthread_switch.S</code>: 基本上可以學 <code>swtch.S</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>	<span style="color:#a6e22e">.text</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * save the old thread&#39;s registers,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * restore the new thread&#39;s registers.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">.globl</span> <span style="color:#66d9ef">thread_switch</span>
</span></span><span style="display:flex;"><span>thread_switch:
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* YOUR CODE HERE */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ret</span>    <span style="color:#75715e">/* return to ra */</span>
</span></span></code></pre></div><h3 id="hints">Hints:<a hidden class="anchor" aria-hidden="true" href="#hints">#</a></h3>
<blockquote>
<p><code>thread_switch</code> needs to save/restore only the callee-save registers. Why?</p></blockquote>
<p>應該是不用的，這個問題可以先放到心裡，等等在實做的時候會感受到</p>
<blockquote>
<p>You can see the assembly code for <code>uthread</code> in <code>user/uthread.asm</code>, which may be handy for debugging.</p></blockquote>
<h3 id="什麼構成一個-thread-運行的狀態">什麼構成一個 thread 運行的狀態?<a hidden class="anchor" aria-hidden="true" href="#什麼構成一個-thread-運行的狀態">#</a></h3>
<p>這一題的核心在於必須要了解 thread 需要哪些東西才符合運行的條件，或是說本質上不論是這次題目要做的 uthread 或是 xv6 原先在 kernel 做的 thread switching，本質上都是 save/restore thread 的問題，而我們這裡可以想像</p>
<ol>
<li>save memory 與 register 的狀態</li>
<li>restore memory 與 register 的狀態</li>
</ol>
<p>只要 memory 與 register (包含 program counter) 的狀態可以 save 與 restore 我們就可以做到不同 thread 之間的 switch，接著來依序討論 register 與 memory 的細節。</p>
<h4 id="registers">registers<a hidden class="anchor" aria-hidden="true" href="#registers">#</a></h4>
<p><img alt="registers.png" loading="lazy" src="/xv6/lab7/registers.png">
以下是需要 save/restore 的 registers</p>
<ul>
<li><code>ra</code>: instruction <code>ret</code> 會跑回去的 address</li>
<li><code>sp</code>: 現在的 stack 的位置，這會搭配 <code>(struct *thread) t-&gt;stack</code> 等等在 memory layout 的討論會再一次看到</li>
</ul>
<p>在進入 <code>thread_switch()</code> 的 register 的狀態</p>
<ul>
<li>所有 Caller saved registers 會自然而然的被存下來，這是 compiler 保證會做到的事情</li>
<li>所有 Callee saved registers 需要在 <code>thread_switch()</code> 的時候 save 到 register 中
<ul>
<li>因為在 <code>thread_switch()</code> 之後，這些 Callee saved registers 會被下一個 thread 的 callee saved 洗掉，which is 原本被保證說在 function call 的過程中 callee 負擔 save 與 restore 的責任</li>
<li>我們利用 <code>thread_switch()</code> 的機制，確實是有讓 <code>thread_switch()</code> 這個 callee 附起了 save/restore 的責任，只是跟一般的 jump/ret 的方式複雜了些</li>
</ul>
</li>
</ul>
<p>總結：</p>
<ul>
<li>
<p>callee-saved:</p>
<ul>
<li>以 caller 的角度而言
<ul>
<li>不管我呼叫到了多少的 funcfion，這些 register 都不應該會被改變</li>
<li>在 <code>thread_yield()</code> -&gt; <code>thread_schedule()</code> -&gt; <code>thread_switch()</code> 的過程中 compiler 產出的 assembly 會保證把這些 register 放入 stack 中</li>
</ul>
</li>
<li>以 callee 的角度而言
<ul>
<li>如果我需要使用 callee-saved regisger，那麼我一定要把值還給 caller 再 return</li>
<li>這進入到 <code>thread_switch()</code> 之後沒有 compiler 為我們做這件事情，我們自己把他們放入 <code>(struct *thread) t-&gt;context</code> 中</li>
</ul>
</li>
</ul>
</li>
<li>
<p>caller-saved:</p>
<ul>
<li>以 caller 的角度而言
<ul>
<li>在呼叫別的 function 之前，我一定要自己把 caller-saved register 紀錄下來才行</li>
</ul>
</li>
<li>以 callee 的角度而言
<ul>
<li>我可以隨意的使用 caller-saved register，因為我知道 caller 會自己 value 的還原處理好</li>
<li>所以 <code>thread_switch()</code> 可以不用管是否洗掉 caller-saved registers，因為 compiler 有幫我們放入 stack 中了</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>ra</code></p>
<ul>
<li>是 caller saved register，因為 <code>call</code> 會直接改掉 <code>ra</code> callee 沒有辦法負起 save/restore 的責任</li>
<li>進入 <code>thread_switch()</code> 之前的 <code>ra</code>: 會被存放於 stack 中，這是 compiler 保證的</li>
<li>剛進入到 <code>thread_switch()</code> 的 <code>ra</code>: 放入當前的 <code>(struct *thread) t-&gt;context-&gt;ra</code> 中，這之後要回來當前 thread 的時候會用到</li>
<li>之後再把下一個 thread 當初的 <code>t-&gt;context-&gt;ra</code> 放入 register <code>ra</code> 中，等等 <code>ret</code> 的時候就會直接跳到他上次執行的地方了。</li>
</ul>
</li>
</ul>
<h4 id="memory-layout">memory layout<a hidden class="anchor" aria-hidden="true" href="#memory-layout">#</a></h4>
<p>並不需要思考 text ,data 與 heap 的部份，那些是這 3 個 thread 都會一起共享的，比較麻煩的會在於 stack</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">thread_a</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;thread_a started</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  a_started <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>(b_started <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> c_started <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">thread_yield</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;thread_a %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, i);
</span></span><span style="display:flex;"><span>    a_n <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">thread_yield</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;thread_a: exit after %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, a_n);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  current_thread<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> FREE;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">thread_schedule</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>例如像是 <code>thread_a()</code> 當中的 <code>int i</code>, 他有可能需要放入 stack 中</p>
<ul>
<li>這個 process 的 main thread 的 stack</li>
<li><code>thread_a()</code> 的 stack</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>                   .
</span></span><span style="display:flex;"><span>                   .
</span></span><span style="display:flex;"><span>      +-&gt;          .
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      |   |   previous fp ------+
</span></span><span style="display:flex;"><span>      |   | saved registers |
</span></span><span style="display:flex;"><span>      |   | local variables |
</span></span><span style="display:flex;"><span>      |   |       ...       | &lt;-+
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      +------ previous fp   |   |
</span></span><span style="display:flex;"><span>          | saved registers |   |
</span></span><span style="display:flex;"><span>          | local variables |   |
</span></span><span style="display:flex;"><span>      +-&gt; |       ...       |   |
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      |   |   previous fp ------+
</span></span><span style="display:flex;"><span>      |   | saved registers |
</span></span><span style="display:flex;"><span>      |   | local variables |
</span></span><span style="display:flex;"><span>      |   |       ...       | &lt;-+
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      +------ previous fp   |   |
</span></span><span style="display:flex;"><span>          | saved registers |   |
</span></span><span style="display:flex;"><span>          | local variables |   |
</span></span><span style="display:flex;"><span>  $fp --&gt; |       ...       |   |
</span></span><span style="display:flex;"><span>          +-----------------+   |
</span></span><span style="display:flex;"><span>          | return address  |   |
</span></span><span style="display:flex;"><span>          |   previous fp ------+
</span></span><span style="display:flex;"><span>          | saved registers |
</span></span><span style="display:flex;"><span>  $sp --&gt; | local variables |
</span></span><span style="display:flex;"><span>          +-----------------+
</span></span></code></pre></div><p>一切要先回到 current 的當前狀態，來看看 <code>uthread.asm</code>
注意</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>void 
</span></span><span style="display:flex;"><span>thread_a(void)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> 100:	7179                	addi	sp,sp,-48
</span></span><span style="display:flex;"><span> 102:	f406                	sd	ra,40(sp)
</span></span><span style="display:flex;"><span> 104:	f022                	sd	s0,32(sp)
</span></span><span style="display:flex;"><span> 106:	ec26                	sd	s1,24(sp)
</span></span><span style="display:flex;"><span> 108:	e84a                	sd	s2,16(sp)
</span></span><span style="display:flex;"><span> 10a:	e44e                	sd	s3,8(sp)
</span></span><span style="display:flex;"><span> 10c:	e052                	sd	s4,0(sp)
</span></span><span style="display:flex;"><span> 10e:	1800                	addi	s0,sp,48
</span></span><span style="display:flex;"><span>  int i;
</span></span><span style="display:flex;"><span>  printf(&#34;thread_a started\n&#34;);
</span></span><span style="display:flex;"><span> 110:	00001517          	auipc	a0,0x1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 1bc:	70a2                	ld	ra,40(sp)
</span></span><span style="display:flex;"><span> 1be:	7402                	ld	s0,32(sp)
</span></span><span style="display:flex;"><span> 1c0:	64e2                	ld	s1,24(sp)
</span></span><span style="display:flex;"><span> 1c2:	6942                	ld	s2,16(sp)
</span></span><span style="display:flex;"><span> 1c4:	69a2                	ld	s3,8(sp)
</span></span><span style="display:flex;"><span> 1c6:	6a02                	ld	s4,0(sp)
</span></span><span style="display:flex;"><span> 1c8:	6145                	addi	sp,sp,48
</span></span><span style="display:flex;"><span> 1ca:	8082                	ret
</span></span></code></pre></div><p>這裡可以看到前後對於 <code>sp</code> 的操作，</p>
<p>一般情況下在同一個 process 的範圍內，只需要單純的往下長就好，這裡則需要特別設定<code>sp</code> 指向特定在 <code>struct thread</code> 中專屬的 <code>stack</code></p>
<p>(TODO: 這裡沒有用 <code>fp</code>，跟 lab trap 中的 backtrace 不一樣，這方面可以再詳述)
這裡的 <code>s0</code> 就是 <code>fp</code> 的意思</p>
<p>總結一下我們要如何回答「如何</p>
<h3 id="實做-thread_create">實做 <code>thread_create()</code><a hidden class="anchor" aria-hidden="true" href="#實做-thread_create">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> context {
</span></span><span style="display:flex;"><span>  uint64 ra;
</span></span><span style="display:flex;"><span>  uint64 sp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// callee-saved
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 s0;
</span></span><span style="display:flex;"><span>  uint64 s1;
</span></span><span style="display:flex;"><span>  uint64 s2;
</span></span><span style="display:flex;"><span>  uint64 s3;
</span></span><span style="display:flex;"><span>  uint64 s4;
</span></span><span style="display:flex;"><span>  uint64 s5;
</span></span><span style="display:flex;"><span>  uint64 s6;
</span></span><span style="display:flex;"><span>  uint64 s7;
</span></span><span style="display:flex;"><span>  uint64 s8;
</span></span><span style="display:flex;"><span>  uint64 s9;
</span></span><span style="display:flex;"><span>  uint64 s10;
</span></span><span style="display:flex;"><span>  uint64 s11;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">thread</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span>       stack[STACK_SIZE]; <span style="color:#75715e">/* the thread&#39;s stack */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span>        state;             <span style="color:#75715e">/* FREE, RUNNING, RUNNABLE */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> context context;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">thread_create</span>(<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>func)())
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">thread</span> <span style="color:#f92672">*</span>t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (t <span style="color:#f92672">=</span> all_thread; t <span style="color:#f92672">&lt;</span> all_thread <span style="color:#f92672">+</span> MAX_THREAD; t<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (t<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">==</span> FREE) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  t<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> RUNNABLE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// YOUR CODE HERE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  t<span style="color:#f92672">-&gt;</span>context<span style="color:#f92672">-&gt;</span>ra <span style="color:#f92672">=</span> (uint64) func;
</span></span><span style="display:flex;"><span>  t<span style="color:#f92672">-&gt;</span>context<span style="color:#f92672">-&gt;</span>sp <span style="color:#f92672">=</span> (uint64) (t<span style="color:#f92672">-&gt;</span>stack <span style="color:#f92672">+</span> STACK_SIZE <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>context</code>: 這裡跟 <code>kernel/proc.h</code> 的 <code>context</code> 一樣，並且如同先前分析需要 save/restore 的 register 一樣</li>
<li><code>ra</code> 直接設定到 <code>func</code> 的 address，在第一次執行到的時候，就會直接 ret 到 very first instruction of this function 了</li>
<li>如同先前分析的 stack 的使用，thread 在初始時，會需要先把 stack 的頂端的資訊給設定下來，這裡要記得 stack 是往下長的</li>
</ul>
<h3 id="實做-thread_schedule">實做 <code>thread_schedule()</code><a hidden class="anchor" aria-hidden="true" href="#實做-thread_schedule">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">thread_schedule</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">thread</span> <span style="color:#f92672">*</span>t, <span style="color:#f92672">*</span>next_thread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* Find another runnable thread. */</span>
</span></span><span style="display:flex;"><span>  next_thread <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  t <span style="color:#f92672">=</span> current_thread <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> MAX_THREAD; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(t <span style="color:#f92672">&gt;=</span> all_thread <span style="color:#f92672">+</span> MAX_THREAD)
</span></span><span style="display:flex;"><span>      t <span style="color:#f92672">=</span> all_thread;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(t<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">==</span> RUNNABLE) {
</span></span><span style="display:flex;"><span>      next_thread <span style="color:#f92672">=</span> t;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> t <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (next_thread <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;thread_schedule: no runnable threads</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (current_thread <span style="color:#f92672">!=</span> next_thread) {         <span style="color:#75715e">/* switch threads?  */</span>
</span></span><span style="display:flex;"><span>    next_thread<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> RUNNING;
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> current_thread;
</span></span><span style="display:flex;"><span>    current_thread <span style="color:#f92672">=</span> next_thread;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* YOUR CODE HERE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Invoke thread_switch to switch from t to next_thread:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * thread_switch(??, ??);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">thread_switch</span>((uint64) <span style="color:#f92672">&amp;</span>t<span style="color:#f92672">-&gt;</span>context, (uint64) <span style="color:#f92672">&amp;</span>next_thread<span style="color:#f92672">-&gt;</span>context);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    next_thread <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="實做-thread_switch">實做 <code>thread_switch</code><a hidden class="anchor" aria-hidden="true" href="#實做-thread_switch">#</a></h3>
<p>這裡直接照抄 <code>kernel/swtch.S</code> 就好</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>	<span style="color:#a6e22e">.globl</span> <span style="color:#66d9ef">thread_switch</span>
</span></span><span style="display:flex;"><span>thread_switch:
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* YOUR CODE HERE */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">ra</span>, <span style="color:#ae81ff">0</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">sp</span>, <span style="color:#ae81ff">8</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s0</span>, <span style="color:#ae81ff">16</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s1</span>, <span style="color:#ae81ff">24</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s2</span>, <span style="color:#ae81ff">32</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s3</span>, <span style="color:#ae81ff">40</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s4</span>, <span style="color:#ae81ff">48</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s5</span>, <span style="color:#ae81ff">56</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s6</span>, <span style="color:#ae81ff">64</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s7</span>, <span style="color:#ae81ff">72</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s8</span>, <span style="color:#ae81ff">80</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s9</span>, <span style="color:#ae81ff">88</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s10</span>, <span style="color:#ae81ff">96</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sd</span> <span style="color:#66d9ef">s11</span>, <span style="color:#ae81ff">104</span>(<span style="color:#66d9ef">a0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">ra</span>, <span style="color:#ae81ff">0</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">sp</span>, <span style="color:#ae81ff">8</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s0</span>, <span style="color:#ae81ff">16</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s1</span>, <span style="color:#ae81ff">24</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s2</span>, <span style="color:#ae81ff">32</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s3</span>, <span style="color:#ae81ff">40</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s4</span>, <span style="color:#ae81ff">48</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s5</span>, <span style="color:#ae81ff">56</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s6</span>, <span style="color:#ae81ff">64</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s7</span>, <span style="color:#ae81ff">72</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s8</span>, <span style="color:#ae81ff">80</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s9</span>, <span style="color:#ae81ff">88</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s10</span>, <span style="color:#ae81ff">96</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ld</span> <span style="color:#66d9ef">s11</span>, <span style="color:#ae81ff">104</span>(<span style="color:#66d9ef">a1</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ret</span>    <span style="color:#75715e">/* return to ra */</span>
</span></span></code></pre></div><p>最後看 <code>make qemu</code> 之後 <code>uthread</code> 看有沒有出錯就好了</p>
<h2 id="using-threads-moderate">Using threads (moderate)<a hidden class="anchor" aria-hidden="true" href="#using-threads-moderate">#</a></h2>
<p>使用 <code>table_locks</code> 解決</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> entry {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> key;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> value;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> entry <span style="color:#f92672">*</span>next;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> entry <span style="color:#f92672">*</span>table[NBUCKET];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pthread_mutex_t</span> table_locks[NBUCKET];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> keys[NKEYS];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> nthread <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span></code></pre></div><p>在 <code>main()</code> 中初始化</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (argc <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Usage: %s nthreads</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, argv[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> NBUCKET; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pthread_mutex_init</span>(<span style="color:#f92672">&amp;</span>table_locks[i], NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>在使用到 <code>table[i]</code> 的前後使用 <code>pthread_mutex_lock()</code> 以及 <code>pthread_mutex_unlock()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">put</span>(<span style="color:#66d9ef">int</span> key, <span style="color:#66d9ef">int</span> value)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> key <span style="color:#f92672">%</span> NBUCKET;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pthread_mutex_lock</span>(<span style="color:#f92672">&amp;</span>table_locks[i]); <span style="color:#75715e">// lock!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> entry <span style="color:#f92672">*</span>e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (e <span style="color:#f92672">=</span> table[i]; e <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>; e <span style="color:#f92672">=</span> e<span style="color:#f92672">-&gt;</span>next) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (e<span style="color:#f92672">-&gt;</span>key <span style="color:#f92672">==</span> key)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(e){
</span></span><span style="display:flex;"><span>    e<span style="color:#f92672">-&gt;</span>value <span style="color:#f92672">=</span> value;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">insert</span>(key, value, <span style="color:#f92672">&amp;</span>table[i], table[i]);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pthread_mutex_unlock</span>(<span style="color:#f92672">&amp;</span>table_locks[i]); <span style="color:#75715e">// unlock!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>(TODO: 分析與解釋)</p>
<h2 id="barriermoderate">Barrier(moderate)<a hidden class="anchor" aria-hidden="true" href="#barriermoderate">#</a></h2>
<p>Barrier 的用意在於希望多個 thread 可以到達某個 點之後，大家再一起繼續執行下去</p>
<h3 id="struct-barrier-解釋"><code>struct barrier</code> 解釋<a hidden class="anchor" aria-hidden="true" href="#struct-barrier-解釋">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> nthread <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// 總共有多少個 thread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> barrier {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// pthread_cond_wait() 需要有 cond 以及 mutex 作為參數
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pthread_mutex_t</span> barrier_mutex; <span style="color:#75715e">// 必須拿到 mutex 針對 bstate 做動作
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pthread_cond_t</span> barrier_cond;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> nthread;      <span style="color:#75715e">// 有多少 thread 到達了 barrier
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> round;        <span style="color:#75715e">// 總共有 20000 回合的 barrier
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} bstate;           <span style="color:#75715e">// round 用來紀錄現在進行到了第幾回合
</span></span></span></code></pre></div><h3 id="程式實做">程式實做<a hidden class="anchor" aria-hidden="true" href="#程式實做">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">barrier</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// YOUR CODE HERE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// Block until all threads have called barrier() and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// then increment bstate.round.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">pthread_mutex_lock</span>(<span style="color:#f92672">&amp;</span>bstate.barrier_mutex);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  bstate.nthread<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (bstate.nthread <span style="color:#f92672">&lt;</span> nthread) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pthread_cond_wait</span>(<span style="color:#f92672">&amp;</span>bstate.barrier_cond, <span style="color:#f92672">&amp;</span>bstate.barrier_mutex);
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    bstate.round<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    bstate.nthread <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pthread_cond_broadcast</span>(<span style="color:#f92672">&amp;</span>bstate.barrier_cond);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pthread_mutex_unlock</span>(<span style="color:#f92672">&amp;</span>bstate.barrier_mutex);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>(TODO: 分析與解釋)</p>
<p><img alt="ac.png" loading="lazy" src="/xv6/lab7/ac.png"></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/xv6/lab7.1/">
    <span class="title">« Prev</span>
    <br>
    <span>[xv6 學習紀錄 07-1] Thread Switching</span>
  </a>
  <a class="next" href="http://localhost:1313/xv6/lab8/">
    <span class="title">Next »</span>
    <br>
    <span>[xv6 學習紀錄 08] Lab: locks</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Yama&#39;s Trail</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>[xv6 學習紀錄 04] Lab: Traps | Yama&#39;s Trail</title>
<meta name="keywords" content="">
<meta name="description" content="Lab 連結: lab traps
課程影片連結：

6.S081 Fall 2020 Lecture 5: RISC-V Calling Convention and Stack Frames 
6.S081 Fall 2020 Lecture 6: Isolation &amp; System Call Entry/Exit

RISC-V assembly (easy)

It will be important to understand a bit of RISC-V assembly, which you were exposed to in 6.1910 (6.004). There is a file user/call.c in your xv6 repo. make fs.img compiles it and also produces a readable assembly version of the program in user/call.asm.
Read the code in call.asm for the functions g, f, and main. The instruction manual for RISC-V is on the reference page. Here are some questions that you should answer (store the answers in a file answers-traps.txt):">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/xv6/lab4/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e1f5c4cae44599655f7ff95195ff89c8cb3adbda94f2b1581a434ab2b4d4e6cf.css" integrity="sha256-4fXEyuRFmWVff/lRlf&#43;JyMs629qU8rFYGkNKsrTU5s8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon_io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon_io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon_io/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon_io/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/xv6/lab4/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Yama&#39;s Trail (Alt + H)">Yama&#39;s Trail</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/dev-log/" title="這個網站的誕生">
                    <span>這個網站的誕生</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/leetcode/" title="LeetCode 解題">
                    <span>LeetCode 解題</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xv6/" title="xv6 學習紀錄">
                    <span>xv6 學習紀錄</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      [xv6 學習紀錄 04] Lab: Traps
    </h1>
    <div class="post-meta"><span title='2025-10-09 11:31:37 +0800 CST'>October 9, 2025</span>

</div>
  </header> 
  <div class="post-content"><p>Lab 連結: <a href="https://pdos.csail.mit.edu/6.S081/2022/labs/traps.html">lab traps</a></p>
<p>課程影片連結：</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=s-Z5t_yTyTM">6.S081 Fall 2020 Lecture 5: RISC-V Calling Convention and Stack Frames </a></li>
<li><a href="https://www.youtube.com/watch?v=T26UuauaxWA">6.S081 Fall 2020 Lecture 6: Isolation &amp; System Call Entry/Exit</a></li>
</ul>
<h2 id="risc-v-assembly-easy">RISC-V assembly (easy)<a hidden class="anchor" aria-hidden="true" href="#risc-v-assembly-easy">#</a></h2>
<blockquote>
<p>It will be important to understand a bit of RISC-V assembly, which you were exposed to in 6.1910 (6.004). There is a file <code>user/call.c</code> in your xv6 repo. <code>make fs.img</code> compiles it and also produces a readable assembly version of the program in <code>user/call.asm</code>.
Read the code in <code>call.asm</code> for the functions <code>g</code>, <code>f</code>, and <code>main</code>. The instruction manual for RISC-V is on the reference page. Here are some questions that you should answer (store the answers in a file <code>answers-traps.txt</code>):</p></blockquote>
<p>這題要我們閱讀 <code>user/call.c</code> 對應的 <code>call.asm</code> 確保我們對於 C 語言到 RISC-V 的轉換是有概念的，我們需要回答以下問題：</p>
<blockquote>
<p>Which registers contain arguments to functions? For example, which register holds 13 in main&rsquo;s call to <code>printf</code>?</p></blockquote>
<p>arguments 是存放於 <code>a0</code>, <code>a1</code>, <code>a2</code> &hellip; 例如</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">f</span>(<span style="color:#ae81ff">8</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">13</span>);
</span></span></code></pre></div><p><code>13</code> 是第 3 個 argument, 存放於 <code>a2</code>，在 <code>call.asm</code> 中也可以看到</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#960050;background-color:#1e0010">&#34;</span>%d %d<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">n</span><span style="color:#960050;background-color:#1e0010">&#34;</span>, <span style="color:#66d9ef">f</span>(<span style="color:#ae81ff">8</span>)<span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">13</span>)<span style="color:#75715e">;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">24:</span>	<span style="color:#960050;background-color:#1e0010">4635</span>                	<span style="color:#a6e22e">li</span>	<span style="color:#66d9ef">a2</span>,<span style="color:#ae81ff">13</span> <span style="color:#75715e"># &lt;-- put value 13 to a2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">26:</span>	<span style="color:#960050;background-color:#1e0010">45</span><span style="color:#a6e22e">b1</span>                	<span style="color:#66d9ef">li</span>	<span style="color:#66d9ef">a1</span>,<span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">28:</span>	<span style="color:#960050;background-color:#1e0010">00000517</span>          	<span style="color:#a6e22e">auipc</span>	<span style="color:#66d9ef">a0</span>,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">2</span>c:	<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">b850513</span>          	<span style="color:#66d9ef">addi</span>	<span style="color:#66d9ef">a0</span>,<span style="color:#66d9ef">a0</span>,<span style="color:#ae81ff">1976</span> <span style="color:#75715e"># 7e0 &lt;malloc+0xe6&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">30:</span>	<span style="color:#960050;background-color:#1e0010">00000097</span>          	<span style="color:#a6e22e">auipc</span>	<span style="color:#66d9ef">ra</span>,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">34:</span>	<span style="color:#960050;background-color:#1e0010">612080</span><span style="color:#a6e22e">e7</span>          	<span style="color:#66d9ef">jalr</span>	<span style="color:#ae81ff">1554</span>(<span style="color:#66d9ef">ra</span>) <span style="color:#75715e"># 642 &lt;printf&gt;
</span></span></span></code></pre></div><blockquote>
<p>Where is the call to function <code>f</code> in the assembly code for <code>main</code>? Where is the call to <code>g</code>? (Hint: the compiler may inline functions.)</p></blockquote>
<ul>
<li><code>user/call.c</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">g</span>(<span style="color:#66d9ef">int</span> x) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> x<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">f</span>(<span style="color:#66d9ef">int</span> x) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">g</span>(x);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">f</span>(<span style="color:#ae81ff">8</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">13</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>就以 <code>user/call.c</code> 來說，<code>f()</code> 只是呼叫 <code>g()</code>, <code>g()</code> 的作用只是回傳 <code>x + 3</code>，在 <code>call.asm</code> 中，可以看到 compiler 直接把 <code>f(8)+1</code> 的答案 <code>12</code> 算出來並且寫死丟入 <code>f(8)+1</code> 所代表的第 2 個 argument <code>a1</code> 中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">void</span> <span style="color:#66d9ef">main</span>(<span style="color:#66d9ef">void</span>) <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">1</span>c:	<span style="color:#960050;background-color:#1e0010">1141</span>                	<span style="color:#a6e22e">addi</span>	<span style="color:#66d9ef">sp</span>,<span style="color:#66d9ef">sp</span>,-<span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">1</span>e:	<span style="color:#a6e22e">e406</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">ra</span>,<span style="color:#ae81ff">8</span>(<span style="color:#66d9ef">sp</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">20:</span>	<span style="color:#a6e22e">e022</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">s0</span>,<span style="color:#ae81ff">0</span>(<span style="color:#66d9ef">sp</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">22:</span>	<span style="color:#960050;background-color:#1e0010">0800</span>                	<span style="color:#a6e22e">addi</span>	<span style="color:#66d9ef">s0</span>,<span style="color:#66d9ef">sp</span>,<span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#960050;background-color:#1e0010">&#34;</span>%d %d<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">n</span><span style="color:#960050;background-color:#1e0010">&#34;</span>, <span style="color:#66d9ef">f</span>(<span style="color:#ae81ff">8</span>)<span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">13</span>)<span style="color:#75715e">;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">24:</span>	<span style="color:#960050;background-color:#1e0010">4635</span>                	<span style="color:#a6e22e">li</span>	<span style="color:#66d9ef">a2</span>,<span style="color:#ae81ff">13</span> <span style="color:#75715e"># &lt;-- call to f and call to g
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">26:</span>	<span style="color:#960050;background-color:#1e0010">45</span><span style="color:#a6e22e">b1</span>                	<span style="color:#66d9ef">li</span>	<span style="color:#66d9ef">a1</span>,<span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">28:</span>	<span style="color:#960050;background-color:#1e0010">00000517</span>          	<span style="color:#a6e22e">auipc</span>	<span style="color:#66d9ef">a0</span>,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">2</span>c:	<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">b850513</span>          	<span style="color:#66d9ef">addi</span>	<span style="color:#66d9ef">a0</span>,<span style="color:#66d9ef">a0</span>,<span style="color:#ae81ff">1976</span> <span style="color:#75715e"># 7e0 &lt;malloc+0xe6&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">30:</span>	<span style="color:#960050;background-color:#1e0010">00000097</span>          	<span style="color:#a6e22e">auipc</span>	<span style="color:#66d9ef">ra</span>,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">34:</span>	<span style="color:#960050;background-color:#1e0010">612080</span><span style="color:#a6e22e">e7</span>          	<span style="color:#66d9ef">jalr</span>	<span style="color:#ae81ff">1554</span>(<span style="color:#66d9ef">ra</span>) <span style="color:#75715e"># 642 &lt;printf&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>)<span style="color:#75715e">;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">38:</span>	<span style="color:#960050;background-color:#1e0010">4501</span>                	<span style="color:#a6e22e">li</span>	<span style="color:#66d9ef">a0</span>,<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">3</span>a:	<span style="color:#960050;background-color:#1e0010">00000097</span>          	<span style="color:#a6e22e">auipc</span>	<span style="color:#66d9ef">ra</span>,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">3</span>e:	<span style="color:#960050;background-color:#1e0010">28</span><span style="color:#a6e22e">e080e7</span>          	<span style="color:#66d9ef">jalr</span>	<span style="color:#ae81ff">654</span>(<span style="color:#66d9ef">ra</span>) <span style="color:#75715e"># 2c8 &lt;exit&gt;
</span></span></span></code></pre></div><blockquote>
<p>At what address is the function <code>printf</code> located?</p></blockquote>
<p>根據</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">34:</span>	<span style="color:#960050;background-color:#1e0010">612080</span><span style="color:#a6e22e">e7</span>          	<span style="color:#66d9ef">jalr</span>	<span style="color:#ae81ff">1554</span>(<span style="color:#66d9ef">ra</span>) <span style="color:#75715e"># 642 &lt;printf&gt;
</span></span></span></code></pre></div><p>可得知 <code>printf</code> 的 address 在 <code>642</code> 中，<code>jalr 1554(ra)</code> 做了一下兩件事</p>
<ul>
<li>jump 到 <code>printf</code></li>
<li>Link: saves the address of the next instruction
*</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> *<span style="color:#66d9ef">fmt</span>, <span style="color:#66d9ef">...</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">642:</span>	<span style="color:#960050;background-color:#1e0010">711</span><span style="color:#a6e22e">d</span>                	<span style="color:#66d9ef">addi</span>	<span style="color:#66d9ef">sp</span>,<span style="color:#66d9ef">sp</span>,-<span style="color:#ae81ff">96</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">644:</span>	<span style="color:#a6e22e">ec06</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">ra</span>,<span style="color:#ae81ff">24</span>(<span style="color:#66d9ef">sp</span>)
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">646:</span>	<span style="color:#a6e22e">e822</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">s0</span>,<span style="color:#ae81ff">16</span>(<span style="color:#66d9ef">sp</span>)
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">648:</span>	<span style="color:#960050;background-color:#1e0010">1000</span>                	<span style="color:#a6e22e">addi</span>	<span style="color:#66d9ef">s0</span>,<span style="color:#66d9ef">sp</span>,<span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">64</span>a:	<span style="color:#a6e22e">e40c</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">a1</span>,<span style="color:#ae81ff">8</span>(<span style="color:#66d9ef">s0</span>)
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">64</span>c:	<span style="color:#a6e22e">e810</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">a2</span>,<span style="color:#ae81ff">16</span>(<span style="color:#66d9ef">s0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">...</span>
</span></span></code></pre></div><p>也可以在這裡的 <code>642</code> 中看到</p>
<blockquote>
<p>What value is in the register <code>ra</code> just after the <code>jalr</code> to <code>printf</code> in <code>main</code>?</p></blockquote>
<ol>
<li>terminal 1: <code>make qemu-gdb</code></li>
<li>terminal 2: <code>gdb-multiarch</code>, <code>layout split</code></li>
<li>於 termianl 2:
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">(gdb) add-symbol-file user/_call
</code></pre><ul>
<li>set a break point at <code>printf()</code> 的下一行 <code>exit()</code> line 16</li>
</ul>
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">(gdb) b user/call.c:16
</code></pre><ul>
<li>continue</li>
</ul>
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">(gdb) c
</code></pre></li>
<li>於 termianl 1: <code>$ call</code></li>
<li>於 termianl 2: <code>p $ra</code>
<ul>
<li>得知這題的答案: <code>$ra</code> 為這一個 instruction <code>li a0, 0</code> 本身的 address <code>0x38</code>
<img alt="ra-after-printf.png" loading="lazy" src="/xv6/lab4/ra-after-printf.png"></li>
<li>解釋：因為在 <code>jalr 1562(ra)</code> 就已經把 <code>ra</code> 設為 <code>0x38</code> 了，直到 <code>printf</code> return 回來，都還是 <code>0x38</code>，<code>ra</code> 是 caller saved register，所以要 caller (<code>main()</code>) 自己在事前把 <code>ra</code> 的值保留在 stack 中，並且在 function call (<code>printf()</code>) 結束之後把 <code>ra</code> restore 回來</li>
<li>在 <code>call</code>, <code>jalr</code> 這種 function call 的 instruction 會在硬體上修改 <code>ra</code> 的效果的前提之下，<code>ra</code> 是 caller saved register 是一個必要的設計</li>
</ul>
</li>
</ol>
<blockquote>
<p>Run the following code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00646c72</span>;
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;H%x Wo%s&#34;</span>, <span style="color:#ae81ff">57616</span>, <span style="color:#f92672">&amp;</span>i);
</span></span></code></pre></div><p>What is the output? <a href="https://www.asciitable.com/">Here&rsquo;s an ASCII table</a> that maps bytes to characters.</p>
<p>The output depends on that fact that the RISC-V is little-endian. If the RISC-V were instead big-endian what would you set <code>i</code> to in order to yield the same output? Would you need to change <code>57616</code> to a different value?
<a href="http://www.webopedia.com/TERM/b/big_endian.html">Here&rsquo;s a description of little- and big-endian</a> and a more whimsical description.</p></blockquote>
<p><img alt="endian.png" loading="lazy" src="/xv6/lab4/endian.png"></p>
<ul>
<li>Big-endian:
output 為</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>HE111 World
</span></span></code></pre></div><ul>
<li>57616 in <code>%x</code></li>
<li><code>i = 0x00646c72</code> in <code>%s</code></li>
</ul>
<p>如果改為 big-endian 則會相反過來
(TODO: 再寫的更詳細一些)</p>
<blockquote>
<p>In the following code, what is going to be printed after <code>'y='</code>? (note: the answer is not a specific value.) Why does this happen?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;x=%d y=%d&#34;</span>, <span style="color:#ae81ff">3</span>);
</span></span></code></pre></div></blockquote>
<p>這取決於當時 (call to <code>printf</code> 的當下) <code>a2</code>(代表第 3 個 argument) 的值是多少，順帶一題這時代表第一個 argument 的 <code>a0</code> 為 address of <code>&quot;x=%d y=%d&quot;</code>, <code>a1</code> 為 <code>3</code></p>
<h2 id="backtrace-moderate">Backtrace (moderate)<a hidden class="anchor" aria-hidden="true" href="#backtrace-moderate">#</a></h2>
<blockquote>
<p>Implement a <code>backtrace()</code> function in <code>kernel/printf.c</code>. Insert a call to this function in <code>sys_sleep</code>, and then run <code>bttest</code>, which calls <code>sys_sleep</code>. Your output should be a list of return addresses with this form (but the numbers will likely be different):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>    backtrace:
</span></span><span style="display:flex;"><span>    0x0000000080002cda
</span></span><span style="display:flex;"><span>    0x0000000080002bb6
</span></span><span style="display:flex;"><span>    0x0000000080002898
</span></span></code></pre></div><p>After <code>bttest</code> exit qemu. In a terminal window: run <code>addr2line -e kernel/kernel</code> (or <code>riscv64-unknown-elf-addr2line -e kernel/kernel</code>) and cut-and-paste the addresses from your backtrace, like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>    $ addr2line -e kernel/kernel
</span></span><span style="display:flex;"><span>    0x0000000080002de2
</span></span><span style="display:flex;"><span>    0x0000000080002f4a
</span></span><span style="display:flex;"><span>    0x0000000080002bfc
</span></span><span style="display:flex;"><span>    Ctrl-D
</span></span></code></pre></div><p>You should see something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    kernel/sysproc.c:74
</span></span><span style="display:flex;"><span>    kernel/syscall.c:224
</span></span><span style="display:flex;"><span>    kernel/trap.c:85
</span></span></code></pre></div></blockquote>
<p>我們需要先了解 xv6 的 stack 長什麼樣子才有辦法解這一題</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>                   .
</span></span><span style="display:flex;"><span>                   .
</span></span><span style="display:flex;"><span>      +-&gt;          .
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      |   |   previous fp ------+
</span></span><span style="display:flex;"><span>      |   | saved registers |
</span></span><span style="display:flex;"><span>      |   | local variables |
</span></span><span style="display:flex;"><span>      |   |       ...       | &lt;-+
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      +------ previous fp   |   |
</span></span><span style="display:flex;"><span>          | saved registers |   |
</span></span><span style="display:flex;"><span>          | local variables |   |
</span></span><span style="display:flex;"><span>      +-&gt; |       ...       |   |
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      |   |   previous fp ------+
</span></span><span style="display:flex;"><span>      |   | saved registers |
</span></span><span style="display:flex;"><span>      |   | local variables |
</span></span><span style="display:flex;"><span>      |   |       ...       | &lt;-+
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      +------ previous fp   |   |
</span></span><span style="display:flex;"><span>          | saved registers |   |
</span></span><span style="display:flex;"><span>          | local variables |   |
</span></span><span style="display:flex;"><span>  $fp --&gt; |       ...       |   |
</span></span><span style="display:flex;"><span>          +-----------------+   |
</span></span><span style="display:flex;"><span>          | return address  |   |
</span></span><span style="display:flex;"><span>          |   previous fp ------+
</span></span><span style="display:flex;"><span>          | saved registers |
</span></span><span style="display:flex;"><span>  $sp --&gt; | local variables |
</span></span><span style="display:flex;"><span>          +-----------------+
</span></span></code></pre></div><p>從這裡可以看到，理論上我們可以從 <code>sp</code> 開始，一次一次的利用 <code>fp</code> 往上找尋前一個 frame，就可以達成題目要的 <code>backtrace</code></p>
<ul>
<li><code>sp</code>: 指向 stack 的頂端，由 assembly 自行控制，是一個 convention</li>
<li><code>fp</code>: 指向前一個 stack 的頂端，由 assembly 自行控制，是一個 convention</li>
</ul>
<p><img alt="process_layout2.png" loading="lazy" src="/xv6/lab4/process_layout2.png">
值得注意的是，在 xv6 的設計中，stack 的大小只有一個 page，這在之後 <code>backtrace()</code> 是否抵達第一個 frame 的判斷可以起到作用，不過這個 stack 的 virtual address 並不是固定的</p>
<ul>
<li><code>kernel/defs.h</code>:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// printf.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>            <span style="color:#a6e22e">printf</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>, ...);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span>            <span style="color:#a6e22e">panic</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>) <span style="color:#a6e22e">__attribute__</span>((noreturn));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span>            <span style="color:#a6e22e">printfinit</span>(<span style="color:#66d9ef">void</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span>            <span style="color:#a6e22e">backtrace</span>(<span style="color:#66d9ef">void</span>);
</span></span></code></pre></div><ul>
<li><code>kernel/printf.c</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">backtrace</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// TODO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li><code>kernel/riscv.h</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">r_fp</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 x;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34;mv %0, s0&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;=r&#34;</span> (x) );
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> x;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>kernel/sysproc.c</code>: 在 <code>sys_sleep()</code> 中呼叫 <code>backtrace()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_sleep</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n;
</span></span><span style="display:flex;"><span>  uint ticks0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">backtrace</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>n);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(n <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>  ticks0 <span style="color:#f92672">=</span> ticks;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>(ticks <span style="color:#f92672">-</span> ticks0 <span style="color:#f92672">&lt;</span> n){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">killed</span>(<span style="color:#a6e22e">myproc</span>())){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sleep</span>(<span style="color:#f92672">&amp;</span>ticks, <span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="先用-gdb-的-backtrace">先用 <code>gdb</code> 的 <code>backtrace</code><a hidden class="anchor" aria-hidden="true" href="#先用-gdb-的-backtrace">#</a></h3>
<ol>
<li>termianl 1: <code>make qemu-gdb</code></li>
<li>termianl 2: <code>gdb-multiarch</code></li>
<li>termianl 1:
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">(gdb) layout src
(gdb) b backtrace
(gdb) c
</code></pre></li>
<li>termianl 2: <code>bttest</code></li>
<li>termianl 1:
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">(gdb) backtrace
</code></pre><img alt="gdb-backtrace.png" loading="lazy" src="/xv6/lab4/gdb-backtrace.png">
<img alt="backtrace-address.png" loading="lazy" src="/xv6/lab4/backtrace-address.png">
<ul>
<li>在這裡可以看到 <code>backtrace</code> 要 print 出來的 address 是各個 return address，像是這個當下的 <code>ra</code></li>
</ul>
</li>
</ol>
<h3 id="在-gdb-中不使用-backtrace-但做到-backtrace-要達成的事情">在 <code>gdb</code> 中不使用 <code>backtrace</code> 但做到 <code>backtrace</code> 要達成的事情<a hidden class="anchor" aria-hidden="true" href="#在-gdb-中不使用-backtrace-但做到-backtrace-要達成的事情">#</a></h3>
<p>(TODO)</p>
<h3 id="backtrace-程式實做"><code>backtrace()</code> 程式實做<a hidden class="anchor" aria-hidden="true" href="#backtrace-程式實做">#</a></h3>
<p>先嘗試這樣一層一層的找上去:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">backtrace</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 fp_bt;
</span></span><span style="display:flex;"><span>  uint64 fp_slp;
</span></span><span style="display:flex;"><span>  uint64 fp_sysc;
</span></span><span style="display:flex;"><span>  uint64 fp_usrtp;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  fp_bt <span style="color:#f92672">=</span> <span style="color:#a6e22e">r_fp</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;fp of backtrace() = %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, fp_bt);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ra to sys_sleep() = %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_bt <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  fp_slp <span style="color:#f92672">=</span> (uint64) <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_bt <span style="color:#f92672">-</span> <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;fp of sys_sleep() = %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, fp_slp);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ra to syscall() = %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_slp <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  fp_sysc <span style="color:#f92672">=</span> (uint64) <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_slp <span style="color:#f92672">-</span> <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;fp of syscall() = %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, fp_sysc);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ra to usertrap() = %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_sysc <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  fp_usrtp <span style="color:#f92672">=</span> (uint64) <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_sysc <span style="color:#f92672">-</span> <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;fp of usertrap() = %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, fp_usrtp);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ra to ?? = %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_usrtp <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;backtrace:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ra to sys_sleep() = %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_bt <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ra to syscall() = %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_slp <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;ra to usertrap() = %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_sysc <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>output:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ bttest
</span></span><span style="display:flex;"><span>fp of backtrace<span style="color:#f92672">()</span> <span style="color:#f92672">=</span> 0x0000003fffff9f80
</span></span><span style="display:flex;"><span>ra to sys_sleep<span style="color:#f92672">()</span> <span style="color:#f92672">=</span> 0x000000008000212e
</span></span><span style="display:flex;"><span>fp of sys_sleep<span style="color:#f92672">()</span> <span style="color:#f92672">=</span> 0x0000003fffff9fc0
</span></span><span style="display:flex;"><span>ra to syscall<span style="color:#f92672">()</span> <span style="color:#f92672">=</span> 0x0000000080002020
</span></span><span style="display:flex;"><span>fp of syscall<span style="color:#f92672">()</span> <span style="color:#f92672">=</span> 0x0000003fffff9fe0
</span></span><span style="display:flex;"><span>ra to usertrap<span style="color:#f92672">()</span> <span style="color:#f92672">=</span> 0x0000000080001d16
</span></span><span style="display:flex;"><span>fp of usertrap<span style="color:#f92672">()</span> <span style="color:#f92672">=</span> 0x0000003fffffa000
</span></span><span style="display:flex;"><span>ra to ?? <span style="color:#f92672">=</span> 0x0000000000000012
</span></span><span style="display:flex;"><span>backtrace:
</span></span><span style="display:flex;"><span>ra to sys_sleep<span style="color:#f92672">()</span> <span style="color:#f92672">=</span> 0x000000008000212e
</span></span><span style="display:flex;"><span>ra to syscall<span style="color:#f92672">()</span> <span style="color:#f92672">=</span> 0x0000000080002020
</span></span><span style="display:flex;"><span>ra to usertrap<span style="color:#f92672">()</span> <span style="color:#f92672">=</span> 0x0000000080001d16
</span></span></code></pre></div><p>做成迴圈的版本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">backtrace</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 fp_curr;
</span></span><span style="display:flex;"><span>  uint64 top;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  fp_curr <span style="color:#f92672">=</span> <span style="color:#a6e22e">r_fp</span>();
</span></span><span style="display:flex;"><span>  top <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDUP</span>(fp_curr);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (fp_curr <span style="color:#f92672">&lt;</span> top) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_curr <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span>    fp_curr <span style="color:#f92672">=</span> (uint64) <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(fp_curr <span style="color:#f92672">-</span> <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img alt="addr2line.png" loading="lazy" src="/xv6/lab4/addr2line.png"></p>
<ul>
<li>最後加到 <code>panic()</code> 中</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">panic</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">backtrace</span>();
</span></span><span style="display:flex;"><span>  pr.locking <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;panic: &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(s);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  panicked <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// freeze uart output from other CPUs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(;;)
</span></span><span style="display:flex;"><span>    ;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="alarm-hard">Alarm (hard)<a hidden class="anchor" aria-hidden="true" href="#alarm-hard">#</a></h2>
<blockquote>
<p>In this exercise you&rsquo;ll add a feature to xv6 that periodically alerts a process as it uses CPU time. This might be useful for compute-bound processes that want to limit how much CPU time they chew up, or for processes that want to compute but also want to take some periodic action. More generally, you&rsquo;ll be implementing a primitive form of user-level interrupt/fault handlers; you could use something similar to handle page faults in the application, for example. Your solution is correct if it passes <code>alarmtest</code> and <code>usertests -q</code>.</p></blockquote>
<p>這個 lab 要我們計算 cpu 的時間</p>
<p><code>sigalarm(interval, handler)</code> 的作用在於經過 <code>interval</code> 個 ticks 之後，就執行 <code>handler()</code>，例如 <code>sigalarm(2, periodic)</code> 就是經過 2 個 ticks 就執行一次 <code>periodic()</code></p>
<p>在 <code>test0</code> 中，</p>
<h3 id="test0-invoke-handler">test0: invoke handler<a hidden class="anchor" aria-hidden="true" href="#test0-invoke-handler">#</a></h3>
<ul>
<li>add <code>user/alarmtest.c</code> to <code>Makefile</code></li>
<li>add system call <code>sigalarm(n, fn)</code> and <code>sigalarm()</code>
<ul>
<li><code>user/user.h</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sigalarm</span>(<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>handler)());
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sigreturn</span>(<span style="color:#66d9ef">void</span>);
</span></span></code></pre></div></li>
<li><code>user/usys.pl</code></li>
<li><code>kernel/syscall.h</code></li>
<li><code>user/usys.pl</code></li>
</ul>
</li>
</ul>
<blockquote>
<ul>
<li>Your <code>sys_sigalarm()</code> should store the alarm interval and the pointer to the handler function in new fields in the <code>proc</code> structure (in <code>kernel/proc.h</code>).</li>
</ul></blockquote>
<ul>
<li><code>kernel/proc.h</code></li>
</ul>
<blockquote>
<ul>
<li>You&rsquo;ll need to keep track of how many ticks have passed since the last call (or are left until the next call) to a process&rsquo;s alarm handler; you&rsquo;ll need a new field in <code>struct proc</code> for this too. You can initialize <code>proc</code> fields in <code>allocproc()</code> in <code>proc.c</code>.</li>
</ul></blockquote>
<ul>
<li><code>kernel/proc.h</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> proc {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> interval;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> ticks_since_handler;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>handler)(<span style="color:#66d9ef">void</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li><code>kernel/proc.c</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> proc<span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">allocproc</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>interval <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>ticks_since_handler <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>handler <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Set up new context to start executing at forkret,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// which returns to user space.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>context, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(p<span style="color:#f92672">-&gt;</span>context));
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>context.ra <span style="color:#f92672">=</span> (uint64)forkret;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>context.sp <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>kstack <span style="color:#f92672">+</span> PGSIZE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> p;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>Every tick, the hardware clock forces an interrupt, which is handled in <code>usertrap()</code> in <code>kernel/trap.c</code>.</p></blockquote>
<ul>
<li><code>kernel/trap.c</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">clockintr</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>  ticks<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">wakeup</span>(<span style="color:#f92672">&amp;</span>ticks);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>You only want to manipulate a process&rsquo;s alarm ticks if there&rsquo;s a timer interrupt; you want something like</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(which_dev <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) ...
</span></span></code></pre></div></blockquote>
<ul>
<li><code>kernel/trap.c</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">usertrap</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// give up the CPU if this is a timer interrupt.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(which_dev <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">yield</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">usertrapret</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>原本是長這個樣子，意思是說如果遇到 timer interrupt 則 <code>yeild()</code>，現在則要多考慮 ticks 的問題</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">usertrap</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// give up the CPU if this is a timer interrupt.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(which_dev <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>interval <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>ticks_since_handler<span style="color:#f92672">++</span> <span style="color:#f92672">&gt;</span> p<span style="color:#f92672">-&gt;</span>interval) {
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>ticks_since_handler <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      } 
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">yield</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">usertrapret</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>Only invoke the alarm function if the process has a timer outstanding. Note that the address of the user&rsquo;s alarm function might be 0 (e.g., in <code>user/alarmtest.asm</code>, periodic is at address 0).</p></blockquote>
<blockquote>
<p>You&rsquo;ll need to modify <code>usertrap()</code> so that when a process&rsquo;s alarm interval expires, the user process executes the handler function. When a trap on the RISC-V returns to user space, what determines the instruction address at which user-space code resumes execution?</p></blockquote>
<p>這裡直接把 program counter 指到 <code>p-&gt;handler</code>, 回到 user space 之後，讓他進入 <code>handler()</code> 執行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">usertrap</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// give up the CPU if this is a timer interrupt.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(which_dev <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>interval <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>ticks_since_handler<span style="color:#f92672">++</span> <span style="color:#f92672">&gt;</span> p<span style="color:#f92672">-&gt;</span>interval) {
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>ticks_since_handler <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>trapframp<span style="color:#f92672">-&gt;</span>epc <span style="color:#f92672">=</span> (uint64) p<span style="color:#f92672">-&gt;</span>handler;
</span></span><span style="display:flex;"><span>      } 
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">yield</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">usertrapret</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>It will be easier to look at traps with gdb if you tell qemu to use only one CPU, which you can do by running</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>make CPUS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> qemu-gdb
</span></span></code></pre></div></blockquote>
<blockquote>
<p>You&rsquo;ve succeeded if alarmtest prints &ldquo;alarm!&rdquo;.</p></blockquote>
<p><img alt="test0-pass.png" loading="lazy" src="/xv6/lab4/test0-pass.png"></p>
<h3 id="test1test2test3-resume-interrupted-code">test1/test2()/test3(): resume interrupted code<a hidden class="anchor" aria-hidden="true" href="#test1test2test3-resume-interrupted-code">#</a></h3>
<blockquote>
<p>Chances are that alarmtest crashes in test0 or test1 after it prints &ldquo;alarm!&rdquo;, or that alarmtest (eventually) prints &ldquo;test1 failed&rdquo;, or that alarmtest exits without printing &ldquo;test1 passed&rdquo;. To fix this, you must ensure that, when the alarm handler is done, control returns to the instruction at which the user program was originally interrupted by the timer interrupt. You must ensure that the register contents are restored to the values they held at the time of the interrupt, so that the user program can continue undisturbed after the alarm. Finally, you should &ldquo;re-arm&rdquo; the alarm counter after each time it goes off, so that the handler is called periodically.</p></blockquote>
<p>目前的版本中，只有到 <code>test0</code> 之後就停下來了，這裡的問題在於這裡在 <code>handler</code> 結束之後，<code>alarmtest</code> 並沒有回覆到原先的狀態，整個 registers 的內容都被 <code>handler</code> 打亂了，理想的狀態是在 <code>hadnler</code> 結束之後，<code>alarmtest</code> 的所有 register 都復原到原先進入 <code>handler</code> 之前的樣子。</p>
<blockquote>
<p>As a starting point, we&rsquo;ve made a design decision for you: user alarm handlers are required to call the sigreturn system call when they have finished. Have a look at <code>periodic</code> in <code>alarmtest.c</code> for an example. This means that you can add code to <code>usertrap</code> and <code>sys_sigreturn</code> that cooperate to cause the user process to resume properly after it has handled the alarm.</p></blockquote>
<p>這裡說明這裡可以設計為 alarm handlers 在 return 之前必須要呼叫 <code>sigreturn()</code>，像是這樣：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">periodic</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  count <span style="color:#f92672">=</span> count <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;alarm!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sigreturn</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接下來的任務就在於：</p>
<ol>
<li>想辦法在進入 <code>handler</code> 之前保留 registers</li>
<li>想辦法在 <code>sigreturn()</code> 把之前保留的 registers restore 回去</li>
</ol>
<blockquote>
<p>Your solution will require you to save and restore registers&mdash;what registers do you need to save and restore to resume the interrupted code correctly? (Hint: it will be many).
這裡會是所有的 register，不論事 callee saved or caller saved 因為度 user program 而言，他根本就不會知道自己即將要進入 <code>handler</code>，所以是所有 32 registers</p></blockquote>
<ul>
<li><code>kernel/proc.h</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> trapframe {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/*   0 */</span> uint64 kernel_satp;   <span style="color:#75715e">// kernel page table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">/*   8 */</span> uint64 kernel_sp;     <span style="color:#75715e">// top of process&#39;s kernel stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">/*  16 */</span> uint64 kernel_trap;   <span style="color:#75715e">// usertrap()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">/*  24 */</span> uint64 epc;           <span style="color:#75715e">// saved user program counter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">/*  32 */</span> uint64 kernel_hartid; <span style="color:#75715e">// saved kernel tp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">/*  40 */</span> uint64 ra;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/*  48 */</span> uint64 sp;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/*  56 */</span> uint64 gp;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/*  64 */</span> uint64 tp;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/*  72 */</span> uint64 t0;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/*  80 */</span> uint64 t1;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/*  88 */</span> uint64 t2;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/*  96 */</span> uint64 s0;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 104 */</span> uint64 s1;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 112 */</span> uint64 a0;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 120 */</span> uint64 a1;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 128 */</span> uint64 a2;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 136 */</span> uint64 a3;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 144 */</span> uint64 a4;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 152 */</span> uint64 a5;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 160 */</span> uint64 a6;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 168 */</span> uint64 a7;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 176 */</span> uint64 s2;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 184 */</span> uint64 s3;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 192 */</span> uint64 s4;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 200 */</span> uint64 s5;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 208 */</span> uint64 s6;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 216 */</span> uint64 s7;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 224 */</span> uint64 s8;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 232 */</span> uint64 s9;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 240 */</span> uint64 s10;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 248 */</span> uint64 s11;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 256 */</span> uint64 t3;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 264 */</span> uint64 t4;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 272 */</span> uint64 t5;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* 280 */</span> uint64 t6;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>這所有都要 restore 回去</p>
<blockquote>
<p>Have <code>usertrap</code> save enough state in <code>struct proc</code> when the timer goes off that <code>sigreturn</code> can correctly return to the interrupted user code.</p></blockquote>
<blockquote>
<p>Prevent re-entrant calls to the handler&mdash;-if a handler hasn&rsquo;t returned yet, the kernel shouldn&rsquo;t call it again. <code>test2</code> tests this.
這裡也要防止進入 <code>handler</code> 的時候，又再次觸發 alarm，這裡立一個 flag 判斷就行了</p></blockquote>
<blockquote>
<p>Make sure to restore <code>a0</code>. <code>sigreturn</code> is a system call, and its return value is stored in <code>a0</code>.</p></blockquote>
<ul>
<li><code>kernel/proc.h</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> proc {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> trapframe <span style="color:#f92672">*</span>alarmframe;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> interval;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> ticks_since_handler;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>handler)(<span style="color:#66d9ef">void</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> alarm_state;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li><code>kernel/proc.c: allocproc()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> proc<span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">allocproc</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// Allocate a trapframe page.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>((p<span style="color:#f92672">-&gt;</span>trapframe <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> trapframe <span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">freeproc</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Allocate a alarmframe page.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>((p<span style="color:#f92672">-&gt;</span>alarmframe <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> trapframe <span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">freeproc</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>interval <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>ticks_since_handler <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>handler <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarm_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Set up new context to start executing at forkret,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// which returns to user space.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>context, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(p<span style="color:#f92672">-&gt;</span>context));
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>context.ra <span style="color:#f92672">=</span> (uint64)forkret;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>context.sp <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>kstack <span style="color:#f92672">+</span> PGSIZE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> p;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>kernel/proc.c: freeproc()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">freeproc</span>(<span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>trapframe)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)p<span style="color:#f92672">-&gt;</span>trapframe);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>trapframe <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// add for alarmframe
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>alarmframe)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)p<span style="color:#f92672">-&gt;</span>alarmframe);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarmframe <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>pagetable)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">proc_freepagetable</span>(p<span style="color:#f92672">-&gt;</span>pagetable, p<span style="color:#f92672">-&gt;</span>sz);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>pagetable <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>pid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>parent <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>name[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>chan <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>killed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>xstate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> UNUSED;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// add these
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>interval <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>ticks_since_handler <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>handler <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarm_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>kernel/sysproc.c</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_sigalarm</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> interval;
</span></span><span style="display:flex;"><span>  uint64 handler;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>interval);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argaddr</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>handler);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>interval <span style="color:#f92672">=</span> interval;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>handler <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> ((<span style="color:#f92672">*</span>)(<span style="color:#66d9ef">void</span>))) handler;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_sigreturn</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>trapframe <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>alarmframe;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>alarm_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> p<span style="color:#f92672">-&gt;</span>trapframe<span style="color:#f92672">-&gt;</span>a0;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>kernel/trap.c</code>: 加上判斷 <code>alarm_state</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">usertrap</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// give up the CPU if this is a timer interrupt.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(which_dev <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>interval <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>ticks_since_handler<span style="color:#f92672">++</span> <span style="color:#f92672">&gt;</span> p<span style="color:#f92672">-&gt;</span>interval <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>p<span style="color:#f92672">-&gt;</span>alarm_state) {
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>ticks_since_handler <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>alarmframe <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>p<span style="color:#f92672">-&gt;</span>trapframe; <span style="color:#75715e">// save all the registers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        p<span style="color:#f92672">-&gt;</span>trapframe<span style="color:#f92672">-&gt;</span>epc <span style="color:#f92672">=</span> (uint64) p<span style="color:#f92672">-&gt;</span>handler;
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>alarm_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      } 
</span></span><span style="display:flex;"><span>    }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">yield</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">usertrapret</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img alt="alarm-pass.png" loading="lazy" src="/xv6/lab4/alarm-pass.png">
<img alt="pass.png" loading="lazy" src="/xv6/lab4/pass.png"></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/xv6/gdb/">
    <span class="title">« Prev</span>
    <br>
    <span>[xv6 學習紀錄 04-2] 如何使用 gdb 追蹤 xv6 的 system call 過程</span>
  </a>
  <a class="next" href="http://localhost:1313/xv6/lab5.1/">
    <span class="title">Next »</span>
    <br>
    <span>[xv6 學習紀錄 05-1] Page Fault</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Yama&#39;s Trail</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

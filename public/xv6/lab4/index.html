<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>[xv6 學習紀錄 04] Lab: Traps | Yama&#39;s Trail</title>
<meta name="keywords" content="">
<meta name="description" content="Lab 連結: lab traps
課程影片連結：

6.S081 Fall 2020 Lecture 5: RISC-V Calling Convention and Stack Frames 
6.S081 Fall 2020 Lecture 6: Isolation &amp; System Call Entry/Exit

Lecture 5: RISC-V Calling Convention and Stack Frames
What is a user process?
layout asm
layout src
focus reg
focus asm
si
info breakpoints
b sum_to
RISC-V assembly (easy)

It will be important to understand a bit of RISC-V assembly, which you were exposed to in 6.1910 (6.004). There is a file user/call.c in your xv6 repo. make fs.img compiles it and also produces a readable assembly version of the program in user/call.asm.
Read the code in call.asm for the functions g, f, and main. The instruction manual for RISC-V is on the reference page. Here are some questions that you should answer (store the answers in a file answers-traps.txt):">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/xv6/lab4/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e1f5c4cae44599655f7ff95195ff89c8cb3adbda94f2b1581a434ab2b4d4e6cf.css" integrity="sha256-4fXEyuRFmWVff/lRlf&#43;JyMs629qU8rFYGkNKsrTU5s8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon_io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon_io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon_io/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon_io/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/xv6/lab4/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Yama&#39;s Trail (Alt + H)">Yama&#39;s Trail</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/dev-log/" title="這個網站的誕生">
                    <span>這個網站的誕生</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/leetcode/" title="LeetCode 解題">
                    <span>LeetCode 解題</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xv6/" title="xv6 學習紀錄">
                    <span>xv6 學習紀錄</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      [xv6 學習紀錄 04] Lab: Traps
    </h1>
    <div class="post-meta"><span title='2025-10-09 11:31:37 +0800 CST'>October 9, 2025</span>

</div>
  </header> 
  <div class="post-content"><p>Lab 連結: <a href="https://pdos.csail.mit.edu/6.S081/2022/labs/traps.html">lab traps</a></p>
<p>課程影片連結：</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=s-Z5t_yTyTM">6.S081 Fall 2020 Lecture 5: RISC-V Calling Convention and Stack Frames </a></li>
<li><a href="https://www.youtube.com/watch?v=T26UuauaxWA">6.S081 Fall 2020 Lecture 6: Isolation &amp; System Call Entry/Exit</a></li>
</ul>
<h2 id="lecture-5-risc-v-calling-convention-and-stack-frames">Lecture 5: RISC-V Calling Convention and Stack Frames<a hidden class="anchor" aria-hidden="true" href="#lecture-5-risc-v-calling-convention-and-stack-frames">#</a></h2>
<p>What is a user process?
<code>layout asm</code>
<code>layout src</code>
focus reg
focus asm
si
info breakpoints
b sum_to</p>
<h2 id="risc-v-assembly-easy">RISC-V assembly (easy)<a hidden class="anchor" aria-hidden="true" href="#risc-v-assembly-easy">#</a></h2>
<blockquote>
<p>It will be important to understand a bit of RISC-V assembly, which you were exposed to in 6.1910 (6.004). There is a file <code>user/call.c</code> in your xv6 repo. <code>make fs.img</code> compiles it and also produces a readable assembly version of the program in <code>user/call.asm</code>.
Read the code in <code>call.asm</code> for the functions <code>g</code>, <code>f</code>, and <code>main</code>. The instruction manual for RISC-V is on the reference page. Here are some questions that you should answer (store the answers in a file <code>answers-traps.txt</code>):</p></blockquote>
<p>這題要我們閱讀 <code>user/call.c</code> 對應的 <code>call.asm</code> 確保我們對於 C 語言到 RISC-V 的轉換是有概念的，我們需要回答以下問題：</p>
<blockquote>
<p>Which registers contain arguments to functions? For example, which register holds 13 in main&rsquo;s call to <code>printf</code>?</p></blockquote>
<p>arguments 是存放於 <code>a0</code>, <code>a1</code>, <code>a2</code> &hellip; 例如</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">f</span>(<span style="color:#ae81ff">8</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">13</span>);
</span></span></code></pre></div><p><code>13</code> 是第 3 個 argument, 存放於 <code>a2</code>，在 <code>call.asm</code> 中也可以看到</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#960050;background-color:#1e0010">&#34;</span>%d %d<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">n</span><span style="color:#960050;background-color:#1e0010">&#34;</span>, <span style="color:#66d9ef">f</span>(<span style="color:#ae81ff">8</span>)<span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">13</span>)<span style="color:#75715e">;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">24:</span>	<span style="color:#960050;background-color:#1e0010">4635</span>                	<span style="color:#a6e22e">li</span>	<span style="color:#66d9ef">a2</span>,<span style="color:#ae81ff">13</span> <span style="color:#75715e"># &lt;-- put value 13 to a2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">26:</span>	<span style="color:#960050;background-color:#1e0010">45</span><span style="color:#a6e22e">b1</span>                	<span style="color:#66d9ef">li</span>	<span style="color:#66d9ef">a1</span>,<span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">28:</span>	<span style="color:#960050;background-color:#1e0010">00000517</span>          	<span style="color:#a6e22e">auipc</span>	<span style="color:#66d9ef">a0</span>,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">2</span>c:	<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">b850513</span>          	<span style="color:#66d9ef">addi</span>	<span style="color:#66d9ef">a0</span>,<span style="color:#66d9ef">a0</span>,<span style="color:#ae81ff">1976</span> <span style="color:#75715e"># 7e0 &lt;malloc+0xe6&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">30:</span>	<span style="color:#960050;background-color:#1e0010">00000097</span>          	<span style="color:#a6e22e">auipc</span>	<span style="color:#66d9ef">ra</span>,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">34:</span>	<span style="color:#960050;background-color:#1e0010">612080</span><span style="color:#a6e22e">e7</span>          	<span style="color:#66d9ef">jalr</span>	<span style="color:#ae81ff">1554</span>(<span style="color:#66d9ef">ra</span>) <span style="color:#75715e"># 642 &lt;printf&gt;
</span></span></span></code></pre></div><blockquote>
<p>Where is the call to function <code>f</code> in the assembly code for <code>main</code>? Where is the call to <code>g</code>? (Hint: the compiler may inline functions.)</p></blockquote>
<ul>
<li><code>user/call.c</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">g</span>(<span style="color:#66d9ef">int</span> x) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> x<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">f</span>(<span style="color:#66d9ef">int</span> x) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">g</span>(x);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">f</span>(<span style="color:#ae81ff">8</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">13</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>就以 <code>user/call.c</code> 來說，<code>f()</code> 只是呼叫 <code>g()</code>, <code>g()</code> 的作用只是回傳 <code>x + 3</code>，在 <code>call.asm</code> 中，可以看到 compiler 直接把 <code>f(8)+1</code> 的答案 <code>12</code> 算出來並且寫死丟入 <code>f(8)+1</code> 所代表的第 2 個 argument <code>a1</code> 中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">void</span> <span style="color:#66d9ef">main</span>(<span style="color:#66d9ef">void</span>) <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">1</span>c:	<span style="color:#960050;background-color:#1e0010">1141</span>                	<span style="color:#a6e22e">addi</span>	<span style="color:#66d9ef">sp</span>,<span style="color:#66d9ef">sp</span>,-<span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">1</span>e:	<span style="color:#a6e22e">e406</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">ra</span>,<span style="color:#ae81ff">8</span>(<span style="color:#66d9ef">sp</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">20:</span>	<span style="color:#a6e22e">e022</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">s0</span>,<span style="color:#ae81ff">0</span>(<span style="color:#66d9ef">sp</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">22:</span>	<span style="color:#960050;background-color:#1e0010">0800</span>                	<span style="color:#a6e22e">addi</span>	<span style="color:#66d9ef">s0</span>,<span style="color:#66d9ef">sp</span>,<span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#960050;background-color:#1e0010">&#34;</span>%d %d<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">n</span><span style="color:#960050;background-color:#1e0010">&#34;</span>, <span style="color:#66d9ef">f</span>(<span style="color:#ae81ff">8</span>)<span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">13</span>)<span style="color:#75715e">;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">24:</span>	<span style="color:#960050;background-color:#1e0010">4635</span>                	<span style="color:#a6e22e">li</span>	<span style="color:#66d9ef">a2</span>,<span style="color:#ae81ff">13</span> <span style="color:#75715e"># &lt;-- call to f and call to g
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">26:</span>	<span style="color:#960050;background-color:#1e0010">45</span><span style="color:#a6e22e">b1</span>                	<span style="color:#66d9ef">li</span>	<span style="color:#66d9ef">a1</span>,<span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">28:</span>	<span style="color:#960050;background-color:#1e0010">00000517</span>          	<span style="color:#a6e22e">auipc</span>	<span style="color:#66d9ef">a0</span>,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">2</span>c:	<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">b850513</span>          	<span style="color:#66d9ef">addi</span>	<span style="color:#66d9ef">a0</span>,<span style="color:#66d9ef">a0</span>,<span style="color:#ae81ff">1976</span> <span style="color:#75715e"># 7e0 &lt;malloc+0xe6&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">30:</span>	<span style="color:#960050;background-color:#1e0010">00000097</span>          	<span style="color:#a6e22e">auipc</span>	<span style="color:#66d9ef">ra</span>,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">34:</span>	<span style="color:#960050;background-color:#1e0010">612080</span><span style="color:#a6e22e">e7</span>          	<span style="color:#66d9ef">jalr</span>	<span style="color:#ae81ff">1554</span>(<span style="color:#66d9ef">ra</span>) <span style="color:#75715e"># 642 &lt;printf&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>)<span style="color:#75715e">;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#960050;background-color:#1e0010">38:</span>	<span style="color:#960050;background-color:#1e0010">4501</span>                	<span style="color:#a6e22e">li</span>	<span style="color:#66d9ef">a0</span>,<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">3</span>a:	<span style="color:#960050;background-color:#1e0010">00000097</span>          	<span style="color:#a6e22e">auipc</span>	<span style="color:#66d9ef">ra</span>,<span style="color:#ae81ff">0x0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">3</span>e:	<span style="color:#960050;background-color:#1e0010">28</span><span style="color:#a6e22e">e080e7</span>          	<span style="color:#66d9ef">jalr</span>	<span style="color:#ae81ff">654</span>(<span style="color:#66d9ef">ra</span>) <span style="color:#75715e"># 2c8 &lt;exit&gt;
</span></span></span></code></pre></div><blockquote>
<p>At what address is the function <code>printf</code> located?</p></blockquote>
<p>根據</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">34:</span>	<span style="color:#960050;background-color:#1e0010">612080</span><span style="color:#a6e22e">e7</span>          	<span style="color:#66d9ef">jalr</span>	<span style="color:#ae81ff">1554</span>(<span style="color:#66d9ef">ra</span>) <span style="color:#75715e"># 642 &lt;printf&gt;
</span></span></span></code></pre></div><p>可得知 <code>printf</code> 的 address 在 <code>642</code> 中，<code>jalr 1554(ra)</code> 做了一下兩件事</p>
<ul>
<li>jump 到 <code>printf</code></li>
<li>Link: saves the address of the next instruction</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> *<span style="color:#66d9ef">fmt</span>, <span style="color:#66d9ef">...</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">642:</span>	<span style="color:#960050;background-color:#1e0010">711</span><span style="color:#a6e22e">d</span>                	<span style="color:#66d9ef">addi</span>	<span style="color:#66d9ef">sp</span>,<span style="color:#66d9ef">sp</span>,-<span style="color:#ae81ff">96</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">644:</span>	<span style="color:#a6e22e">ec06</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">ra</span>,<span style="color:#ae81ff">24</span>(<span style="color:#66d9ef">sp</span>)
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">646:</span>	<span style="color:#a6e22e">e822</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">s0</span>,<span style="color:#ae81ff">16</span>(<span style="color:#66d9ef">sp</span>)
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">648:</span>	<span style="color:#960050;background-color:#1e0010">1000</span>                	<span style="color:#a6e22e">addi</span>	<span style="color:#66d9ef">s0</span>,<span style="color:#66d9ef">sp</span>,<span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">64</span>a:	<span style="color:#a6e22e">e40c</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">a1</span>,<span style="color:#ae81ff">8</span>(<span style="color:#66d9ef">s0</span>)
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">64</span>c:	<span style="color:#a6e22e">e810</span>                	<span style="color:#66d9ef">sd</span>	<span style="color:#66d9ef">a2</span>,<span style="color:#ae81ff">16</span>(<span style="color:#66d9ef">s0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">...</span>
</span></span></code></pre></div><p>也可以在這裡的 <code>642</code> 中看到</p>
<blockquote>
<p>What value is in the register <code>ra</code> just after the <code>jalr</code> to <code>printf</code> in <code>main</code>?</p></blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>Run the following code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x00646c72</span>;
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;H%x Wo%s&#34;</span>, <span style="color:#ae81ff">57616</span>, <span style="color:#f92672">&amp;</span>i);
</span></span></code></pre></div><p>What is the output? Here&rsquo;s an ASCII table that maps bytes to characters.</p>
<p>The output depends on that fact that the RISC-V is little-endian. If the RISC-V were instead big-endian what would you set <code>i</code> to in order to yield the same output? Would you need to change <code>57616</code> to a different value?</p>
<p>Here&rsquo;s a description of little- and big-endian and a more whimsical description.</p></blockquote>
<blockquote>
<p>In the following code, what is going to be printed after <code>'y='</code>? (note: the answer is not a specific value.) Why does this happen?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;x=%d y=%d&#34;</span>, <span style="color:#ae81ff">3</span>);
</span></span></code></pre></div></blockquote>
<h2 id="backtrace-moderate">Backtrace (moderate)<a hidden class="anchor" aria-hidden="true" href="#backtrace-moderate">#</a></h2>
<blockquote>
<p>Implement a <code>backtrace()</code> function in <code>kernel/printf.c</code>. Insert a call to this function in <code>sys_sleep</code>, and then run bttest, which calls <code>sys_sleep</code>. Your output should be a list of return addresses with this form (but the numbers will likely be different):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>    backtrace:
</span></span><span style="display:flex;"><span>    0x0000000080002cda
</span></span><span style="display:flex;"><span>    0x0000000080002bb6
</span></span><span style="display:flex;"><span>    0x0000000080002898
</span></span></code></pre></div><p>After <code>bttest</code> exit qemu. In a terminal window: run <code>addr2line -e kernel/kernel</code> (or <code>riscv64-unknown-elf-addr2line -e kernel/kernel</code>) and cut-and-paste the addresses from your backtrace, like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>    $ addr2line -e kernel/kernel
</span></span><span style="display:flex;"><span>    0x0000000080002de2
</span></span><span style="display:flex;"><span>    0x0000000080002f4a
</span></span><span style="display:flex;"><span>    0x0000000080002bfc
</span></span><span style="display:flex;"><span>    Ctrl-D
</span></span></code></pre></div><p>You should see something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>    kernel/sysproc.c:74
</span></span><span style="display:flex;"><span>    kernel/syscall.c:224
</span></span><span style="display:flex;"><span>    kernel/trap.c:85
</span></span></code></pre></div></blockquote>
<p>我們需要先了解 xv6 的 stack 長什麼樣子才有辦法解這一題</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>                   .
</span></span><span style="display:flex;"><span>                   .
</span></span><span style="display:flex;"><span>      +-&gt;          .
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      |   |   previous fp ------+
</span></span><span style="display:flex;"><span>      |   | saved registers |
</span></span><span style="display:flex;"><span>      |   | local variables |
</span></span><span style="display:flex;"><span>      |   |       ...       | &lt;-+
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      +------ previous fp   |   |
</span></span><span style="display:flex;"><span>          | saved registers |   |
</span></span><span style="display:flex;"><span>          | local variables |   |
</span></span><span style="display:flex;"><span>      +-&gt; |       ...       |   |
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      |   |   previous fp ------+
</span></span><span style="display:flex;"><span>      |   | saved registers |
</span></span><span style="display:flex;"><span>      |   | local variables |
</span></span><span style="display:flex;"><span>      |   |       ...       | &lt;-+
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      +------ previous fp   |   |
</span></span><span style="display:flex;"><span>          | saved registers |   |
</span></span><span style="display:flex;"><span>          | local variables |   |
</span></span><span style="display:flex;"><span>  $fp --&gt; |       ...       |   |
</span></span><span style="display:flex;"><span>          +-----------------+   |
</span></span><span style="display:flex;"><span>          | return address  |   |
</span></span><span style="display:flex;"><span>          |   previous fp ------+
</span></span><span style="display:flex;"><span>          | saved registers |
</span></span><span style="display:flex;"><span>  $sp --&gt; | local variables |
</span></span><span style="display:flex;"><span>          +-----------------+
</span></span></code></pre></div><p>從這裡可以看到，理論上我們可以從 <code>sp</code> 開始，一次一次的利用 <code>fp</code> 往上找尋前一個 frame，就可以達成題目要的 <code>backtrace</code></p>
<h2 id="alarm-hard">Alarm (hard)<a hidden class="anchor" aria-hidden="true" href="#alarm-hard">#</a></h2>
<blockquote>
<p>In this exercise you&rsquo;ll add a feature to xv6 that periodically alerts a process as it uses CPU time. This might be useful for compute-bound processes that want to limit how much CPU time they chew up, or for processes that want to compute but also want to take some periodic action. More generally, you&rsquo;ll be implementing a primitive form of user-level interrupt/fault handlers; you could use something similar to handle page faults in the application, for example. Your solution is correct if it passes <code>alarmtest</code> and <code>usertests -q</code>.
這個 lab 要我們計算 cpu 的時間</p></blockquote>
<hr>
<h1 id="lab4-traps-紀錄">Lab4 Traps: 紀錄<a hidden class="anchor" aria-hidden="true" href="#lab4-traps-紀錄">#</a></h1>
<p><a href="https://pdos.csail.mit.edu/6.S081/2022/labs/traps.html">lab: Traps</a></p>
<h2 id="一些跟這個-lab-有關的-register">一些跟這個 lab 有關的 register<a hidden class="anchor" aria-hidden="true" href="#一些跟這個-lab-有關的-register">#</a></h2>
<p><img alt="Table 4.2" loading="lazy">
<img alt="Table 3.7" loading="lazy">
<img alt="Figure 4.12" loading="lazy"></p>
<h2 id="程式碼解析">程式碼解析<a hidden class="anchor" aria-hidden="true" href="#程式碼解析">#</a></h2>
<h4 id="yeild"><code>yeild()</code><a hidden class="anchor" aria-hidden="true" href="#yeild">#</a></h4>
<p><code>yeild()</code> 讓 <code>myproc()</code> 的 state 變成 <code>RUNNABLE</code>
並且呼叫 <code>sched()</code>，<code>sched()</code> 可以讓其他 function 也有機會可以被執行到
<code>yeild()</code> 想要做的事情是:
&ldquo;我用 CPU 用夠久了，可以換其他人使用了&rdquo;
所謂的 &ldquo;換其他人使用&rdquo; 也就是呼叫 <code>sched()</code>，它會幫我們處理</p>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">// Give up the CPU for one scheduling round.
void
yield(void)
{
  struct proc *p = myproc();
  acquire(&amp;p-&gt;lock);
  p-&gt;state = RUNNABLE;
  sched();
  release(&amp;p-&gt;lock);
}
</code></pre><h4 id="sched-解析"><code>sched()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#sched-解析">#</a></h4>
<p><code>sched()</code> 只會被以下幾個情境被使用到:</p>
<ul>
<li><code>exit()</code></li>
<li><code>yeild()</code></li>
<li><code>sleep()</code>
從這裡我們可以發現，這都是在一些 &ldquo;該輪到別人使用 CPU 了&rdquo; 的時間點
所以可以推測 <code>sched()</code> 是用來決定下一個使用 CPU 的人是誰
不過讓我比較意外地點是，<code>scheduler()</code> 並沒有呼叫到 <code>sched()</code>，
那麼 <code>scheduler()</code> 到底扮演了什麼樣的角色呢</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Switch to scheduler.  Must hold only p-&gt;lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// and have changed proc-&gt;state. Saves and restores
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// intena because intena is a property of this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// kernel thread, not this CPU. It should
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// be proc-&gt;intena and proc-&gt;noff, but that would
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// break in the few places where a lock is held but
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// there&#39;s no process.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sched</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> intena;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">holding</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock)) <span style="color:#75715e">// 我應該要 hold 我自己的 lock
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;sched p-&gt;lock&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mycpu</span>()<span style="color:#f92672">-&gt;</span>noff <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>) <span style="color:#75715e">// TODO: why noff should be equals to 1 ?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;sched locks&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">==</span> RUNNING) <span style="color:#75715e">// sched() 的 caller 會先把 myproc() 設為 RUNNABLE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;sched running&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">intr_get</span>()) <span style="color:#75715e">// TODO: learn sstatus first
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;sched interruptible&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  intena <span style="color:#f92672">=</span> <span style="color:#a6e22e">mycpu</span>()<span style="color:#f92672">-&gt;</span>intena; <span style="color:#75715e">// why?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">swtch</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>context, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">mycpu</span>()<span style="color:#f92672">-&gt;</span>context);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mycpu</span>()<span style="color:#f92672">-&gt;</span>intena <span style="color:#f92672">=</span> intena;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>幾個困惑的點</p>
<ul>
<li><code>swtch()</code> 實際上是如何運作的</li>
<li><code>mycpu()-&gt;context</code> 裡面到底裝著些什麼東西</li>
<li><code>mycpu()-&gt;context</code> 什麼時候會被初始化</li>
</ul>
<h4 id="devintr"><code>devintr()</code><a hidden class="anchor" aria-hidden="true" href="#devintr">#</a></h4>
<p>用來確認 interrupt 的種類
回傳值：
* 2 -&gt; timer interrupt
* 1 -&gt; 其他 device
* 0 -&gt; 認不出來</p>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">// check if it&#39;s an external interrupt or software interrupt,
// and handle it.
// returns 2 if timer interrupt,
// 1 if other device,
// 0 if not recognized.
int
devintr()
{
  uint64 scause = r_scause();

  if((scause &amp; 0x8000000000000000L) &amp;&amp;
     (scause &amp; 0xff) == 9){
    // this is a supervisor external interrupt, via PLIC.

    // irq indicates which device interrupted.
    int irq = plic_claim();

    if(irq == UART0_IRQ){
      uartintr();
    } else if(irq == VIRTIO0_IRQ){
      virtio_disk_intr();
    } else if(irq){
      printf(&#34;unexpected interrupt irq=%d\n&#34;, irq);
    }

    // the PLIC allows each device to raise at most one
    // interrupt at a time; tell the PLIC the device is
    // now allowed to interrupt again.
    if(irq)
      plic_complete(irq);

    return 1;
  } else if(scause == 0x8000000000000001L){
    // software interrupt from a machine-mode timer interrupt,
    // forwarded by timervec in kernelvec.S.

    if(cpuid() == 0){
      clockintr();
    }
    
    // acknowledge the software interrupt by clearing
    // the SSIP bit in sip.
    w_sip(r_sip() &amp; ~2);

    return 2;
  } else {
    return 0;
  }
}
</code></pre><ul>
<li><code>usertrap()</code> 跟 <code>kerneltrap()</code> 的差別在哪裡?</li>
</ul>
<h3 id="platform-level-interrupt-controllerplic">Platform-Level Interrupt Controller(PLIC)<a hidden class="anchor" aria-hidden="true" href="#platform-level-interrupt-controllerplic">#</a></h3>
<h2 id="lab">Lab<a hidden class="anchor" aria-hidden="true" href="#lab">#</a></h2>
<h3 id="backtrace">Backtrace<a hidden class="anchor" aria-hidden="true" href="#backtrace">#</a></h3>
<p><strong>print the saved return address in each stack frame.</strong>
題目需求：
1. 在 <code>kernel/printf.c</code> 中實作出 <code>backtrace()</code>
2. 在 <code>sys_sleep</code> 呼叫 <code>backtrace()</code></p>
<ol>
<li>把 <code>backtrace()</code> 的原型加到 <code>kernel/defs.h</code></li>
</ol>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">void            backtrace(void);
</code></pre><h5 id="xv6-中的-stack">xv6 中的 stack:<a hidden class="anchor" aria-hidden="true" href="#xv6-中的-stack">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>                   .
</span></span><span style="display:flex;"><span>                   .
</span></span><span style="display:flex;"><span>      +-&gt;          .
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      |   |   previous fp ------+
</span></span><span style="display:flex;"><span>      |   | saved registers |
</span></span><span style="display:flex;"><span>      |   | local variables |
</span></span><span style="display:flex;"><span>      |   |       ...       | &lt;-+
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      +------ previous fp   |   |
</span></span><span style="display:flex;"><span>          | saved registers |   |
</span></span><span style="display:flex;"><span>          | local variables |   |
</span></span><span style="display:flex;"><span>      +-&gt; |       ...       |   |
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      |   |   previous fp ------+
</span></span><span style="display:flex;"><span>      |   | saved registers |
</span></span><span style="display:flex;"><span>      |   | local variables |
</span></span><span style="display:flex;"><span>      |   |       ...       | &lt;-+
</span></span><span style="display:flex;"><span>      |   +-----------------+   |
</span></span><span style="display:flex;"><span>      |   | return address  |   |
</span></span><span style="display:flex;"><span>      +------ previous fp   |   |
</span></span><span style="display:flex;"><span>          | saved registers |   |
</span></span><span style="display:flex;"><span>          | local variables |   |
</span></span><span style="display:flex;"><span>  $fp --&gt; |       ...       |   |
</span></span><span style="display:flex;"><span>          +-----------------+   |
</span></span><span style="display:flex;"><span>          | return address  |   |
</span></span><span style="display:flex;"><span>          |   previous fp ------+
</span></span><span style="display:flex;"><span>          | saved registers |
</span></span><span style="display:flex;"><span>  $sp --&gt; | local variables |
</span></span><span style="display:flex;"><span>          +-----------------+
</span></span></code></pre></div><ol>
<li>把以下內容加到 <code>kernel/riscv.h</code></li>
</ol>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">static inline uint64
r_fp()
{
  uint64 x;
  asm volatile(&#34;mv %0, s0&#34; : &#34;=r&#34; (x) );
  return x;

}
</code></pre><p><code>r_fp()</code> 可以讓我們拿到 fram pointer <code>fp</code> 的值
拿到 <code>fp</code> 之後，先 print 出來 <code>fp</code> 裡面到底放著什麼東西
這裡要注意一個很重要的特性(some hints 中有說明):
kernel stack 只會被塞在一個 page (4096 bytes) 中
我們可以用</p>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">void
backtrace(void)
{
  uint64 *cur_frame = (uint64 *)r_fp();
  printf(&#34;%p\n&#34;, *(cur_frame - 1));
}
</code></pre><pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">void
backtrace(void)
{
  void *cur_frame;
  void *bot;

  cur_frame = (void *)r_fp();
  bot = (void *) PGROUNDUP((uint64)cur_frame);
  while (cur_frame &lt; bot) {
    printf(&#34;%p\n&#34;, *((void **)cur_frame - 1));
    cur_frame = *((void **)cur_frame - 2);
  }
}
</code></pre><h3 id="alarm">Alarm<a hidden class="anchor" aria-hidden="true" href="#alarm">#</a></h3>
<ul>
<li>這裡的 tick 並不是拿來推動 cpu 的 tick，而應該是拿來當時鐘的 tick</li>
</ul>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">// Per-process state
struct proc {
  // ...

  // these are provided to handle SYS_sigalarm
  int ticks;                   // The number of ticks between alarm calls
  int ticks_since_alarm;       // Ticks since alarm
  void (*handler)();           // Called when alarm
};
</code></pre><p>在 <code>trap.c</code>: <code>usertrap()</code> 中實作</p>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">void
usertrap(void)
{
  // ...

  // give up the CPU if this is a timer interrupt.
  if(which_dev == 2) {
    if (p-&gt;ticks_since_alarm++ &gt; p-&gt;ticks) {
      // p-&gt;handler(); // TODO: why this error
      p-&gt;trapframe-&gt;epc = (uint64) p-&gt;handler;
    } else {
      yield();
    }
  }

  usertrapret();
}
</code></pre><ul>
<li>策略:
<ul>
<li>手上有的：每一個 tick <code>if(which_dev == 2)</code> 都會成立一次</li>
<li>題目要的：每一個 tick <code>if(which_dev == 2)</code> 都會成立一次</li>
<li>tick 的處理優先順序高於 <code>yield()</code></li>
<li>如果 handler 執行了，還要執行 <code>yield()</code> 嗎？
<ul>
<li>我個人認為，不用，因為執行 handler 就已經跟 <code>yield()</code> 有很類似的效果了</li>
</ul>
</li>
</ul>
</li>
<li>雖然每一個 process 都有 <code>ticks</code>, <code>ticks_since_alarm</code>, <code>handler</code> 但是這並不代表
每一個 process 都需要進行 alarm 的檢查
<ul>
<li>判斷的標準在於 <code>tick == 0</code> 則 alarm disable</li>
<li>對應到 <code>sigalarm(0, 0)</code> 會把 alarm disable</li>
</ul>
</li>
</ul>
<h4 id="為什麼不可以">為什麼不可以<a hidden class="anchor" aria-hidden="true" href="#為什麼不可以">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">usertrap</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// give up the CPU if this is a timer interrupt.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(which_dev <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>ticks_since_alarm<span style="color:#f92672">++</span> <span style="color:#f92672">&gt;</span> p<span style="color:#f92672">-&gt;</span>ticks) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// p-&gt;handler(); // TODO: why this error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      p<span style="color:#f92672">-&gt;</span>trapframe<span style="color:#f92672">-&gt;</span>epc <span style="color:#f92672">=</span> (uint64) p<span style="color:#f92672">-&gt;</span>handler;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">yield</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">usertrapret</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>
<p><code>p-&gt;handler</code> 使用了是 (pa/va)?</p>
</li>
<li>
<p><code>p-&gt;handler()</code> 實際上會做什麼事情</p>
</li>
<li>
<p><code>p-&gt;trapframe-&gt;epc = (uint64) p-&gt;handler</code> 實際上會做什麼事情?</p>
</li>
<li>
<p>想要回答上面的問題了話，必須要搞清楚以下的幾個問題</p>
<ul>
<li>在 usertrap() 中，正在使用的 page table 是哪一個
<ul>
<li>使用 kernel page table ，因為在 uservec 之後應該都是 kernel mode</li>
</ul>
</li>
<li>handler 所紀錄的 address 是 va/pa ? 用的是哪一個 page table
<ul>
<li>從 <code>user/alarmtest.c</code> 當中可以看到</li>
</ul>
</li>
<li>在 usertrap 中的這個當下，各個 register 的狀態如何
<ul>
<li>在 <code>uservec</code></li>
</ul>
</li>
<li><code>p-&gt;handler()</code> 實際上會做什麼事情
<ul>
<li>使用 gdb trace</li>
</ul>
</li>
<li><code>p-&gt;trapframe-&gt;epc = (uint64) p-&gt;handler</code> 實際上會做什麼事情?
<ul>
<li>使用 gdb trace</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="p-trapframe-epc--uint64-p-handler-實際上會做什麼事情"><code>p-&gt;trapframe-&gt;epc = (uint64) p-&gt;handler</code> 實際上會做什麼事情?<a hidden class="anchor" aria-hidden="true" href="#p-trapframe-epc--uint64-p-handler-實際上會做什麼事情">#</a></h3>
<ul>
<li>當 trap 的流程<strong>結束之後</strong> 會繼續根據 <code>epc</code> 的內容往下執行
<ul>
<li>太漂亮了!!</li>
</ul>
</li>
</ul>
<h3 id="p-handler-實際上會做什麼事情"><code>p-&gt;handler()</code> 實際上會做什麼事情<a hidden class="anchor" aria-hidden="true" href="#p-handler-實際上會做什麼事情">#</a></h3>
<p>這個會把 program counter 跑到 handler 的地方，
the key point is: is handler a va or pa</p>
<ul>
<li>should be a va that using page table of user program</li>
<li>in trap.c we are using kernel page table</li>
<li>this is why we can not <code>p-&gt;handler()</code></li>
</ul>
<h3 id="test1test2test3-resume-interrupted-code">test1/test2()/test3(): resume interrupted code<a hidden class="anchor" aria-hidden="true" href="#test1test2test3-resume-interrupted-code">#</a></h3>
<p>現在我缺少了什麼事情？
現在缺少了 <code>sigreturn()</code>
<code>handler()</code> 的最後面需要去呼叫 <code>sigreturn()</code> 像這樣：</p>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">void
periodic()
{
  count = count + 1;
  printf(&#34;alarm!\n&#34;);
  sigreturn(); // like this
}
</code></pre><p>問題:
當 handler 結束之後回到原本的 user program 會出錯
因為這不是正常的使用 call stack，而是在 usertrap() 中<strong>直接</strong>修改</p>
<p>所謂的一個 process 其實也就是由</p>
<ol>
<li>registers 的內容</li>
<li>一個 page table</li>
<li>放在 memory 的 instructions
所組成的</li>
</ol>
<p>也就是說在 <code>handler()</code> 之後我們需要還原以下一些東西:</p>
<ol>
<li>registers 的內容</li>
<li>把 <code>sapt</code> 指到屬於那個 user program 的地方</li>
</ol>
<p>我們該怎麼知道那些 registers 的值被放到哪裡？</p>
<ul>
<li>trap 發生時，在 <code>uservec</code> 中會把這些 register 的值放到 <code>struct proc</code> 的 trapfram 中</li>
<li>這個 user program 的位置存放在</li>
</ul>
<h3 id="在正常情況下是如何從-kernel-mode-回到-user-program">在正常情況下是如何從 kernel mode 回到 user program<a hidden class="anchor" aria-hidden="true" href="#在正常情況下是如何從-kernel-mode-回到-user-program">#</a></h3>
<p>應該是 userret 就會處理好
而現在的問題在於原本的 program counter(<code>sepc</code>) 在 usertrapret 被洗掉了
他被洗掉了，我們就完全找不回來的</p>
<p>原本的步驟為：</p>
<ul>
<li><code>uservec</code></li>
<li><code>userret</code></li>
</ul>
<p>題目的 hint:</p>
<ul>
<li>在 sigreturn() 中需要把 user program 的 registers 給復元回去
<ul>
<li>trapfram 中有做紀錄</li>
<li>問題在於原本的 sepc 被洗掉了</li>
<li>就像 lab pagetable 那樣新增一個 struct 去紀錄 alarm 需要紀錄的東西
<ul>
<li>目前應該只需要紀錄一個 program counter 的值就好</li>
</ul>
</li>
<li>也可以把<strong>所有的</strong> registers 都重新備一份
<ul>
<li>真的有這個必要嗎?</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="test3-failed-register-a0-changed">test3 failed: register a0 changed<a hidden class="anchor" aria-hidden="true" href="#test3-failed-register-a0-changed">#</a></h3>
<p>這裡來探討 <code>a0</code> 的旅程
0. 在 user program 中 <code>a0</code> 有一個值，可能是有用的，也可能是沒有在用的</p>
<ol>
<li>在 uservec 中
<ul>
<li>把 <code>a0</code> 的值存到 <code>sscratch</code> 中</li>
<li><code>a0</code> 用來存放 <code>TRAPFRAME</code></li>
<li>把 <code>a0</code> 的值從 <code>sscratch</code> 中拿回來</li>
<li>也應該把 <code>a0</code> 的值放到 <code>p-&gt;trampoline</code> 中</li>
</ul>
</li>
<li>接下來在 <code>sigreturn()</code> 應該會把 a0 放回去才對</li>
</ol>
<p>問題在於 <code>dummy_handler()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// dummy alarm handler; after running immediately uninstall
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// itself and finish signal handling
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dummy_handler</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sigalarm</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sigreturn</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>sigalarm(0, 0)</code> 會讓 alarm 關掉，關掉之後，就不會再一次的進入到
<code>dummy_handler()</code> 中了
那麼跟 a0 有什麼關係</p>
<p>請注意，test3() 的 <code>a0</code> 被改掉了</p>
<ul>
<li>應該是 <code>dummy_handler()</code> 有問題</li>
<li>也就是說 <code>sigreturn()</code> 沒有把 <code>a0</code> 搞定</li>
<li>也就是說 <code>sys_sigreturn()</code> 中 <code>p-&gt;alarmtrame</code> 中的 <code>a0</code> 是錯誤的</li>
<li>也就是說 <code>p-&gt;trapframe</code> 中的 <code>a0</code> 是錯誤的
<ul>
<li>我完全不這麼認為</li>
</ul>
</li>
<li>在某個地方 a0 變成了 0</li>
</ul>
<h2 id="todo">TODO<a hidden class="anchor" aria-hidden="true" href="#todo">#</a></h2>
<ul>
<li>再看一次影片</li>
<li>trapmpoline.S</li>
<li>using gdb</li>
</ul>
<h2 id="參考資料">參考資料<a hidden class="anchor" aria-hidden="true" href="#參考資料">#</a></h2>
<p><a href="https://pdos.csail.mit.edu/6.S081/2022/labs/traps.html">lab: Traps</a>
<a href="https://pdos.csail.mit.edu/6.S081/2022/xv6/book-riscv-rev3.pdf">xv6 book</a>
<a href="https://pdos.csail.mit.edu/6.S081/2022/reference.html">reference page</a>
<a href="https://github.com/riscv/riscv-isa-manual/releases/download/Priv-v1.12/riscv-privileged-20211203.pdf">RISC-V privileged instructions</a>
<a href="https://blog.csdn.net/dai_xiangjun/article/details/124083732">10.2 自制操作系统: risc-v Supervisor寄存器
sscratch/sepc/scause/stval/senvcfg</a>
<a href="https://ttzytt.com/2022/07/xv6_lab4_record/">MIT 6.s081 Xv6 Lab4 Traps 实验记录</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Yama&#39;s Trail</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

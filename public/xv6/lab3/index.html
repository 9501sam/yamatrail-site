<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>[xv6 學習紀錄 03] Lab: page tables | Yama&#39;s Trail</title>
<meta name="keywords" content="">
<meta name="description" content="Lab 連結: lab pgtbl
xv6 中的 virtual memory


memory layout

每一個 process 都會有自己的一個 page table，kernel 則是有它自己獨立的一個 page table
一般來說 kernel page table 會 map 所有的 physical address，這樣在 kernel mode 的時候就可以針對所有 pa 做動作


Kernel address space

接著依序講解 MAXVA, PHYSTOP, KERNBASE
MAXVA

如同先前提及，在 Sv39 中 virtual address 由 39 bits 組成

所以最大的 virtual address MAXVA也就是 0b111111111111111111111111111111111111111(39 1s):

// kernel/riscv.h
// one beyond the highest possible virtual address.
// MAXVA is actually one bit less than the max allowed by
// Sv39, to avoid having to sign-extend virtual addresses
// that have the high bit set.
#define MAXVA (1L &lt;&lt; (9 &#43; 9 &#43; 9 &#43; 12 - 1))
Direct Mapping 的區域：KERNBASE ~ PHYSTOP
這一段 0x80000000 ~ 0x88000000 是作為一般的 memory 空間使用，並且在 kernel 這一段的 mapping 中，是使用 Direct Mapping 的方式，也就是 virtual address == physical address 的意思，這麼做的好處在於 kernel 可以直接使用 physical address 對 memory 進行操作">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/xv6/lab3/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e1f5c4cae44599655f7ff95195ff89c8cb3adbda94f2b1581a434ab2b4d4e6cf.css" integrity="sha256-4fXEyuRFmWVff/lRlf&#43;JyMs629qU8rFYGkNKsrTU5s8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon_io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon_io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon_io/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon_io/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/xv6/lab3/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Yama&#39;s Trail (Alt + H)">Yama&#39;s Trail</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/dev-log/" title="這個網站的誕生">
                    <span>這個網站的誕生</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/leetcode/" title="LeetCode 解題">
                    <span>LeetCode 解題</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xv6/" title="xv6 學習紀錄">
                    <span>xv6 學習紀錄</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      [xv6 學習紀錄 03] Lab: page tables
    </h1>
    <div class="post-meta"><span title='2025-10-02 13:09:35 +0800 CST'>October 2, 2025</span>

</div>
  </header> 
  <div class="post-content"><p>Lab 連結: <a href="https://pdos.csail.mit.edu/6.S081/2022/labs/pgtbl.html">lab pgtbl</a></p>
<h2 id="xv6-中的-virtual-memory">xv6 中的 virtual memory<a hidden class="anchor" aria-hidden="true" href="#xv6-中的-virtual-memory">#</a></h2>
<p><img alt="page_table.png" loading="lazy" src="/xv6/lab3/page_table.png">
<img alt="3levels_page_table.png" loading="lazy" src="/xv6/lab3/3levels_page_table.png"></p>
<h2 id="memory-layout">memory layout<a hidden class="anchor" aria-hidden="true" href="#memory-layout">#</a></h2>
<ul>
<li>每一個 process 都會有自己的一個 page table，kernel 則是有它自己獨立的一個 page table</li>
<li>一般來說 kernel page table 會 map 所有的 physical address，這樣在 kernel mode 的時候就可以針對所有 pa 做動作</li>
</ul>
<p><img alt="process_layout.png" loading="lazy" src="/xv6/lab3/process_layout.png"></p>
<h2 id="kernel-address-space">Kernel address space<a hidden class="anchor" aria-hidden="true" href="#kernel-address-space">#</a></h2>
<p><img alt="kernel_layout.png" loading="lazy" src="/xv6/lab3/kernel_layout.png">
接著依序講解 <code>MAXVA</code>, <code>PHYSTOP</code>, <code>KERNBASE</code></p>
<h3 id="maxva"><code>MAXVA</code><a hidden class="anchor" aria-hidden="true" href="#maxva">#</a></h3>
<ul>
<li>如同先前提及，在 Sv39 中 virtual address 由 39 bits 組成
<img alt="va.png" loading="lazy" src="/xv6/lab3/va.png">
所以最大的 virtual address <code>MAXVA</code>也就是 <code>0b111111111111111111111111111111111111111</code>(39 1s):</li>
</ul>
<pre tabindex="0"><code class="language-c=" data-lang="c=">// kernel/riscv.h
// one beyond the highest possible virtual address.
// MAXVA is actually one bit less than the max allowed by
// Sv39, to avoid having to sign-extend virtual addresses
// that have the high bit set.
#define MAXVA (1L &lt;&lt; (9 + 9 + 9 + 12 - 1))
</code></pre><h3 id="direct-mapping-的區域kernbase--phystop">Direct Mapping 的區域：<code>KERNBASE</code> ~ <code>PHYSTOP</code><a hidden class="anchor" aria-hidden="true" href="#direct-mapping-的區域kernbase--phystop">#</a></h3>
<p>這一段 <code>0x80000000</code> ~ <code>0x88000000</code> 是作為一般的 memory 空間使用，並且在 kernel 這一段的 mapping 中，是使用 Direct Mapping 的方式，也就是 <code>virtual address == physical address</code> 的意思，這麼做的好處在於 kernel 可以直接使用 physical address 對 memory 進行操作</p>
<pre tabindex="0"><code class="language-c=" data-lang="c=">// the kernel expects there to be RAM
// for use by the kernel and user pages
// from physical address 0x80000000 to PHYSTOP.
#define KERNBASE 0x80000000L
#define PHYSTOP (KERNBASE + 128*1024*1024)
</code></pre><h3 id="非-direct-mapping-的區域">非 Direct Mapping 的區域<a hidden class="anchor" aria-hidden="true" href="#非-direct-mapping-的區域">#</a></h3>
<h4 id="trampoline-page">Trampoline page<a hidden class="anchor" aria-hidden="true" href="#trampoline-page">#</a></h4>
<p>這是由最高的 virtual address map 到 <code>KERNBASE</code> ~ <code>PHYSTOP</code> 之中的 trampoline code 的位置，值得注意的是 trampoline code 的 page 被 map 到了兩次： 1. <code>MAXVA</code> 2. Direct mapping</p>
<h4 id="kernel-stack-page">Kernel stack page<a hidden class="anchor" aria-hidden="true" href="#kernel-stack-page">#</a></h4>
<p>Kernel 為每一個 process 預留了一個 kernel stack，因為這裡的 virtual address 很高，所以 xv6 還有空間可以在每一個 kernel stack 下方加一個 guard page (<code>PTE_V</code> is not set)，當 kernel stack overflow 時，這個 guard page 會觸發 <code>panic()</code> 而不會污染其他 process 的 kernel stack</p>
<p>另一種 kernel stack 的設計是直接把 kernel stack 使用 direct mapping 的 virtual address 中，不過這樣的壞處在於當我們要放入 guard page 時，等同於是直接浪費了 physical memory 的空間。</p>
<h4 id="kernel-的-flag">kernel 的 flag<a hidden class="anchor" aria-hidden="true" href="#kernel-的-flag">#</a></h4>
<ul>
<li>trampoline: <code>PTE_R</code> and <code>PTR_X</code></li>
<li>other: <code>PTE_R</code> and <code>PTR_W</code></li>
<li>guard page: invalid</li>
</ul>
<h2 id="process-address-space">Process address space<a hidden class="anchor" aria-hidden="true" href="#process-address-space">#</a></h2>
<p><img alt="process_layout2.png" loading="lazy" src="/xv6/lab3/process_layout2.png">
每一個 process 都有自己的 page table，就像是上圖一樣 virtual address 的空間與 kernel address space 一樣，為 <code>0</code> ~ <code>MAXVA</code> 理論上可以 map 到 256 Gigabytes 的 memory</p>
<h2 id="程式碼解析">程式碼解析<a hidden class="anchor" aria-hidden="true" href="#程式碼解析">#</a></h2>
<p>在理解 virtual memory 的概念之後，題目建議我們先閱讀以下三個檔案：</p>
<blockquote>
<ul>
<li><code>kernel/memlayout.h</code>, which captures the layout of memory.</li>
<li><code>kernel/vm.c</code>, which contains most virtual memory (VM) code.</li>
<li><code>kernel/kalloc.c</code>, which contains code for allocating and freeing physical memory.</li>
</ul></blockquote>
<p>這讓我們可以清楚的知道圖片上的概念要如何與程式碼做連結</p>
<h3 id="資料結構-pagetable_t-pte_t">資料結構 <code>pagetable_t</code>, <code>pte_t</code><a hidden class="anchor" aria-hidden="true" href="#資料結構-pagetable_t-pte_t">#</a></h3>
<p>那讓我們先從先前看過幾次的 page table 開始，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> uint64 <span style="color:#66d9ef">pte_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> uint64 <span style="color:#f92672">*</span><span style="color:#66d9ef">pagetable_t</span>; <span style="color:#75715e">// 512 PTEs
</span></span></span></code></pre></div><p>page table 對應到的是一個 <code>pagetable_t</code>，並且可以把它想成是 array of PTE(<code>pte_t</code>)，這也相當合理，如同先前的圖片所示，page table 本身也就只是用來紀錄 512 個 PTE 的資料結構。</p>
<h3 id="用來基本操作的-macro-px-pte2pa-pa2pte">用來基本操作的 macro: <code>PX()</code>, <code>PTE2PA()</code>, <code>PA2PTE()</code><a hidden class="anchor" aria-hidden="true" href="#用來基本操作的-macro-px-pte2pa-pa2pte">#</a></h3>
<ul>
<li><code>PX()</code>: <strong>P</strong>agetable inde<strong>x</strong></li>
<li><code>PTE2PA()</code>: PTE to PA</li>
<li><code>PA2PTE()</code>: PA to PTE</li>
</ul>
<h4 id="px-解析"><code>PX()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#px-解析">#</a></h4>
<p>在 xv6 中，一個 virtual memory address 中有 3 個 9 bits 的 pagetable index，<code>PX()</code> 的功用就是把一個 virtual memory address 中的其中一個 level 的 9 physical page number (PPN) 取出來</p>
<pre tabindex="0"><code class="language-c=" data-lang="c=">#define PGSHIFT 12  // bits of offset within a page

// extract the three 9-bit page table indices from a virtual address.
#define PXMASK          0x1FF // 9 bits
#define PXSHIFT(level)  (PGSHIFT+(9*(level)))
#define PX(level, va) ((((uint64) (va)) &gt;&gt; PXSHIFT(level)) &amp; PXMASK)
</code></pre><p>根據 level 把 virtual memory address 中的其中 9 bits PPN 移動到 64-bits 的最右邊，再利用 <code>PXMASK</code> 篩選剩下 9 個 bits</p>
<p>目前我們有了 <code>PX()</code>，可以從 va 中找到其中一個 level 的 PPN，如果現在有一個 pagetable，搭配上剛剛找到的 PPN，我們便可以找到對應的 PTE，舉例來說像是 <code>walk() at kernel/vm.c</code> 的其中一行：</p>
<p><code>PX()</code> 的應用：在「va 經由 pagetable 找到對應的 PTE」的過程中，<code>PX()</code> 起到了方便的作用，舉例像是 <code>walk() at kernel/vm.c</code> 的其中一行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/vm.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">walk</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, <span style="color:#66d9ef">int</span> alloc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(va <span style="color:#f92672">&gt;=</span> MAXVA)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;walk&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> level <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; level <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; level<span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pagetable[<span style="color:#a6e22e">PX</span>(level, va)];         <span style="color:#75715e">// 這一行！
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) {
</span></span><span style="display:flex;"><span>      pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pagetable_t</span>)<span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>alloc <span style="color:#f92672">||</span> (pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pde_t</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">memset</span>(pagetable, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">PA2PTE</span>(pagetable) <span style="color:#f92672">|</span> PTE_V;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>pagetable[<span style="color:#a6e22e">PX</span>(<span style="color:#ae81ff">0</span>, va)];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>就是一個使用到 <code>PX()</code> 的例子:</p>
<ol>
<li>利用 va, level 丟入 <code>PX()</code> 找到 index: <code>PX(level, va)</code></li>
<li>再利用這個 index(<code>PX(level, va)</code>) 從 pagetable 中拿到 PTE
<ul>
<li><code>pte_t *pte = &amp;pagetable[PX(level, va)]</code></li>
</ul>
</li>
</ol>
<h4 id="pte2pa-解析"><code>PTE2PA()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#pte2pa-解析">#</a></h4>
<p>剛剛我們已經利用了 <code>PX()</code> 讓 va 透過 pagetable 找到對應的 pte，拿到 pte 後，我們要有能力把這個 pte 轉換成 physical memory address (PA) 這是我們最終的目的: 「va 透過 pagetable 找到 PA」</p>
<p>這正是 <code>PTE2PA()</code> 所要處理的事情</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#define PTE2PA(pte) (((pte) &gt;&gt; 10) &lt;&lt; 12)
</span></span></span></code></pre></div><p>把 pte 當中的 (PPN) physical page number 擷取出來</p>
<h4 id="pa2pte-解析"><code>PA2PTE()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#pa2pte-解析">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// shift a physical address to the right place for a PTE.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define PA2PTE(pa) ((((uint64)pa) &gt;&gt; 12) &lt;&lt; 10)
</span></span></span></code></pre></div><ul>
<li>把一個 physical memory 的 offset 去掉，並且做成一個 pte (shift left 10)</li>
<li>請注意這個做好的 pte 的 flag 的地方全部都是 0，需要自己把 flag 設定上</li>
</ul>
<h4 id="pgroundup-pgrounddown-解析"><code>PGROUNDUP()</code>, <code>PGROUNDDOWN()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#pgroundup-pgrounddown-解析">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/riscv.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define PGSIZE 4096 </span><span style="color:#75715e">// bytes per page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define PGROUNDUP(sz)  (((sz)+PGSIZE-1) &amp; ~(PGSIZE-1))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PGROUNDDOWN(a) (((a)) &amp; ~(PGSIZE-1))
</span></span></span></code></pre></div><ul>
<li><code>&amp; ~(PGSIZE-1)</code>
<ol>
<li><code>PGSIZE</code> 是 4096, 二進位為 1000000000000 (12 個 0)</li>
<li><code>PGSIZE-1</code> 二進位為 <code>0111111111111</code> (12 個 1)</li>
<li><code>~(PGSIZE-1)</code> 形成一種 mask <code>...1111 000000000000</code> (12 個 0)</li>
<li><code>&amp; ~(PGSIZE-1)</code> 使用了 <code>&amp;</code>, 也就是把低位的 12 個 bits 都變為 0, 也就是取得一個 address 的所屬 page 的起始位置</li>
</ol>
</li>
<li><code>#define PGROUNDDOWN(a) (((a)) &amp; ~(PGSIZE-1))</code>: 取得 <code>a</code> 所屬 page 的起始位置</li>
<li><code>#define PGROUNDUP(sz)  (((sz)+PGSIZE-1) &amp; ~(PGSIZE-1))</code>: <code>sz</code> bytes 所需要的 page 數量</li>
</ul>
<h4 id="walk-解析"><code>walk()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#walk-解析">#</a></h4>
<p>在大多數情況下，va 透過 pagetable 得到 pa 的動作，像是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>a <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
</span></span></code></pre></div><p>這種動作是由硬體完成的，risc-v 的 register <code>satp</code> 會紀錄當下 pagetable 的 <strong>physicall</strong> address
, 一旦有了 <code>satp</code> 所紀錄的這個 pagetable 的 physicall address，
硬體就有辦法把程式中的 va 藉由 pagetable(從 <code>satp</code> 得知) 轉換成 pa</p>
<p>可是在 kernel 中的<strong>某些地方</strong>(<code>todo</code>: 實際上在哪邊？)
會需要在程式中就直接拿到最後一個 level (level 0) 的 PTE (有點類似用軟體做出硬體的行為)
試想我們有一個 va 以及 pagetable，想要拿到最後一個 level 的 PTE，可以用 <code>walk()</code> 來達成:
<img alt="3levels_page_table.png" loading="lazy" src="/xv6/lab3/3levels_page_table.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Return the address of the PTE in page table pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// that corresponds to virtual address va.  If alloc!=0,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// create any required page-table pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 根據 virtual address va 以及 pate table patetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 回傳 PTE 的 address (physical memory)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The risc-v Sv39 scheme has three levels of page-table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// pages. A page-table page contains 512 64-bit PTEs.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// A 64-bit virtual address is split into five fields:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   39..63 -- must be zero.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   30..38 -- 9 bits of level-2 index.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   21..29 -- 9 bits of level-1 index.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   12..20 -- 9 bits of level-0 index.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    0..11 -- 12 bits of byte offset within the page.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">walk</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, <span style="color:#66d9ef">int</span> alloc) <span style="color:#75715e">// pagetable 紀錄的是 pa
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(va <span style="color:#f92672">&gt;=</span> MAXVA)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;walk&#34;</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// level 只會是 2, 1, 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// (迴圈 level == 2 開始)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// pagetable -&gt; level 2 的 pagetable 的 pa
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// pte_t *pte = &amp;pagetable[PX(2, va)] 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// -&gt; (level 2 pagetable 中) 指向 level 1 的 pagetable 的 pte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// pagetable = (pagetable_t)PTE2PA(*pte); -&gt; pagetable 變成指向 level 1 的 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// (迴圈 level == 1 開始)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// pte_t *pte = &amp;pagetable[PX(2, va)] -&gt; 指向 level 0 的 pagetable 的 pte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// -&gt; (level 1 pagetable 中) 指向 level 0 的 pagetable 的 pte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// pagetable = (pagetable_t)PTE2PA(*pte); -&gt; pagetable 變成指向 level 0 的 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> level <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; level <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; level<span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pagetable[<span style="color:#a6e22e">PX</span>(level, va)]; <span style="color:#75715e">// get pte by virtual address and level (in physical address)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) {
</span></span><span style="display:flex;"><span>      pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pagetable_t</span>)<span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte); <span style="color:#75715e">// pagetable 是指向下一層的 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 如果這個 PTE 還沒有被 allocate，並且 alloc != 0 (alloc == true 的意思)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// 則 allocate 這個 PTE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// 使用 kalloc() 告訴 xv6: 我要一塊 page 來存放一個 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// (pte_t *) 是想表達 pagetable 是 pte_t 的 array 的意思
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>alloc <span style="color:#f92672">||</span> (pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pde_t</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 清空這個新的 pagetable 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// (注意這時候，memset 吃的是 pa, 可是 user mode 時，function 吃的是 va)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">memset</span>(pagetable, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 把這個新的 PTE 的 flag PTE_V set 為 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">PA2PTE</span>(pagetable) <span style="color:#f92672">|</span> PTE_V; 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 到了這裡 pagetable 已經是一個指向 level 0 的 page table 的 pa
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 有了這個 page table 以及 va 中 level 0 的 9 bits 的 index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 就可以拿到最終我們要的 PTE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>pagetable[<span style="color:#a6e22e">PX</span>(<span style="color:#ae81ff">0</span>, va)];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>walk()</code> 是用來根據 pagetable 以及 virtual memory address 來取得這個 va 的 pte</li>
<li><code>pagetable_t</code> 紀錄的是 physical memory</li>
<li><code>walk()</code> 回傳 <code>pte_t *</code> 也就是 figure 3.2 所描述的那樣
<ul>
<li>54..63 &ndash; 10 bits Reserved</li>
<li>10..53 &ndash; 44 bits Physical Page Number</li>
<li>0..9  &ndash; 10 bits Flags</li>
</ul>
</li>
<li>有了 PTE 之後可以幹嘛?
<ul>
<li>有了 PTE 之後，就可以再利用 va 的 12 bits offset 來得到 pa</li>
<li>請注意，在大多數真正的 access pagetable 的情況下<strong>並不會</strong>使用 <code>walk()</code>，而是用硬體的方式處理</li>
</ul>
</li>
</ul>
<h4 id="walkaddr-解析"><code>walkaddr()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#walkaddr-解析">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Look up a virtual address, return the physical address,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// or 0 if not mapped.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Can only be used to look up user pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">walkaddr</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>  uint64 pa;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(va <span style="color:#f92672">&gt;=</span> MAXVA)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(pagetable, va, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(pte <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_U) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pa;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>walk()</code> 拿到的是 PTE, <code>walkaddr()</code> 多的加工變成 physical address</p>
<h4 id="mappages-解析"><code>mappages()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#mappages-解析">#</a></h4>
<p>現在我們有了一些 macro 可以處理 va, pa, page table, pte 的轉換</p>
<p><code>mappages()</code> 使用了情況:<br>
在 page table <code>pagetale</code> 中記下一筆資訊:</p>
<blockquote>
<p>virtual address <code>va</code> 透過 <code>pagetable</code> 會對應到 physical address <code>pa</code></p></blockquote>
<p>這也正是 page table 最主要的功能</p>
<p>(這個對應是以一個 page (4096 byte) 做為一個單位去做 map 的)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// kernel/riscv.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> uint64 <span style="color:#66d9ef">pte_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> uint64 <span style="color:#f92672">*</span><span style="color:#66d9ef">pagetable_t</span>; <span style="color:#75715e">// 512 PTEs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// kernel/vm.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mappages</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, uint64 size, uint64 pa, <span style="color:#66d9ef">int</span> perm)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 a, last;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;mappages: size&#34;</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// map 必須要以一個 page 為單位, 所以需要 round up 以及 round down
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  a <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(va);
</span></span><span style="display:flex;"><span>  last <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(va <span style="color:#f92672">+</span> size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(;;){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 拿到 virtual address a 的 pte (walk() 會幫我們 allocate, 它使用 kalloc())
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(pagetable, a, <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">// walk 失敗時 return 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#75715e">// walk() 回傳的 pte 是還沒 set PTE_V 的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;mappages: remap&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在這裡，我們拿到了 level 0 pagetable 中對應到 va `a` 的 pte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 現在它還沒被賦予值，現在我們要告訴這個 PTE: 你要指到 pa 去!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">PA2PTE</span>(pa) <span style="color:#f92672">|</span> perm <span style="color:#f92672">|</span> PTE_V; <span style="color:#75715e">// pte 對應到了 pa
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(a <span style="color:#f92672">==</span> last)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">+=</span> PGSIZE;
</span></span><span style="display:flex;"><span>    pa <span style="color:#f92672">+=</span> PGSIZE;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>mappages()</code> 是用來把一個 pa 塞進一個 pagetable 裡，並且我們可以指定它的 va 以及 flag</p>
<h4 id="proc_pagetable-解析"><code>proc_pagetable()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#proc_pagetable-解析">#</a></h4>
<p><code>proc_pagetable()</code> 用來初始化一個新的 process 中的 <code>pagetable</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Per-process state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> proc {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pagetable_t</span> pagetable; <span style="color:#75715e">// proc_pagetable() 負責初始這裡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Create a user page table for a given process, with no user memory,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// but with trampoline and trapframe pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 把一個 process 的 pagetable 做出來，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 但這時候只有 trampoline 跟 trapframe 有被紀錄在 page table 中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pagetable_t</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">proc_pagetable</span>(<span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pagetable_t</span> pagetable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// An empty page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  pagetable <span style="color:#f92672">=</span> <span style="color:#a6e22e">uvmcreate</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(pagetable <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// map the trampoline code (for system call return)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// at the highest user virtual address.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// only the supervisor uses it, on the way
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// to/from user space, so not PTE_U.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(pagetable, TRAMPOLINE, PGSIZE,
</span></span><span style="display:flex;"><span>              (uint64)trampoline, PTE_R <span style="color:#f92672">|</span> PTE_X) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmfree</span>(pagetable, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// map the trapframe page just below the trampoline page, for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// trampoline.S.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(pagetable, TRAPFRAME, PGSIZE,
</span></span><span style="display:flex;"><span>              (uint64)(p<span style="color:#f92672">-&gt;</span>trapframe), PTE_R <span style="color:#f92672">|</span> PTE_W) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAMPOLINE, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmfree</span>(pagetable, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pagetable;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>proc_pagetable()</code> 所使用的 function 有:
<ul>
<li><code>mappages()</code>: 宣稱 <code>va</code> 經由 <code>pagetable</code> map 到 <code>pa</code> (可利用 <code>walk()</code> 查詢)</li>
<li><code>uvmcreate()</code>: 利用 <code>kalloc()</code> 做出一個全新的 pagetable (只有一個 level)</li>
<li><code>uvmunmap()</code></li>
<li><code>uvmfree()</code></li>
</ul>
</li>
</ul>
<h4 id="uvmcreate-解析"><code>uvmcreate()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#uvmcreate-解析">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// create an empty user page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// returns 0 if out of memory.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pagetable_t</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmcreate</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pagetable_t</span> pagetable;
</span></span><span style="display:flex;"><span>  pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pagetable_t</span>) <span style="color:#a6e22e">kalloc</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(pagetable <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(pagetable, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pagetable;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>uvmcreate()</code> 利用 <code>kalloc()</code> 做出一個全新的 pagetable</li>
<li>請注意，pagetable 所紀錄的是 physical memory</li>
</ul>
<h4 id="uvmunmap-解析-mappages-的相反-宣稱一些-va-取消-mapping-了"><code>uvmunmap()</code> 解析: <code>mappages()</code> 的相反, 宣稱一些 va 取消 mapping 了<a hidden class="anchor" aria-hidden="true" href="#uvmunmap-解析-mappages-的相反-宣稱一些-va-取消-mapping-了">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Remove npages of mappings starting from va. va must be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// page-aligned. The mappings must exist.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Optionally free the physical memory.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmunmap</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, uint64 npages, <span style="color:#66d9ef">int</span> do_free)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 a;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>((va <span style="color:#f92672">%</span> PGSIZE) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">// 傳進來的 va 應該要是 start of the pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmunmap: not aligned&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(a <span style="color:#f92672">=</span> va; a <span style="color:#f92672">&lt;</span> va <span style="color:#f92672">+</span> npages<span style="color:#f92672">*</span>PGSIZE; a <span style="color:#f92672">+=</span> PGSIZE){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果這個要被 unmap 的 page (virtual address) 根本沒有 map 到 pa
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(pagetable, a, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmunmap: walk&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 它應該要是 valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmunmap: not mapped&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">PTE_FLAGS</span>(<span style="color:#f92672">*</span>pte) <span style="color:#f92672">==</span> PTE_V)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmunmap: not a leaf&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(do_free){
</span></span><span style="display:flex;"><span>      uint64 pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)pa);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>va</code> 必須為 <code>PGSIZE</code> 的倍數 (start of the pagetable)</li>
<li>unmap 跟 free 是兩回事
<ul>
<li>free: 把這個 physical address 加回 <code>kmem.freelist</code> 中
<ul>
<li>要用 <code>kfree((void *) pa)</code></li>
</ul>
</li>
<li>unmap: 僅限於對於這個 pagetable 而言，把這個 virtual memory address 移除
<ul>
<li>所謂的移除，也就是把最後一層的 page table entry 給清為 0 <code>*pte = 0</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="uvmfree-解析"><code>uvmfree()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#uvmfree-解析">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Free user memory pages,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// then free page-table pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmfree</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(sz <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmunmap</span>(pagetable, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">PGROUNDUP</span>(sz)<span style="color:#f92672">/</span>PGSIZE, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">freewalk</span>(pagetable);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>uvmfree()</code> 不只把 va unmap 還會把這些 memory free 掉</p>
<h4 id="freewalk-解析"><code>freewalk()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#freewalk-解析">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Recursively free page-table pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// All leaf mappings must already have been removed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">freewalk</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// there are 2^9 = 512 PTEs in a page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">512</span>; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pte_t</span> pte <span style="color:#f92672">=</span> pagetable[i];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">&amp;&amp;</span> (pte <span style="color:#f92672">&amp;</span> (PTE_R<span style="color:#f92672">|</span>PTE_W<span style="color:#f92672">|</span>PTE_X)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// PTE_V 為 1 PTE_R, PTE_W, PTE_X 為 0 代表:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// this PTE points to a lower-level page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// 因為在 level 0 pagetable 中的 PTE 如果 PTE_V == 0 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// 必定 PTE_R, PTE_W, PTE_X 會有至少一個為 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      uint64 child <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(pte);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">freewalk</span>((<span style="color:#66d9ef">pagetable_t</span>)child);
</span></span><span style="display:flex;"><span>      pagetable[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(pte <span style="color:#f92672">&amp;</span> PTE_V){
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 在呼叫 freewalk() 之前，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// caller (例如 uvmfree() )
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// 具有先將這段 va uvmunmap() 的責任
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// freewalk() 只負責清理 pagetable 的部份
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// 所以不該進到這個 condition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;freewalk: leaf&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)pagetable);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="kalloc-解析"><code>kalloc()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#kalloc-解析">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Allocate one 4096-byte page of physical memory.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Returns a pointer that the kernel can use.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Returns 0 if the memory cannot be allocated.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kalloc</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> run <span style="color:#f92672">*</span>r;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>kmem.lock);
</span></span><span style="display:flex;"><span>  r <span style="color:#f92672">=</span> kmem.freelist;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(r)
</span></span><span style="display:flex;"><span>    kmem.freelist <span style="color:#f92672">=</span> r<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>kmem.lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(r)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)r, <span style="color:#ae81ff">5</span>, PGSIZE); <span style="color:#75715e">// fill with junk
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)r;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>在 xv6 中，所有可以用的 page 會被紀錄在 <code>kmem.freelist</code> 當中</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> run {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> run <span style="color:#f92672">*</span>next;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> spinlock lock;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> run <span style="color:#f92672">*</span>freelist;
</span></span><span style="display:flex;"><span>} kmem;
</span></span></code></pre></div><ul>
<li><code>kalloc()</code> 回傳一個 4096-bytes(<code>PGSIZE</code>) 的 page</li>
<li>回傳的 pointer 指向 physical memory
<ul>
<li>supervisor mode 時，kernel page table 具有 <code>Virtual Address = Physical Address</code> 的特性</li>
</ul>
</li>
<li>kmem 的初始化過程很值得追蹤</li>
</ul>
<h4 id="uvmcopy-解析"><code>uvmcopy()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#uvmcopy-解析">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// 把 old 的內容複製給 new
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// sz 為 page 的數量，每個 page 的大小為 4096 byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmcopy</span>(<span style="color:#66d9ef">pagetable_t</span> old, <span style="color:#66d9ef">pagetable_t</span> new, uint64 sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>  uint64 pa, i;
</span></span><span style="display:flex;"><span>  uint flags;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mem;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> sz; i <span style="color:#f92672">+=</span> PGSIZE){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(old, i, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmcopy: pte should exist&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmcopy: page not present&#34;</span>);
</span></span><span style="display:flex;"><span>    pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte); <span style="color:#75715e">// 用 parent 的 pte 拿到 physical address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    flags <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE_FLAGS</span>(<span style="color:#f92672">*</span>pte); <span style="color:#75715e">// 拿到 parent 的 pte 的 flags
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// mem 是 child 的 physical memory (其中一個 page, 目前是全新的)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((mem <span style="color:#f92672">=</span> <span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">// mem 是 child 的 physical memory (其中一個 page)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">goto</span> err;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memmove</span>(mem, (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pa, PGSIZE); <span style="color:#75715e">// parent 的內容搬到 child 的 memory 中 (都用 pa)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 現在有了 mem (一個 page 的 pa)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 接下來要把這個 page map 到 child 的 pagetable (new) 中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(new, i, PGSIZE, (uint64)mem, flags) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">kfree</span>(mem);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> err;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> err:
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(new, <span style="color:#ae81ff">0</span>, i <span style="color:#f92672">/</span> PGSIZE, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>uvmcopy()</code> 在 <code>fork()</code> 的過程中扮演了重要的角色，這也是為什麼使用 <code>fork()</code> 時，會有 parent 與 child 的 memory 內容一樣的特性</li>
<li><code>uvmcopy()</code> 把一個 parent 的 page table 複製給 child，</li>
<li>包含了 page table 以及 physical memory 的內容</li>
<li>失敗時回傳 <code>-1</code>，並且把先前 allocate 的 page 都給 free 掉</li>
</ul>
<h4 id="memmove-解析"><code>memmove()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#memmove-解析">#</a></h4>
<p><code>memmove()</code> 把 <code>n</code> bytes 的內容從 <code>src</code> 搬到 <code>dst</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memmove</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>dst, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>src, uint n)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>d;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(n <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> dst;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  s <span style="color:#f92672">=</span> src;
</span></span><span style="display:flex;"><span>  d <span style="color:#f92672">=</span> dst;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(s <span style="color:#f92672">&lt;</span> d <span style="color:#f92672">&amp;&amp;</span> s <span style="color:#f92672">+</span> n <span style="color:#f92672">&gt;</span> d){
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">+=</span> n;
</span></span><span style="display:flex;"><span>    d <span style="color:#f92672">+=</span> n;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(n<span style="color:#f92672">--</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*--</span>d <span style="color:#f92672">=</span> <span style="color:#f92672">*--</span>s;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 這個 loop 也寫的太 clever 了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(n<span style="color:#f92672">--</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>d<span style="color:#f92672">++</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>s<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> dst;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="malloc-解析"><code>malloc()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#malloc-解析">#</a></h4>
<p><code>malloc()</code> 用來 allocate <code>nbytes</code> 個 bytes 的記憶體空間</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">malloc</span>(uint nbytes)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  Header <span style="color:#f92672">*</span>p, <span style="color:#f92672">*</span>prevp;
</span></span><span style="display:flex;"><span>  uint nunits;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  nunits <span style="color:#f92672">=</span> (nbytes <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(Header) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">/</span><span style="color:#66d9ef">sizeof</span>(Header) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>((prevp <span style="color:#f92672">=</span> freep) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    base.s.ptr <span style="color:#f92672">=</span> freep <span style="color:#f92672">=</span> prevp <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>base;
</span></span><span style="display:flex;"><span>    base.s.size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(p <span style="color:#f92672">=</span> prevp<span style="color:#f92672">-&gt;</span>s.ptr; ; prevp <span style="color:#f92672">=</span> p, p <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>s.ptr){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>s.size <span style="color:#f92672">&gt;=</span> nunits){
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>s.size <span style="color:#f92672">==</span> nunits)
</span></span><span style="display:flex;"><span>        prevp<span style="color:#f92672">-&gt;</span>s.ptr <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>s.ptr;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>s.size <span style="color:#f92672">-=</span> nunits;
</span></span><span style="display:flex;"><span>        p <span style="color:#f92672">+=</span> p<span style="color:#f92672">-&gt;</span>s.size;
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>s.size <span style="color:#f92672">=</span> nunits;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      freep <span style="color:#f92672">=</span> prevp;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)(p <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(p <span style="color:#f92672">==</span> freep)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span>((p <span style="color:#f92672">=</span> <span style="color:#a6e22e">morecore</span>(nunits)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="copyout-解析"><code>copyout()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#copyout-解析">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Copy from kernel to user.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Copy len bytes from src to virtual address dstva in a given page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Return 0 on success, -1 on error.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">copyout</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 dstva, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>src, uint64 len)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 n, va0, pa0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>(len <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    va0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(dstva);
</span></span><span style="display:flex;"><span>    pa0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">walkaddr</span>(pagetable, va0);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(pa0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> PGSIZE <span style="color:#f92672">-</span> (dstva <span style="color:#f92672">-</span> va0);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(n <span style="color:#f92672">&gt;</span> len)
</span></span><span style="display:flex;"><span>      n <span style="color:#f92672">=</span> len;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 因為這裡吃的都是 pa
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">memmove</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)(pa0 <span style="color:#f92672">+</span> (dstva <span style="color:#f92672">-</span> va0)), src, n);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    len <span style="color:#f92672">-=</span> n;
</span></span><span style="display:flex;"><span>    src <span style="color:#f92672">+=</span> n;
</span></span><span style="display:flex;"><span>    dstva <span style="color:#f92672">=</span> va0 <span style="color:#f92672">+</span> PGSIZE;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="speed-up-system-calls-easy">Speed up system calls (easy)<a hidden class="anchor" aria-hidden="true" href="#speed-up-system-calls-easy">#</a></h2>
<p>題目敘述:</p>
<blockquote>
<p>When each process is created, map one read-only page at <code>USYSCALL</code> (a virtual address defined in <code>memlayout.h</code>). At the start of this page, store a struct <code>usyscall</code> (also defined in <code>memlayout.h</code>), and initialize it to store the PID of the current process. For this lab, <code>ugetpid()</code> has been provided on the userspace side and will automatically use the <code>USYSCALL</code> mapping. You will receive full credit for this part of the lab if the <code>ugetpid</code> test case passes when running <code>pgtbltest</code>.</p></blockquote>
<p>如同先前看到的 process address space
<img alt="process_layout2.png" loading="lazy" src="/xv6/lab3/process_layout2.png">
最高的 address 依序是 <code>MAXVA</code>, <code>TRAMPOLINE</code>, <code>TRAPFRAME</code>, 這一題則是要再加上 <code>USYSCALL</code></p>
<ul>
<li><code>kernel/memlayout.h</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// User memory layout.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Address zero first:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   text
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   original data and bss
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   fixed-size stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   expandable heap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   USYSCALL (shared with kernel)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   TRAPFRAME (p-&gt;trapframe, used by the trampoline)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   TRAMPOLINE (the same page as in the kernel)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define TRAPFRAME (TRAMPOLINE - PGSIZE)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef LAB_PGTBL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define USYSCALL (TRAPFRAME - PGSIZE)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> usyscall {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> pid;  <span style="color:#75715e">// Process ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><h3 id="在-kernelprocc-proc_pagetable-中加上這個-mapping">在 <code>kernel/proc.c: proc_pagetable()</code> 中加上這個 mapping<a hidden class="anchor" aria-hidden="true" href="#在-kernelprocc-proc_pagetable-中加上這個-mapping">#</a></h3>
<ul>
<li><code>kerenl/proc.h</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Per-process state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> proc {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> spinlock lock;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// p-&gt;lock must be held when using these:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">enum</span> procstate state;        <span style="color:#75715e">// Process state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>chan;                  <span style="color:#75715e">// If non-zero, sleeping on chan
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> killed;                  <span style="color:#75715e">// If non-zero, have been killed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> xstate;                  <span style="color:#75715e">// Exit status to be returned to parent&#39;s wait
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> pid;                     <span style="color:#75715e">// Process ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// wait_lock must be held when using this:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>parent;         <span style="color:#75715e">// Parent process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// these are private to the process, so p-&gt;lock need not be held.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 kstack;               <span style="color:#75715e">// Virtual address of kernel stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 sz;                   <span style="color:#75715e">// Size of process memory (bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pagetable_t</span> pagetable;       <span style="color:#75715e">// User page table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> trapframe <span style="color:#f92672">*</span>trapframe; <span style="color:#75715e">// data page for trampoline.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> context context;      <span style="color:#75715e">// swtch() here to run process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>ofile[NOFILE];  <span style="color:#75715e">// Open files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>cwd;           <span style="color:#75715e">// Current directory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> name[<span style="color:#ae81ff">16</span>];               <span style="color:#75715e">// Process name (debugging)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> usyscall <span style="color:#f92672">*</span>usyscall;   <span style="color:#75715e">// for lab3: speed up system calls
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><ul>
<li><code>kernel/proc.c: proc_pagetable()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Create a user page table for a given process, with no user memory,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// but with trampoline and trapframe pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pagetable_t</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">proc_pagetable</span>(<span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pagetable_t</span> pagetable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// An empty page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  pagetable <span style="color:#f92672">=</span> <span style="color:#a6e22e">uvmcreate</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(pagetable <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// map the trampoline code (for system call return)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// at the highest user virtual address.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// only the supervisor uses it, on the way
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// to/from user space, so not PTE_U.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(pagetable, TRAMPOLINE, PGSIZE,
</span></span><span style="display:flex;"><span>              (uint64)trampoline, PTE_R <span style="color:#f92672">|</span> PTE_X) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmfree</span>(pagetable, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// map the trapframe page just below the trampoline page, for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// trampoline.S.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(pagetable, TRAPFRAME, PGSIZE,
</span></span><span style="display:flex;"><span>              (uint64)(p<span style="color:#f92672">-&gt;</span>trapframe), PTE_R <span style="color:#f92672">|</span> PTE_W) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAMPOLINE, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmfree</span>(pagetable, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// for lab3: speed up system calls
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// map one read-only page at USYSCALL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mappages</span>(pagetable, USYSCALL, PGSIZE,
</span></span><span style="display:flex;"><span>        (uint64)(p<span style="color:#f92672">-&gt;</span>usyscall), PTE_R <span style="color:#f92672">|</span> PTE_U) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAMPOLINE, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAPFRAME, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmfree</span>(pagetable, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pagetable;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>kernel/proc.c: freeproc()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// free a proc structure and the data hanging from it,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// including user pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// p-&gt;lock must be held.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">freeproc</span>(<span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>trapframe)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)p<span style="color:#f92672">-&gt;</span>trapframe);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>trapframe <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>usyscall)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)p<span style="color:#f92672">-&gt;</span>usyscall);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>usyscall <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>pagetable)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">proc_freepagetable</span>(p<span style="color:#f92672">-&gt;</span>pagetable, p<span style="color:#f92672">-&gt;</span>sz);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>pagetable <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>pid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>parent <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>name[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>chan <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>killed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>xstate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> UNUSED;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>kernel/proc.c: proc_freepagetable()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Free a process&#39;s page table, and free the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// physical memory it refers to.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">proc_freepagetable</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAMPOLINE, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAPFRAME, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(pagetable, USYSCALL, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmfree</span>(pagetable, sz);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>kernel/proc.c: allocproc()</code>: 跟 <code>traptrame</code> 一樣的方法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> proc<span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">allocproc</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(p <span style="color:#f92672">=</span> proc; p <span style="color:#f92672">&lt;</span> <span style="color:#f92672">&amp;</span>proc[NPROC]; p<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">==</span> UNUSED) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> found;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>found:
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">allocpid</span>();
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> USED;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Allocate a trapframe page.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>((p<span style="color:#f92672">-&gt;</span>trapframe <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> trapframe <span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">freeproc</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Allocate and initialize a usyscall page.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>((p<span style="color:#f92672">-&gt;</span>usyscall <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> usyscall <span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">freeproc</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>usyscall<span style="color:#f92672">-&gt;</span>pid <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>pid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// An empty user page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>pagetable <span style="color:#f92672">=</span> <span style="color:#a6e22e">proc_pagetable</span>(p);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>pagetable <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">freeproc</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Set up new context to start executing at forkret,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// which returns to user space.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>context, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(p<span style="color:#f92672">-&gt;</span>context));
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>context.ra <span style="color:#f92672">=</span> (uint64)forkret;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>context.sp <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>kstack <span style="color:#f92672">+</span> PGSIZE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> p;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="大綱">大綱<a hidden class="anchor" aria-hidden="true" href="#大綱">#</a></h2>
<ol>
<li>
<p>xv6 的 virtual memory</p>
<ol>
<li>terms about virtual memory</li>
<li>virtual memory in xv6</li>
<li>xv6 中 關於 virtual memory 的程式碼</li>
</ol>
</li>
<li>
<p>lab</p>
<ol>
<li>Speed up system calls (easy)</li>
<li>Print a page table (easy)</li>
<li>Detect which pages have been accessed (hard)</li>
</ol>
</li>
</ol>
<h2 id="1-xv6-的-virtual-memory">1. xv6 的 virtual memory<a hidden class="anchor" aria-hidden="true" href="#1-xv6-的-virtual-memory">#</a></h2>
<h3 id="使用-virtual-memory-的動機">使用 virtual memory 的動機<a hidden class="anchor" aria-hidden="true" href="#使用-virtual-memory-的動機">#</a></h3>
<ul>
<li>每個 process 在概念上都有<strong>自己的</strong>抽象的記憶體空間</li>
</ul>
<h3 id="11">1.1<a hidden class="anchor" aria-hidden="true" href="#11">#</a></h3>
<ul>
<li>virtual mem, physical memory 以及 page table 之間的關係
<img alt="Figure 3.1: RISC-V virtual and physical addresses, with a simplified logical page table." loading="lazy" src="https://github.com/9501sam/xv6-labs-2022/blob/note/notes/pictures/Figure3.1.png?raw=true"></li>
<li>每一個 process 都有自己的　Virtual memory address space</li>
<li>virtual address 經由 page table 可以找到 physicall address</li>
<li>每個 process 都需要一個 page table
<ul>
<li>當下正在使用的 page table 的 address 會儲存在 register <code>stap</code> 中
<ul>
<li><code>stap</code> 儲存的是 physical address</li>
</ul>
</li>
</ul>
</li>
<li>offset: 一個 page 的大小是 2^12</li>
<li>一個 page table 中有很多 page table entry(pte)</li>
</ul>
<h3 id="12-risc-v-裡面的-virtual-memory">1.2 RISC-V 裡面的 virtual memory<a hidden class="anchor" aria-hidden="true" href="#12-risc-v-裡面的-virtual-memory">#</a></h3>
<p><img alt="Figure 3.2: RISC-V address translation details." loading="lazy" src="https://github.com/9501sam/xv6-labs-2022/blob/note/notes/pictures/Figure3.2.png?raw=true"></p>
<ul>
<li>
<p>可以節省空間，如果沒有用到，就可以先不用分配空間</p>
</li>
<li>
<p>每個 page table entry(pte) 都有一些 flag:</p>
<ul>
<li>V - 這個 pte 是不是有沒有在使用</li>
<li>W - 可讀</li>
<li>X - 可執行</li>
<li>U - User 可不可以使用</li>
<li>A - 有沒有被訪問，為了 cache 而存在的</li>
<li>D - 為了 cache 而存在的 (xv6 不考慮 cache 的問題)</li>
</ul>
</li>
<li>
<p>什麼是 page table?</p>
<ul>
<li>virtul memory address 經由 page table 可以找到 physical memory address</li>
<li>所以說 <code>pagetable_t</code> 只需要紀錄這個 table 的 <strong>physical</strong> address 就可以了</li>
<li><code>pagetable_t</code> 紀錄的位置開始，總共有 2 ^ 9 = 512 個 pte</li>
<li>每個 pte 需要紀錄的東西:
<ul>
<li>總共有 64 bits
<ul>
<li>44 bits - Physical Page Number</li>
<li>2 bits - Reserved for supervisor software</li>
<li>1 bits - V</li>
<li>1 bits - W</li>
<li>1 bits - X</li>
<li>1 bits - U</li>
<li>1 bits - A</li>
<li>1 bits - D</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>為什麼 Physical page Number(PPN) 會是 44 bits?</p>
<ul>
<li>因為 physical address 是 56 bits =
<ul>
<li>44 bits physical page number +</li>
<li>12 bits offset</li>
<li>size of physical memory = 2 ^ 56</li>
<li>一個 pte 包含 address 的資訊
<ul>
<li>44 bits PPN</li>
<li>沒有 offset 因為 offset 已經存在於原本的 virtual memory 當中了</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>一個 page table 總共有多少個 pte?</p>
<ul>
<li>總共有 512(2 ^ 9) 個 pte</li>
<li>因為每個 level 都個拿了 9 bits 來當 page table 的 index</li>
</ul>
</li>
</ul>
<h3 id="xv6-中-關於-virtual-memory-的程式碼">xv6 中 關於 virtual memory 的程式碼<a hidden class="anchor" aria-hidden="true" href="#xv6-中-關於-virtual-memory-的程式碼">#</a></h3>
<p>這裡以 bottom up 的方式說明 xv6 如何實作 virtual memory</p>
<h4 id="先看幾個重要的檔案">先看幾個重要的檔案:<a hidden class="anchor" aria-hidden="true" href="#先看幾個重要的檔案">#</a></h4>
<ul>
<li><code>kernel/memlayout.h</code>: 定義了 layout</li>
<li><code>kernel/vm.c</code> 大多數處理 virtual memory 的程式碼都在這裡</li>
<li><code>kernel/kalloc.c</code>: 負責 allocate 以及 free 掉 physical memory</li>
</ul>
<h4 id="資料結構-pte_t-與-pagetable_t">資料結構 <code>pte_t</code> 與 <code>pagetable_t</code><a hidden class="anchor" aria-hidden="true" href="#資料結構-pte_t-與-pagetable_t">#</a></h4>
<pre tabindex="0"><code class="language-clike=" data-lang="clike=">// kernel/riscv.h
typedef uint64 pte_t;
typedef uint64 *pagetable_t; // 512 PTEs
</code></pre><p><code>pagetable_t</code> 與 <code>pte_t</code> 是 xv6 中用來處理 virtual memory 最重要的兩個資料結構，<code>pagetable_t</code> 用來紀錄一個 pagetable 的 <strong>physical</strong> memory; <code>pte_t</code> 如先前提到的圖，要紀錄 44 bits 的 physical page number 以及數個 flags</p>
<h4 id="用來基本操作的-macro-px-pte2pa-pa2pte-1">用來基本操作的 macro: <code>PX()</code>, <code>PTE2PA()</code>, <code>PA2PTE()</code><a hidden class="anchor" aria-hidden="true" href="#用來基本操作的-macro-px-pte2pa-pa2pte-1">#</a></h4>
<p>在 xv6 的 virtual memory 中，有 3 個重要的詞需要弄清楚，分別為:</p>
<ul>
<li>virtual memory address</li>
<li>physical memory address</li>
<li>pagetable
<ul>
<li>physical page number (PPN)</li>
</ul>
</li>
</ul>
<h5 id="px-解析-1"><code>PX()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#px-解析-1">#</a></h5>
<p>在 xv6 中，一個 virtual memory address 中有 3 個 9 bits 的 pagetable index，<code>PX()</code> 的功用就是把一個 virtual memory address 中的其中一個 level 的 9 physical page number (PPN) 取出來</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#define PX(level, va) ((((uint64) (va)) &gt;&gt; PXSHIFT(level)) &amp; PXMASK)
</span></span></span></code></pre></div><p>根據 level 把 virtual memory address 中的其中 9 bits PPN 移動到 64-bits 的最右邊</p>
<p>目前我們有了 <code>PX()</code>，可以從 va 中找到其中一個 PPN，如果現在有一個 pagetable，搭配上剛剛找到的 PPN，我們便可以找到對應的 PTE，舉例來說像是 <code>walk() at kernel/vm.c</code> 的其中一行：</p>
<pre tabindex="0"><code class="language-clike=" data-lang="clike=">// kernel/vm.c
pte_t *
walk(pagetable_t pagetable, uint64 va, int alloc)
{
  if(va &gt;= MAXVA)
    panic(&#34;walk&#34;);

  for(int level = 2; level &gt; 0; level--) {
    pte_t *pte = &amp;pagetable[PX(level, va)];         // 這一行！
    if(*pte &amp; PTE_V) {
      pagetable = (pagetable_t)PTE2PA(*pte);
    } else {
      if(!alloc || (pagetable = (pde_t*)kalloc()) == 0)
        return 0;
      memset(pagetable, 0, PGSIZE);
      *pte = PA2PTE(pagetable) | PTE_V;
    }
  }
  return &amp;pagetable[PX(0, va)];
}
</code></pre><p>就是一個使用到 <code>PX()</code> 的例子:</p>
<ol>
<li>利用 va, level 丟入 <code>PX()</code> 找到 PPN: <code>PX(level, va)</code></li>
<li>再利用這個 PPN(<code>PX(level, va)</code>) 從 pagetable 中拿到 page table entry (PPN)
<ul>
<li><code>&amp;pagetable[PX(level, va)]</code></li>
</ul>
</li>
</ol>
<h5 id="pte2pa-解析-1"><code>PTE2PA()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#pte2pa-解析-1">#</a></h5>
<p>剛剛我們已經利用了 <code>PX()</code> 讓 va 透過 pagetable 找到對應的 pte，拿到 pte 後，我們要有能力把這個 pte 轉換成 physical memory address (PA) 這才是我們最終的目的對吧: va 透過 pagetable 找到 pa</p>
<p>這正是 <code>PTE2PA()</code> 所要處理的事情</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#define PTE2PA(pte) (((pte) &gt;&gt; 10) &lt;&lt; 12)
</span></span></span></code></pre></div><p>把 pte 當中的 physical page number 擷取出來</p>
<h5 id="pa2pte-解析-1"><code>PA2PTE()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#pa2pte-解析-1">#</a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// shift a physical address to the right place for a PTE.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define PA2PTE(pa) ((((uint64)pa) &gt;&gt; 12) &lt;&lt; 10)
</span></span></span></code></pre></div><ul>
<li>把一個 physical memory 的 offset 去掉，並且做成一個 pte (shift left 10)</li>
<li>請注意這個做好的 pte 的 flag 的地方全部都是 0，需要自己把 flag 設定上</li>
</ul>
<h5 id="pgroundup-解析"><code>PGROUNDUP()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#pgroundup-解析">#</a></h5>
<h5 id="pgrounddown-解析"><code>PGROUNDDOWN()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#pgrounddown-解析">#</a></h5>
<p>現在我們有了 <code>PX()</code>, <code>PTE2PA()</code>, <code>PA2PTE()</code>，這幾個針對 virtual memory address, page table entry(pte) 以及 physical memory 的 macro,</p>
<h4 id="kernelvmc-walk-解析"><code>kernel/vm.c: walk()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#kernelvmc-walk-解析">#</a></h4>
<p>在大多數情況下，va 透過 pagetable 得到 pa 的動作，像是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>a <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
</span></span></code></pre></div><p>這種動作是由硬體完成的，risc-v 的 register <code>satp</code> 會紀錄當下 pagetable 的 <strong>physicall</strong> address
一旦有了 <code>satp</code> 所紀錄的這個 pagetable 的 physicall address，
硬體就有辦法把程式中的 va 藉由 pagetable(從 <code>satp</code> 得知) 轉換成 pa</p>
<p>可是在 kernel 中的<strong>某些地方</strong>(<code>todo</code>: 實際上在哪邊？)
會需要在程式中就直接拿到最後一個 level (level 0) 的 PTE (有點類似用軟體做出硬體的行為)
試想我們有一個 va 以及 pagetable，想要拿到最後一個 level 的 PTE，可以用 <code>walk()</code> 來達成:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Return the address of the PTE in page table pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// that corresponds to virtual address va.  If alloc!=0,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// create any required page-table pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 根據 virtual address va 以及 pate table patetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 回傳 PTE 的 address (physical memory)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The risc-v Sv39 scheme has three levels of page-table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// pages. A page-table page contains 512 64-bit PTEs.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// A 64-bit virtual address is split into five fields:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   39..63 -- must be zero.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   30..38 -- 9 bits of level-2 index.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   21..29 -- 9 bits of level-1 index.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   12..20 -- 9 bits of level-0 index.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    0..11 -- 12 bits of byte offset within the page.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">walk</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, <span style="color:#66d9ef">int</span> alloc) <span style="color:#75715e">// pagetable 紀錄的是 pa
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(va <span style="color:#f92672">&gt;=</span> MAXVA)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;walk&#34;</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// level 只會是 2, 1, 因為 level == 1 時
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 就會拿到指向 level 0 的 pagetable 的 pte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> level <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; level <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; level<span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pagetable[<span style="color:#a6e22e">PX</span>(level, va)]; <span style="color:#75715e">// get pte by virtual address and level (in physical address)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) {
</span></span><span style="display:flex;"><span>      pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pagetable_t</span>)<span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte); <span style="color:#75715e">// pagetable 是指向下一層的 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {    <span style="color:#75715e">// 如果這個 PTE 還沒有被 allocate，並且 alloc != 0 (alloc == true 的意思)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// 則 allocate 這個 PTE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>alloc <span style="color:#f92672">||</span> (pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pde_t</span><span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">// 使用 kalloc() 告訴 xv6: 我要一塊 page 來存放一個 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;                                       <span style="color:#75715e">// (pte_t *) 是想表達 pagetable 是 pte_t 的 array 的意思
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">memset</span>(pagetable, <span style="color:#ae81ff">0</span>, PGSIZE);   <span style="color:#75715e">// 清空 pagetable (注意這時候，memset 吃的是 pa, 可是 user mode 時，function 吃的是 va)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// level == 2 時，pte 指向一個 level 1 的 page table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">PA2PTE</span>(pagetable) <span style="color:#f92672">|</span> PTE_V; 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 到了這裡 pagetable 已經是一個 level 0 的 page table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 有了這個 page table 以及 va 中 level 0 的 9 bits 的 physical page number (PPN)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 就可以拿到最終我們要的 PTE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span>pagetable[<span style="color:#a6e22e">PX</span>(<span style="color:#ae81ff">0</span>, va)];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>walk()</code> 是用來根據 pagetable 以及 virtual memory address 來取得這個 vma 的 pte</li>
<li><code>pagetable_t</code> 紀錄的是 physical memory</li>
<li><code>walk()</code> 回傳 <code>pte_t *</code> 也就是 figure 3.2 所描述的那樣
<ul>
<li>54..63 &ndash; 10 bits Reserved</li>
<li>10..53 &ndash; 44 bits Physical Page Number</li>
<li>0..9  &ndash; 10 bits Flags</li>
</ul>
</li>
<li>有了 PTE 之後可以幹嘛?
<ul>
<li>有了 PTE 之後，就可以再利用 va 的 12 bits offset 來得到 pa</li>
<li>請注意，在大多數真正的 access pagetable 的情況下<strong>並不會</strong>使用 <code>walk()</code>，而是用硬體的方式處理</li>
</ul>
</li>
</ul>
<h4 id="mappages-解析-1"><code>mappages()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#mappages-解析-1">#</a></h4>
<p>現在我們有了一些 macro 可以處理 va, pa, page table, pte 的轉換</p>
<p><code>mappages()</code> 使用了情況為:
我們希望在 page table pagetale 中記下一筆資訊:
virtual address va 透過 pagetable 會對應到 physical address pa
並且這個對應是以一個 page (4096 bit) 做為一個單位去做 map 的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// kernel/riscv.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> uint64 <span style="color:#66d9ef">pte_t</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> uint64 <span style="color:#f92672">*</span><span style="color:#66d9ef">pagetable_t</span>; <span style="color:#75715e">// 512 PTEs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// kernel/vm.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mappages</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, uint64 size, uint64 pa, <span style="color:#66d9ef">int</span> perm)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 a, last;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;mappages: size&#34;</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// map 必須要以一個 page 為單位, 所以需要 round up 以及 round down
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  a <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(va);
</span></span><span style="display:flex;"><span>  last <span style="color:#f92672">=</span> <span style="color:#a6e22e">PGROUNDDOWN</span>(va <span style="color:#f92672">+</span> size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(;;){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 拿到 virtual address a 的 pte (walk() 會幫我們 allocate, 它使用 kalloc())
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(pagetable, a, <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">// walk 失敗時 return 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;mappages: remap&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在這裡，我們拿到了 pagetable, level 0, 對應到 va a 的 pte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 現在它還沒被賦予值，現在我們要告訴這個 PTE，你要指到 pa 去!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">PA2PTE</span>(pa) <span style="color:#f92672">|</span> perm <span style="color:#f92672">|</span> PTE_V; <span style="color:#75715e">// pte 對應到了 pa
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(a <span style="color:#f92672">==</span> last)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">+=</span> PGSIZE;
</span></span><span style="display:flex;"><span>    pa <span style="color:#f92672">+=</span> PGSIZE;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>mappages()</code> 是用來把一個 pa 塞進一個 pagetable 裡，並且我們可以指定它的 va 以及 flag</p>
<h4 id="proc_pagetable-解析-1"><code>proc_pagetable()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#proc_pagetable-解析-1">#</a></h4>
<p><code>proc_pagetable()</code> 用來初始化一個新的 process</p>
<pre tabindex="0"><code class="language-clike=" data-lang="clike=">// Create a user page table for a given process, with no user memory,
// but with trampoline and trapframe pages.
// 把一個 process 的 pagetable 做出來，
// 但這時候只有 trampoline 跟 trapframe 有被紀錄在 page table 中
pagetable_t
proc_pagetable(struct proc *p)
{
  pagetable_t pagetable;

  // An empty page table.
  pagetable = uvmcreate();
  if(pagetable == 0)
    return 0;

  // map the trampoline code (for system call return)
  // at the highest user virtual address.
  // only the supervisor uses it, on the way
  // to/from user space, so not PTE_U.
  if(mappages(pagetable, TRAMPOLINE, PGSIZE,
              (uint64)trampoline, PTE_R | PTE_X) &lt; 0){
    uvmfree(pagetable, 0);
    return 0;
  }

  // map the trapframe page just below the trampoline page, for
  // trampoline.S.
  if(mappages(pagetable, TRAPFRAME, PGSIZE,
              (uint64)(p-&gt;trapframe), PTE_R | PTE_W) &lt; 0){
    uvmunmap(pagetable, TRAMPOLINE, 1, 0);
    uvmfree(pagetable, 0);
    return 0;
  }

  return pagetable;
}
</code></pre><ul>
<li><code>proc_pagetable()</code> 所做的事情也就是 allocate <code>struct proc *p</code> 的 pagetable</li>
<li>會需要先了解的 function 有
<ul>
<li><code>mappages()</code></li>
<li><code>uvmcreate()</code></li>
<li><code>uvmunmap()</code></li>
<li><code>uvmfree()</code></li>
</ul>
</li>
</ul>
<h4 id="uvmcreate-解析-1"><code>uvmcreate()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#uvmcreate-解析-1">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// create an empty user page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// returns 0 if out of memory.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pagetable_t</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmcreate</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pagetable_t</span> pagetable;
</span></span><span style="display:flex;"><span>  pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pagetable_t</span>) <span style="color:#a6e22e">kalloc</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(pagetable <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(pagetable, <span style="color:#ae81ff">0</span>, PGSIZE);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pagetable;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>uvmcreate()</code> 利用 <code>kalloc()</code> 做出一個全新的 pagetable</li>
<li>請注意，pagetable 所紀錄的是 physical memory</li>
</ul>
<h4 id="uvmunmap-解析"><code>uvmunmap()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#uvmunmap-解析">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Remove npages of mappings starting from va. va must be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// page-aligned. The mappings must exist.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Optionally free the physical memory.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmunmap</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 va, uint64 npages, <span style="color:#66d9ef">int</span> do_free)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 a;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>((va <span style="color:#f92672">%</span> PGSIZE) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmunmap: not aligned&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(a <span style="color:#f92672">=</span> va; a <span style="color:#f92672">&lt;</span> va <span style="color:#f92672">+</span> npages<span style="color:#f92672">*</span>PGSIZE; a <span style="color:#f92672">+=</span> PGSIZE){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(pagetable, a, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">// 如果這個要被 unmap 的 page (virtual address) 根本不存在
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmunmap: walk&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#960050;background-color:#1e0010">它應該要是</span> valid
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmunmap: not mapped&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">PTE_FLAGS</span>(<span style="color:#f92672">*</span>pte) <span style="color:#f92672">==</span> PTE_V)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmunmap: not a leaf&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(do_free){
</span></span><span style="display:flex;"><span>      uint64 pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)pa);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>uvmunmap()</code></li>
<li><code>va</code> 必須為 <code>PGSIZE</code> 的倍數</li>
<li>unmap 跟 free 是兩回事
<ul>
<li>free: 把這個 physical address 加回 <code>kmem.freelist</code> 中
<ul>
<li>也就是要用 <code>kfree((void *) pa)</code></li>
</ul>
</li>
<li>unmap: 僅限於對於這個 pagetable 而言，把這個 virtual memory address 移除
<ul>
<li>所謂的移除，也就是把最後一層的 page table entry 給清為 0 <code>*pte = 0</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="uvmfree-解析-1"><code>uvmfree()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#uvmfree-解析-1">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Free user memory pages,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// then free page-table pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmfree</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(sz <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmunmap</span>(pagetable, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">PGROUNDUP</span>(sz)<span style="color:#f92672">/</span>PGSIZE, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">freewalk</span>(pagetable);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="kalloc-解析-1"><code>kalloc()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#kalloc-解析-1">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Allocate one 4096-byte page of physical memory.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Returns a pointer that the kernel can use.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Returns 0 if the memory cannot be allocated.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kalloc</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> run <span style="color:#f92672">*</span>r;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>kmem.lock);
</span></span><span style="display:flex;"><span>  r <span style="color:#f92672">=</span> kmem.freelist;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(r)
</span></span><span style="display:flex;"><span>    kmem.freelist <span style="color:#f92672">=</span> r<span style="color:#f92672">-&gt;</span>next;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>kmem.lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(r)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)r, <span style="color:#ae81ff">5</span>, PGSIZE); <span style="color:#75715e">// fill with junk
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)r;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>在 xv6 中，所有可以用的 page 會被紀錄在 <code>kmem.freelist</code> 當中</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> run {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> run <span style="color:#f92672">*</span>next;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> spinlock lock;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> run <span style="color:#f92672">*</span>freelist;
</span></span><span style="display:flex;"><span>} kmem;
</span></span></code></pre></div><ul>
<li><code>kalloc()</code> 回傳一個 4096-byte 的 page</li>
<li>這是一個 pointer 指向 physical memory</li>
<li>kmem 的初始化過程很值得追蹤</li>
</ul>
<h4 id="uvmcopy-解析-1"><code>uvmcopy()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#uvmcopy-解析-1">#</a></h4>
<ul>
<li><code>uvmcopy()</code> 是用來把一個 parent 的 page table 複製給 child，</li>
<li>包含了 page table 以及 physical memory 的內容</li>
<li>失敗時回傳 -1，並且把先前 allocate 的 page 都給 free 掉</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// 把 old 的內容複製給 new
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// sz 為 page 的數量，每個 page 的大小為 4096 byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">uvmcopy</span>(<span style="color:#66d9ef">pagetable_t</span> old, <span style="color:#66d9ef">pagetable_t</span> new, uint64 sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>  uint64 pa, i;
</span></span><span style="display:flex;"><span>  uint flags;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>mem;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> sz; i <span style="color:#f92672">+=</span> PGSIZE){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(old, i, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)            <span style="color:#75715e">// 拿到一個 parent 的 pte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmcopy: pte should exist&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;uvmcopy: page not present&#34;</span>);
</span></span><span style="display:flex;"><span>    pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(<span style="color:#f92672">*</span>pte);                          <span style="color:#75715e">// 用 parent 的 pte 拿到 physical address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    flags <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE_FLAGS</span>(<span style="color:#f92672">*</span>pte);                    <span style="color:#75715e">// 拿到 parent 的 pte 的 flags
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>((mem <span style="color:#f92672">=</span> <span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)                   <span style="color:#75715e">// mem 是 child 的 physical memory (其中一個 page)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">goto</span> err;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memmove</span>(mem, (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pa, PGSIZE);            <span style="color:#75715e">// parent 的內容搬到 child 的 memory 中 (都用 pa)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 現在有了 mem (一個 page 的 pa)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 接下來要把這個 page map 到 child 的 pagetable (new) 中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(new, i, PGSIZE, (uint64)mem, flags) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">kfree</span>(mem);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> err;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> err:
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(new, <span style="color:#ae81ff">0</span>, i <span style="color:#f92672">/</span> PGSIZE, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="memmove-解析-1"><code>memmove()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#memmove-解析-1">#</a></h4>
<p><code>memmove()</code> 把 n bytes 的內容從 <code>src</code> 搬到 <code>dst</code></p>
<ul>
<li>是 pa or va ?????</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memmove</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>dst, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>src, uint n)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>s;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>d;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(n <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> dst;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  s <span style="color:#f92672">=</span> src;
</span></span><span style="display:flex;"><span>  d <span style="color:#f92672">=</span> dst;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(s <span style="color:#f92672">&lt;</span> d <span style="color:#f92672">&amp;&amp;</span> s <span style="color:#f92672">+</span> n <span style="color:#f92672">&gt;</span> d){
</span></span><span style="display:flex;"><span>    s <span style="color:#f92672">+=</span> n;
</span></span><span style="display:flex;"><span>    d <span style="color:#f92672">+=</span> n;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(n<span style="color:#f92672">--</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*--</span>d <span style="color:#f92672">=</span> <span style="color:#f92672">*--</span>s;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 這個 loop 也寫的太騷了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(n<span style="color:#f92672">--</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>d<span style="color:#f92672">++</span> <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>s<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> dst;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="malloc-解析-1"><code>malloc()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#malloc-解析-1">#</a></h4>
<p><code>malloc()</code> 用來 allocate <code>nbytes</code> 個 bytes 的記憶體空間</p>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">void*
malloc(uint nbytes)
{
  Header *p, *prevp;
  uint nunits;

  nunits = (nbytes + sizeof(Header) - 1)/sizeof(Header) + 1;
  if((prevp = freep) == 0){
    base.s.ptr = freep = prevp = &amp;base;
    base.s.size = 0;
  }
  for(p = prevp-&gt;s.ptr; ; prevp = p, p = p-&gt;s.ptr){
    if(p-&gt;s.size &gt;= nunits){
      if(p-&gt;s.size == nunits)
        prevp-&gt;s.ptr = p-&gt;s.ptr;
      else {
        p-&gt;s.size -= nunits;
        p += p-&gt;s.size;
        p-&gt;s.size = nunits;
      }
      freep = prevp;
      return (void*)(p + 1);
    }
    if(p == freep)
      if((p = morecore(nunits)) == 0)
        return 0;
  }
}
</code></pre><h4 id="copyout-解析-1"><code>copyout()</code> 解析<a hidden class="anchor" aria-hidden="true" href="#copyout-解析-1">#</a></h4>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">// Copy from kernel to user.
// Copy len bytes from src to virtual address dstva in a given page table.
// Return 0 on success, -1 on error.
int
copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len)
{
  uint64 n, va0, pa0;

  while(len &gt; 0){
    va0 = PGROUNDDOWN(dstva);
    pa0 = walkaddr(pagetable, va0);
    if(pa0 == 0)
      return -1;
    n = PGSIZE - (dstva - va0);
    if(n &gt; len)
      n = len;
    memmove((void *)(pa0 + (dstva - va0)), src, n);

    len -= n;
    src += n;
    dstva = va0 + PGSIZE;
  }
  return 0;
}
</code></pre><ul>
<li><code>src</code> 是 pa or va ???</li>
</ul>
<h2 id="2-lab">2. lab<a hidden class="anchor" aria-hidden="true" href="#2-lab">#</a></h2>
<p>這個 lab 的測試程式寫在 <code>user/pgtbltest.c</code></p>
<h2 id="21-speed-up-system-calls">2.1 Speed up system calls<a hidden class="anchor" aria-hidden="true" href="#21-speed-up-system-calls">#</a></h2>
<h3 id="目標寫出-ugetpid-優化版本的-getpid">目標：寫出 <code>ugetpid()</code> (優化版本的 <code>getpid()</code>)<a hidden class="anchor" aria-hidden="true" href="#目標寫出-ugetpid-優化版本的-getpid">#</a></h3>
<ul>
<li><code>getpid()</code>:
<ul>
<li>會需要使用到 <code>SYS_getpid</code> 這個 system call</li>
<li>但是使用 system call 本身是耗費時間的</li>
</ul>
</li>
<li><code>ugetpid()</code>
<ul>
<li>這個 function 直接不需要經由 system call 就可以達到相同的效果</li>
</ul>
</li>
</ul>
<h3 id="作法">作法<a hidden class="anchor" aria-hidden="true" href="#作法">#</a></h3>
<p>當一個 proccess 開始執行時，在 virtual memory address <code>USYSCALL</code>(定義在 <code>kernel/memlayout.h</code>) 中存放 <code>struct usyscall</code> 並且把 PID 存放於這個 struct 中。<code>ugetpid()</code> 是一個 user space 就可以執行的 function，所以可以跳過原本的 system call 的過程，以達到加速的效果。</p>
<h3 id="some-hints">Some hints<a hidden class="anchor" aria-hidden="true" href="#some-hints">#</a></h3>
<ul>
<li>可以把這個 mapping 實作在 <code>proc_pagetable()</code> 這個 function 中</li>
</ul>
<h3 id="疑問">疑問<a hidden class="anchor" aria-hidden="true" href="#疑問">#</a></h3>
<h3 id="測試-userpgtbltestc-ugetpid_test">測試 (<code>user/pgtbltest.c: ugetpid_test()</code>)：<a hidden class="anchor" aria-hidden="true" href="#測試-userpgtbltestc-ugetpid_test">#</a></h3>
<pre tabindex="0"><code class="language-clike=" data-lang="clike=">void
ugetpid_test()
{
  int i;

  printf(&#34;ugetpid_test starting\n&#34;);
  testname = &#34;ugetpid_test&#34;;

  for (i = 0; i &lt; 64; i++) {
    int ret = fork();
    if (ret != 0) {
      wait(&amp;ret);
      if (ret != 0)
        exit(1);
      continue;
    
    }
    if (getpid() != ugetpid())
      err(&#34;missmatched PID&#34;);
    exit(0);
  
  }
  printf(&#34;ugetpid_test: OK\n&#34;);
}
</code></pre><h3 id="原本的-getpid-的流程為何">原本的 <code>getpid()</code> 的流程為何<a hidden class="anchor" aria-hidden="true" href="#原本的-getpid-的流程為何">#</a></h3>
<ul>
<li><code>user/pgtbltest.c: ugetpid_test()</code>
<ul>
<li><code>getpid()</code>
<ul>
<li><code>usys.S</code></li>
</ul>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 152 89"
      >
      <g transform='translate(8,16)'>
<text text-anchor='middle' x='0' y='4' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='0' y='20' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='8' y='4' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='8' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='8' y='36' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='8' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='8' y='68' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='16' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='16' y='20' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='16' y='36' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='16' y='52' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='16' y='68' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='24' y='4' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='24' y='20' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='24' y='52' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='24' y='68' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='32' y='4' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='32' y='20' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='32' y='36' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='32' y='52' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='40' y='4' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='40' y='20' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='40' y='36' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='40' y='52' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='48' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='48' y='20' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='48' y='36' fill='currentColor' style='font-size:1em'>,</text>
<text text-anchor='middle' x='64' y='4' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='64' y='36' fill='currentColor' style='font-size:1em'>S</text>
<text text-anchor='middle' x='72' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='72' y='36' fill='currentColor' style='font-size:1em'>Y</text>
<text text-anchor='middle' x='80' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='80' y='36' fill='currentColor' style='font-size:1em'>S</text>
<text text-anchor='middle' x='88' y='4' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='88' y='36' fill='currentColor' style='font-size:1em'>_</text>
<text text-anchor='middle' x='96' y='4' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='96' y='36' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='104' y='4' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='104' y='36' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='112' y='36' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='120' y='36' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='128' y='36' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='136' y='36' fill='currentColor' style='font-size:1em'>d</text>
</g>

    </svg>
  
</div>
<pre><code>  * `kernel/trampoline.S: uservec`
      * `kernel/trap.c: usertrap()`
          * `syscall.c: syscall()`
              * `sysproc.c: sys_getpid()`
                  * `myproc()`
      * `kernel/trampoline.S: uservec`
</code></pre>
</li>
</ul>
</li>
</ul>
<pre tabindex="0"><code class="language-clike=" data-lang="clike=">uint64
sys_getpid(void)
{
  return myproc()-&gt;pid;
}
</code></pre><h3 id="優化版的-getpid-的流程為何">優化版的 <code>getpid()</code> 的流程為何<a hidden class="anchor" aria-hidden="true" href="#優化版的-getpid-的流程為何">#</a></h3>
<ul>
<li><code>user/pgtbltest.c: ugetpid_test()</code>
<ul>
<li><code>ugetpid()</code>
<ul>
<li><code>user/ulib.c: ugetpid()</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// ulib.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ugetpid</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> usyscall <span style="color:#f92672">*</span>u <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> usyscall <span style="color:#f92672">*</span>)USYSCALL;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> u<span style="color:#f92672">-&gt;</span>pid;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="程式實作">程式實作<a hidden class="anchor" aria-hidden="true" href="#程式實作">#</a></h3>
<h4 id="usyscall-題目幫我們定義好了"><code>usyscall</code> 題目幫我們定義好了<a hidden class="anchor" aria-hidden="true" href="#usyscall-題目幫我們定義好了">#</a></h4>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">// kernel/memlayout.h
struct usyscall {
  int pid;  // Process ID
};
</code></pre><p>之後每一個 process 都會存放一份 <code>usyscall</code></p>
<h4 id="kernelproch-中"><code>kernel/proc.h</code> 中<a hidden class="anchor" aria-hidden="true" href="#kernelproch-中">#</a></h4>
<p>先在 <code>proc_pagetable()</code> 中加入</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Per-process state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> proc {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> spinlock lock;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// p-&gt;lock must be held when using these:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">enum</span> procstate state;        <span style="color:#75715e">// Process state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>chan;                  <span style="color:#75715e">// If non-zero, sleeping on chan
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> killed;                  <span style="color:#75715e">// If non-zero, have been killed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> xstate;                  <span style="color:#75715e">// Exit status to be returned to parent&#39;s wait
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> pid;                     <span style="color:#75715e">// Process ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// wait_lock must be held when using this:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>parent;         <span style="color:#75715e">// Parent process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// these are private to the process, so p-&gt;lock need not be held.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 kstack;               <span style="color:#75715e">// Virtual address of kernel stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 sz;                   <span style="color:#75715e">// Size of process memory (bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pagetable_t</span> pagetable;       <span style="color:#75715e">// User page table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> trapframe <span style="color:#f92672">*</span>trapframe; <span style="color:#75715e">// data page for trampoline.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> context context;      <span style="color:#75715e">// swtch() here to run process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>ofile[NOFILE];  <span style="color:#75715e">// Open files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>cwd;           <span style="color:#75715e">// Current directory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> name[<span style="color:#ae81ff">16</span>];               <span style="color:#75715e">// Process name (debugging)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> usyscall <span style="color:#f92672">*</span>usyscall;   <span style="color:#75715e">// add this !!!!!!!!!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><p>準備好 data 之後，指後要在 allocate 時以及 free 時做一些處理</p>
<h4 id="allocate-時">allocate 時:<a hidden class="anchor" aria-hidden="true" href="#allocate-時">#</a></h4>
<ul>
<li><code>kernel/proc.c: allocproc()</code></li>
<li><code>kernel/proc.c: proc_pagetable()</code></li>
</ul>
<h4 id="free-時">free 時:<a hidden class="anchor" aria-hidden="true" href="#free-時">#</a></h4>
<ul>
<li><code>kernel/proc.c: freeproc()</code></li>
<li><code>kernel/proc.c: proc_freepagetable()</code></li>
</ul>
<h4 id="kernelprocc-allocproc"><code>kernel/proc.c: allocproc()</code><a hidden class="anchor" aria-hidden="true" href="#kernelprocc-allocproc">#</a></h4>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">static struct proc*
allocproc(void)
{
  struct proc *p;

  for(p = proc; p &lt; &amp;proc[NPROC]; p++) {
    acquire(&amp;p-&gt;lock);
    if(p-&gt;state == UNUSED) {
      goto found;
    } else {
      release(&amp;p-&gt;lock);
    }
  }
  return 0;

found:
  p-&gt;pid = allocpid();
  p-&gt;state = USED;

  // Allocate a trapframe page.
  if((p-&gt;trapframe = (struct trapframe *)kalloc()) == 0){
    freeproc(p);
    release(&amp;p-&gt;lock);
    return 0;
  }

  // Allocate and initialize a usyscall page !!!!!!!!!!!
  if((p-&gt;usyscall = (struct usyscall *)kalloc()) == 0){ // here!
    freeproc(p);
    release(&amp;p-&gt;lock);
    return 0;
  }
  p-&gt;usyscall-&gt;pid = p-&gt;pid; !!!!!!!!!!!!!!

  // An empty user page table.
  p-&gt;pagetable = proc_pagetable(p);
  if(p-&gt;pagetable == 0){
    freeproc(p);
    release(&amp;p-&gt;lock);
    return 0;
  }

  // Set up new context to start executing at forkret,
  // which returns to user space.
  memset(&amp;p-&gt;context, 0, sizeof(p-&gt;context));
  p-&gt;context.ra = (uint64)forkret;
  p-&gt;context.sp = p-&gt;kstack + PGSIZE;

  return p;
}
</code></pre><h4 id="kernelprocc-proc_pagetable-中"><code>kernel/proc.c: proc_pagetable()</code> 中<a hidden class="anchor" aria-hidden="true" href="#kernelprocc-proc_pagetable-中">#</a></h4>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">// Create a user page table for a given process, with no user memory,
// but with trampoline and trapframe pages.
pagetable_t
proc_pagetable(struct proc *p)
{
  pagetable_t pagetable;

  // An empty page table.
  pagetable = uvmcreate();
  if(pagetable == 0)
    return 0;

  // map the trampoline code (for system call return)
  // at the highest user virtual address.
  // only the supervisor uses it, on the way
  // to/from user space, so not PTE_U.
  if(mappages(pagetable, TRAMPOLINE, PGSIZE,
              (uint64)trampoline, PTE_R | PTE_X) &lt; 0){
    uvmfree(pagetable, 0);
    return 0;
  }

  // map the trapframe page just below the trampoline page, for
  // trampoline.S.
  if(mappages(pagetable, TRAPFRAME, PGSIZE,
              (uint64)(p-&gt;trapframe), PTE_R | PTE_W) &lt; 0){
    uvmunmap(pagetable, TRAMPOLINE, 1, 0);
    uvmfree(pagetable, 1);
    return 0;
  }

  // map one read-only page at USYSCALL !!!!!!!!!!!!!!!!!!!!!!!
  if(mappages(pagetable, USYSCALL, PGSIZE,
              (uint64)(p-&gt;usyscall), PTE_R | PTE_U) &lt; 0){
    uvmunmap(pagetable, TRAMPOLINE, 1, 0); // 注意是 unmap 己經被 map 好的 TRAMPOLINE, TRAPFRAME
    uvmunmap(pagetable, TRAPFRAME, 1, 0);
    uvmfree(pagetable, 0);
    return 0;
  }

  return pagetable;
}
</code></pre><h4 id="kernelprocc-freeproc"><code>kernel/proc.c: freeproc()</code><a hidden class="anchor" aria-hidden="true" href="#kernelprocc-freeproc">#</a></h4>
<p>怎麼知道這裡要處理？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// free a proc structure and the data hanging from it,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// including user pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// p-&gt;lock must be held.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">freeproc</span>(<span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>trapframe)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)p<span style="color:#f92672">-&gt;</span>trapframe);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>trapframe <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// free usyscall !!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (proc<span style="color:#f92672">-&gt;</span>usyscall)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>) p<span style="color:#f92672">-&gt;</span>usyscall);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>usyscall <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>pagetable)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">proc_freepagetable</span>(p<span style="color:#f92672">-&gt;</span>pagetable, p<span style="color:#f92672">-&gt;</span>sz);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>pagetable <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>pid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>parent <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>name[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>chan <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>killed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>xstate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> UNUSED;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="kernelprocc-proc_freepagetable"><code>kernel/proc.c: proc_freepagetable()</code><a hidden class="anchor" aria-hidden="true" href="#kernelprocc-proc_freepagetable">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Free a process&#39;s page table, and free the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// physical memory it refers to.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">proc_freepagetable</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAMPOLINE, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAPFRAME, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(pagetable, USYSCALL, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>); <span style="color:#75715e">// unmap USYSCALL !!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">uvmfree</span>(pagetable, sz);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="22-print-a-page-table">2.2 Print a page table<a hidden class="anchor" aria-hidden="true" href="#22-print-a-page-table">#</a></h2>
<p>prints the contents of a page table
Define a function called <code>vmprint()</code>.
It should take a <code>pagetable_t</code> argument, and print that pagetable in the format described below.
Insert <code>if(p-&gt;pid==1) vmprint(p-&gt;pagetable)</code> in <code>exec.c</code> just before the return argc, to print the first process&rsquo;s page table.
You receive full credit for this part of the lab if you pass the pte printout test of make grade.</p>
<ul>
<li>You can put <code>vmprint()</code> in <code>kernel/vm.c</code>.</li>
<li>Use the macros at the end of the file <code>kernel/riscv.h</code>.</li>
<li>The function freewalk may be inspirational.</li>
<li>Define the prototype for <code>vmprint</code> in <code>kernel/defs.h</code> so that you can call it from <code>exec.c</code>.</li>
<li>Use <code>%p</code> in your <code>printf</code> calls to print out full 64-bit hex PTEs and addresses as shown in the example.</li>
</ul>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 472 217"
      >
      <g transform='translate(8,16)'>
<path d='M 8,16 L 8,32' fill='none' stroke='currentColor'></path>
<path d='M 8,32 L 8,48' fill='none' stroke='currentColor'></path>
<path d='M 8,48 L 8,64' fill='none' stroke='currentColor'></path>
<path d='M 8,64 L 8,80' fill='none' stroke='currentColor'></path>
<path d='M 8,80 L 8,96' fill='none' stroke='currentColor'></path>
<path d='M 8,96 L 8,112' fill='none' stroke='currentColor'></path>
<path d='M 8,112 L 8,128' fill='none' stroke='currentColor'></path>
<path d='M 8,128 L 8,144' fill='none' stroke='currentColor'></path>
<path d='M 8,144 L 8,160' fill='none' stroke='currentColor'></path>
<path d='M 8,160 L 8,176' fill='none' stroke='currentColor'></path>
<path d='M 16,32 L 16,48' fill='none' stroke='currentColor'></path>
<path d='M 16,48 L 16,64' fill='none' stroke='currentColor'></path>
<path d='M 16,64 L 16,80' fill='none' stroke='currentColor'></path>
<path d='M 16,80 L 16,96' fill='none' stroke='currentColor'></path>
<path d='M 16,128 L 16,144' fill='none' stroke='currentColor'></path>
<path d='M 16,144 L 16,160' fill='none' stroke='currentColor'></path>
<path d='M 16,160 L 16,176' fill='none' stroke='currentColor'></path>
<path d='M 32,32 L 32,48' fill='none' stroke='currentColor'></path>
<path d='M 32,48 L 32,64' fill='none' stroke='currentColor'></path>
<path d='M 32,64 L 32,80' fill='none' stroke='currentColor'></path>
<path d='M 32,80 L 32,96' fill='none' stroke='currentColor'></path>
<path d='M 32,128 L 32,144' fill='none' stroke='currentColor'></path>
<path d='M 32,144 L 32,160' fill='none' stroke='currentColor'></path>
<path d='M 32,160 L 32,176' fill='none' stroke='currentColor'></path>
<path d='M 40,48 L 40,64' fill='none' stroke='currentColor'></path>
<path d='M 40,64 L 40,80' fill='none' stroke='currentColor'></path>
<path d='M 40,80 L 40,96' fill='none' stroke='currentColor'></path>
<path d='M 40,144 L 40,160' fill='none' stroke='currentColor'></path>
<path d='M 40,160 L 40,176' fill='none' stroke='currentColor'></path>
<path d='M 56,48 L 56,64' fill='none' stroke='currentColor'></path>
<path d='M 56,64 L 56,80' fill='none' stroke='currentColor'></path>
<path d='M 56,80 L 56,96' fill='none' stroke='currentColor'></path>
<path d='M 56,144 L 56,160' fill='none' stroke='currentColor'></path>
<path d='M 56,160 L 56,176' fill='none' stroke='currentColor'></path>
<text text-anchor='middle' x='0' y='4' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='0' y='196' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='8' y='4' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='8' y='196' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='16' y='4' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='16' y='20' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='16' y='116' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='16' y='196' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='24' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='24' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='24' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='24' y='196' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='32' y='20' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='32' y='116' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='32' y='196' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='40' y='4' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='40' y='36' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='40' y='116' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='40' y='132' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='48' y='4' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='48' y='20' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='48' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='48' y='116' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='48' y='132' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='48' y='196' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='56' y='4' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='56' y='20' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='56' y='36' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='56' y='132' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='56' y='196' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='64' y='4' fill='currentColor' style='font-size:1em'>l</text>
<text text-anchor='middle' x='64' y='20' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='64' y='52' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='64' y='68' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='64' y='84' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='64' y='100' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='64' y='116' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='64' y='132' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='64' y='148' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='64' y='164' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='64' y='180' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='64' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='72' y='4' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='72' y='36' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='72' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='72' y='68' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='72' y='84' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='72' y='100' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='72' y='116' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='72' y='132' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='72' y='148' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='72' y='164' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='72' y='180' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='72' y='196' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='80' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='80' y='36' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='80' y='52' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='80' y='68' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='80' y='84' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='80' y='100' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='80' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='80' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='80' y='164' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='80' y='180' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='80' y='196' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='88' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='88' y='20' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='88' y='36' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='88' y='132' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='88' y='148' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='88' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='88' y='180' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='88' y='196' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='96' y='4' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='96' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='96' y='52' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='96' y='68' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='96' y='84' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='96' y='100' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='96' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='96' y='132' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='96' y='148' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='96' y='164' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='96' y='180' fill='currentColor' style='font-size:1em'>:</text>
<text text-anchor='middle' x='96' y='196' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='104' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='104' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='104' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='104' y='52' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='104' y='68' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='104' y='84' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='104' y='100' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='104' y='116' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='104' y='132' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='104' y='196' fill='currentColor' style='font-size:1em'>g</text>
<text text-anchor='middle' x='112' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='112' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='112' y='36' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='112' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='112' y='68' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='112' y='84' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='112' y='100' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='112' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='112' y='148' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='112' y='164' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='112' y='180' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='120' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='120' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='120' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='120' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='120' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='120' y='148' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='120' y='164' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='120' y='180' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='120' y='196' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='128' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='128' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='128' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='128' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='128' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='128' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='128' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='128' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='128' y='132' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='128' y='148' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='128' y='164' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='128' y='180' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='128' y='196' fill='currentColor' style='font-size:1em'>h</text>
<text text-anchor='middle' x='136' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='136' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='136' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='136' y='52' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='136' y='68' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='136' y='84' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='136' y='100' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='136' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='136' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='144' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='152' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='152' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='152' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='152' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='152' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='152' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='152' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='152' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='152' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='152' y='148' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='152' y='164' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='152' y='180' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='160' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='160' y='20' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='160' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='160' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='160' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='160' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='160' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='160' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='160' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='160' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='160' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='160' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='168' y='4' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='168' y='20' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='168' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='168' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='168' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='168' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='168' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='168' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='168' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='168' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='168' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='168' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='176' y='4' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='176' y='20' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='176' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='176' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='176' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='176' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='176' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='176' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='176' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='176' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='176' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='176' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='184' y='4' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='184' y='20' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='184' y='36' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='184' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='184' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='184' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='184' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='184' y='116' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='184' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='184' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='184' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='184' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='192' y='4' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='192' y='20' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='192' y='36' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='192' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='192' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='192' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='192' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='192' y='116' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='192' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='192' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='192' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='192' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='200' y='4' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='200' y='20' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='200' y='36' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='200' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='200' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='200' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='200' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='200' y='116' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='200' y='132' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='200' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='200' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='200' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='208' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='208' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='208' y='36' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='208' y='52' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='208' y='68' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='208' y='84' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='208' y='100' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='208' y='116' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='208' y='132' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='208' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='208' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='208' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='216' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='216' y='20' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='216' y='36' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='216' y='52' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='216' y='68' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='216' y='84' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='216' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='216' y='116' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='216' y='132' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='216' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='216' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='216' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='224' y='4' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='224' y='36' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='224' y='52' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='224' y='68' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='224' y='84' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='224' y='100' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='224' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='224' y='132' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='224' y='148' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='224' y='164' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='224' y='180' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='232' y='20' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='232' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='232' y='52' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='232' y='68' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='232' y='84' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='232' y='100' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='232' y='116' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='232' y='132' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='232' y='148' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='232' y='164' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='232' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='240' y='20' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='240' y='36' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='240' y='52' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='240' y='68' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='240' y='84' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='240' y='100' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='240' y='132' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='240' y='148' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='240' y='164' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='240' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='248' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='248' y='68' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='248' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='248' y='100' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='248' y='116' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='248' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='248' y='148' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='248' y='164' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='248' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='256' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='256' y='36' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='256' y='52' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='256' y='68' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='256' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='256' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='256' y='116' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='256' y='132' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='256' y='148' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='256' y='164' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='256' y='180' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='264' y='20' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='264' y='36' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='264' y='52' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='264' y='68' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='264' y='84' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='264' y='100' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='264' y='148' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='264' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='264' y='180' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='272' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='272' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='272' y='132' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='272' y='148' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='272' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='272' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='280' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='280' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='280' y='52' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='280' y='68' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='280' y='84' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='280' y='100' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='280' y='116' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='280' y='132' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='280' y='148' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='280' y='164' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='280' y='180' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='288' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='288' y='36' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='288' y='52' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='288' y='68' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='288' y='84' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='288' y='100' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='288' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='296' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='296' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='296' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='296' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='296' y='148' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='296' y='164' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='296' y='180' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='304' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='304' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='304' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='304' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='304' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='304' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='304' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='304' y='132' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='304' y='148' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='304' y='164' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='304' y='180' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='312' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='312' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='312' y='52' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='312' y='68' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='312' y='84' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='312' y='100' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='312' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='312' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='320' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='328' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='328' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='328' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='328' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='328' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='328' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='328' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='328' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='328' y='148' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='328' y='164' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='328' y='180' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='336' y='20' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='336' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='336' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='336' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='336' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='336' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='336' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='336' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='336' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='336' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='336' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='344' y='20' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='344' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='344' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='344' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='344' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='344' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='344' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='344' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='344' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='344' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='344' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='352' y='20' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='352' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='352' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='352' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='352' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='352' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='352' y='116' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='352' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='352' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='352' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='352' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='360' y='20' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='360' y='36' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='360' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='360' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='360' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='360' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='360' y='116' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='360' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='360' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='360' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='360' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='368' y='20' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='368' y='36' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='368' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='368' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='368' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='368' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='368' y='116' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='368' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='368' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='368' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='368' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='376' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='376' y='36' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='376' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='376' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='376' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='376' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='376' y='116' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='376' y='132' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='376' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='376' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='376' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='384' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='384' y='36' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='384' y='52' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='384' y='68' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='384' y='84' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='384' y='100' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='384' y='116' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='384' y='132' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='384' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='384' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='384' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='392' y='20' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='392' y='36' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='392' y='52' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='392' y='68' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='392' y='84' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='392' y='100' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='392' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='392' y='132' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='392' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='392' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='392' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='400' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='400' y='52' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='400' y='68' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='400' y='84' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='400' y='100' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='400' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='400' y='132' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='400' y='148' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='400' y='164' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='400' y='180' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='408' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='408' y='52' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='408' y='68' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='408' y='84' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='408' y='100' fill='currentColor' style='font-size:1em'>6</text>
<text text-anchor='middle' x='408' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='408' y='132' fill='currentColor' style='font-size:1em'>9</text>
<text text-anchor='middle' x='408' y='148' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='408' y='164' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='408' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='416' y='36' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='416' y='52' fill='currentColor' style='font-size:1em'>8</text>
<text text-anchor='middle' x='416' y='68' fill='currentColor' style='font-size:1em'>5</text>
<text text-anchor='middle' x='416' y='84' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='416' y='100' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='416' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='416' y='148' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='416' y='164' fill='currentColor' style='font-size:1em'>f</text>
<text text-anchor='middle' x='416' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='424' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='424' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='424' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='424' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='424' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='424' y='148' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='424' y='164' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='424' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='432' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='432' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='432' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='432' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='432' y='132' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='432' y='148' fill='currentColor' style='font-size:1em'>3</text>
<text text-anchor='middle' x='432' y='164' fill='currentColor' style='font-size:1em'>4</text>
<text text-anchor='middle' x='432' y='180' fill='currentColor' style='font-size:1em'>7</text>
<text text-anchor='middle' x='440' y='52' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='440' y='68' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='440' y='84' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='440' y='100' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='440' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='440' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='440' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='448' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='448' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='448' y='180' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='456' y='148' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='456' y='164' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='456' y='180' fill='currentColor' style='font-size:1em'>0</text>
</g>

    </svg>
  
</div>
<ol>
<li>Insert <code>if(p-&gt;pid==1) vmprint(p-&gt;pagetable)</code> in <code>exec.c</code> just before the return argc, to print the first process&rsquo;s page table</li>
</ol>
<h4 id="vmc"><code>vm.c</code><a hidden class="anchor" aria-hidden="true" href="#vmc">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">vmprint</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, <span style="color:#66d9ef">int</span> level)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (level <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;page table %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pagetable);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// there are 2^9 = 512 PTEs in a page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">512</span>; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pte_t</span> pte <span style="color:#f92672">=</span> pagetable[i];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(pte <span style="color:#f92672">&amp;</span> PTE_V){
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// this PTE points to a lower-level page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// print a PTE in this level
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; j <span style="color:#f92672">&gt;=</span> level; j<span style="color:#f92672">--</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34; ..&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d: pte %p pa %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, i, pte, <span style="color:#a6e22e">PTE2PA</span>(pte));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (level <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        uint64 child <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(pte);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">vmprint</span>((<span style="color:#66d9ef">pagetable_t</span>)child, level <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(pte <span style="color:#f92672">&amp;</span> PTE_V){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;freewalk: leaf&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="kerneldefsh"><code>kernel/defs.h</code><a hidden class="anchor" aria-hidden="true" href="#kerneldefsh">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>            <span style="color:#a6e22e">vmprint</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, <span style="color:#66d9ef">int</span>);
</span></span></code></pre></div><h4 id="kernelexecc"><code>kernel/exec.c</code><a hidden class="anchor" aria-hidden="true" href="#kernelexecc">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">exec</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ... //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>pid<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vmprint</span>(p<span style="color:#f92672">-&gt;</span>pagetable, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> argc; <span style="color:#75715e">// this ends up in a0, the first argument to main(argc, argv)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ... //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h2 id="23-detect-which-pages-have-been-accessed">2.3 Detect which pages have been accessed<a hidden class="anchor" aria-hidden="true" href="#23-detect-which-pages-have-been-accessed">#</a></h2>
<p>Some garbage collectors (a form of automatic memory management) can benefit from information about which pages have been accessed (read or write).
In this part of the lab, you will add a new feature to xv6 that detects and reports this information to userspace by inspecting the access bits in the RISC-V page table.
The RISC-V hardware page walker marks these bits in the PTE whenever it resolves a TLB miss.</p>
<p>Your job is to implement <code>pgaccess()</code>, a system call that reports which pages have been accessed.
The system call takes three arguments. First, it takes the starting virtual address of the first user page to check.
Second, it takes the number of pages to check. Finally, it takes a user address to a buffer to store the results into a bitmask (a datastructure that uses one bit per page and where the first page corresponds to the least significant bit).
You will receive full credit for this part of the lab if the pgaccess test case passes when running pgtbltest.</p>
<ul>
<li>Read <code>pgaccess_test()</code> in <code>user/pgtlbtest.c</code> to see how pgaccess is used.</li>
<li>Start by implementing <code>sys_pgaccess()</code> in <code>kernel/sysproc.c</code>.</li>
<li>You&rsquo;ll need to parse arguments using argaddr() and argint().</li>
<li>For the output bitmask, it&rsquo;s easier to store a temporary buffer in the kernel and copy it to the user (via copyout()) after filling it with the right bits.</li>
<li>It&rsquo;s okay to set an upper limit on the number of pages that can be scanned.</li>
<li>walk() in kernel/vm.c is very useful for finding the right PTEs.</li>
<li>You&rsquo;ll need to define <code>PTE_A</code>, the access bit, in kernel/riscv.h. Consult the RISC-V privileged architecture manual to determine its value.</li>
<li>Be sure to clear <code>PTE_A</code> after checking if it is set. Otherwise, it won&rsquo;t be possible to determine if the page was accessed since the last time <code>pgaccess()</code> was called (i.e., the bit will be set forever).</li>
<li><code>vmprint()</code> may come in handy to debug page tables.</li>
</ul>
<p>先觀察 <code>pgaccess_test()</code> 是如何使用 <code>pgaccess()</code> 的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pgaccess_test</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> abits;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;pgaccess_test starting</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  testname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pgaccess_test&#34;</span>;
</span></span><span style="display:flex;"><span>  buf <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">32</span> <span style="color:#f92672">*</span> PGSIZE);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pgaccess</span>(buf, <span style="color:#ae81ff">32</span>, <span style="color:#f92672">&amp;</span>abits) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">err</span>(<span style="color:#e6db74">&#34;pgaccess failed&#34;</span>);
</span></span><span style="display:flex;"><span>  buf[PGSIZE <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  buf[PGSIZE <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  buf[PGSIZE <span style="color:#f92672">*</span> <span style="color:#ae81ff">30</span>] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pgaccess</span>(buf, <span style="color:#ae81ff">32</span>, <span style="color:#f92672">&amp;</span>abits) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">err</span>(<span style="color:#e6db74">&#34;pgaccess failed&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (abits <span style="color:#f92672">!=</span> ((<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">|</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">|</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">30</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">err</span>(<span style="color:#e6db74">&#34;incorrect access bits set&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">free</span>(buf);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;pgaccess_test: OK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>這就是一個 <code>pgaccess</code> 的使用例子</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#a6e22e">pgaccess</span>(buf, <span style="color:#ae81ff">32</span>, <span style="color:#f92672">&amp;</span>abits)
</span></span></code></pre></div><p>以這個例子來說，我們要檢查 buf 開始的 32 個 page 的 access bit 是否有設為 1</p>
<ul>
<li>
<p><code>malloc()</code> 幫我們做出的 32 個 page 是個什麼樣子的存在？</p>
</li>
<li>
<p>首先請先認知到一個 process 只有一個 page table</p>
</li>
<li>
<p>第 2 點，請再認知到，<code>malloc()</code> 給我們的是連續的 virtual memory</p>
</li>
<li>
<p>但問題是我們現在要用的是以一個 page 為單位</p>
<ul>
<li>所以這裡所說的 page 會是 level 0 的 page</li>
<li>因為現在再說的 page 會是 一個 PAGESIZE 的大小</li>
</ul>
</li>
<li>
<p>在 kernel 中 (<code>sys_pgaccess()</code>) 要如何使用 walk()</p>
<ul>
<li>因為我現在並不知道 page table 的 physical address</li>
</ul>
</li>
<li>
<p>要使用 <code>copyout()</code></p>
</li>
<li>
<p><code>kernel/sysproc.c: sys_pgaccess()</code></p>
</li>
</ul>
<pre tabindex="0"><code class="language-Clike=" data-lang="Clike=">int
sys_pgaccess(void) {
  uint64 start;
  int npages;
  uint64 abitsaddr;
  uint64 va;
  uint64 mask;
  uint64 abits;

  struct proc *p = myproc();
  argaddr(0, &amp;start);
  argint(1, &amp;npages);
  argaddr(2, &amp;abitsaddr);

  if (npages &gt; 64)
    return -1;

  mask = 1;
  abits = 0;
  for(va = start; va &lt; start + PGSIZE * npages; va += PGSIZE){
    pte_t *pte = walk(p-&gt;pagetable, va, 0);
    if(*pte &amp; PTE_A) {
      abits |= mask;
      *pte = *pte &amp; (~PTE_A);
    }
    mask &lt;&lt;= 1;
  }

  if (copyout(p-&gt;pagetable, abitsaddr, (char *)&amp;abits, 4) &lt; 0)
    return -1;
  return 0;
}
</code></pre><h2 id="參考資料">參考資料<a hidden class="anchor" aria-hidden="true" href="#參考資料">#</a></h2>
<ul>
<li><a href="https://pdos.csail.mit.edu/6.S081/2022/labs/pgtbl.html">https://pdos.csail.mit.edu/6.S081/2022/labs/pgtbl.html</a></li>
<li>chapter 3 of <a href="https://pdos.csail.mit.edu/6.S081/2022/xv6/book-riscv-rev3.pdf">xv6 book</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Yama&#39;s Trail</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

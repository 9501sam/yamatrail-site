<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>[xv6 學習紀錄 03] Lab: page tables | Yama&#39;s Trail</title>
<meta name="keywords" content="">
<meta name="description" content="Lab 連結: lab pgtbl
Speed up system calls (easy)
題目敘述:

When each process is created, map one read-only page at USYSCALL (a virtual address defined in memlayout.h). At the start of this page, store a struct usyscall (also defined in memlayout.h), and initialize it to store the PID of the current process. For this lab, ugetpid() has been provided on the userspace side and will automatically use the USYSCALL mapping. You will receive full credit for this part of the lab if the ugetpid test case passes when running pgtbltest.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/xv6/lab3/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e1f5c4cae44599655f7ff95195ff89c8cb3adbda94f2b1581a434ab2b4d4e6cf.css" integrity="sha256-4fXEyuRFmWVff/lRlf&#43;JyMs629qU8rFYGkNKsrTU5s8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon_io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon_io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon_io/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon_io/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/xv6/lab3/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Yama&#39;s Trail (Alt + H)">Yama&#39;s Trail</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/dev-log/" title="這個網站的誕生">
                    <span>這個網站的誕生</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/leetcode/" title="LeetCode 解題">
                    <span>LeetCode 解題</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xv6/" title="xv6 學習紀錄">
                    <span>xv6 學習紀錄</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/linux-kernel-programming/" title="Linux Kernel Programming">
                    <span>Linux Kernel Programming</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      [xv6 學習紀錄 03] Lab: page tables
    </h1>
    <div class="post-meta"><span title='2025-10-02 13:09:35 +0800 CST'>October 2, 2025</span>

</div>
  </header> 
  <div class="post-content"><p>Lab 連結: <a href="https://pdos.csail.mit.edu/6.S081/2022/labs/pgtbl.html">lab pgtbl</a></p>
<h2 id="speed-up-system-calls-easy">Speed up system calls (easy)<a hidden class="anchor" aria-hidden="true" href="#speed-up-system-calls-easy">#</a></h2>
<p>題目敘述:</p>
<blockquote>
<p>When each process is created, map one read-only page at <code>USYSCALL</code> (a virtual address defined in <code>memlayout.h</code>). At the start of this page, store a struct <code>usyscall</code> (also defined in <code>memlayout.h</code>), and initialize it to store the PID of the current process. For this lab, <code>ugetpid()</code> has been provided on the userspace side and will automatically use the <code>USYSCALL</code> mapping. You will receive full credit for this part of the lab if the <code>ugetpid</code> test case passes when running <code>pgtbltest</code>.</p></blockquote>
<h3 id="目標寫出-ugetpid-優化版本的-getpid">目標：寫出 <code>ugetpid()</code> (優化版本的 <code>getpid()</code>)<a hidden class="anchor" aria-hidden="true" href="#目標寫出-ugetpid-優化版本的-getpid">#</a></h3>
<ul>
<li><code>getpid()</code>:
<ul>
<li>會需要使用到 <code>SYS_getpid</code> 這個 system call</li>
<li>但是使用 system call 本身是耗費時間的</li>
</ul>
</li>
<li><code>ugetpid()</code>
<ul>
<li>這個 function 直接不需要經由 system call 就可以達到相同的效果</li>
</ul>
</li>
</ul>
<h3 id="作法">作法<a hidden class="anchor" aria-hidden="true" href="#作法">#</a></h3>
<p>當一個 proccess 開始執行時，在 virtual memory address <code>USYSCALL</code>(定義在 <code>kernel/memlayout.h</code>) 中存放 <code>struct usyscall</code> 並且把 PID 存放於這個 struct 中。<code>ugetpid()</code> 是一個 user space 就可以執行的 function，所以可以跳過原本的 system call 的過程，以達到加速的效果。</p>
<h3 id="原本的-getpid-的流程為何">原本的 <code>getpid()</code> 的流程為何<a hidden class="anchor" aria-hidden="true" href="#原本的-getpid-的流程為何">#</a></h3>
<ol>
<li><code>user/pgtbltest.c: ugetpid_test()</code></li>
<li><code>getpid()</code></li>
<li><code>usys.S</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">.global</span> <span style="color:#66d9ef">getpid</span>
</span></span><span style="display:flex;"><span>getpid:
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">li</span> <span style="color:#66d9ef">a7</span>, <span style="color:#66d9ef">SYS_getpid</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">ecall</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">ret</span>
</span></span></code></pre></div></li>
<li><code>kernel/trampoline.S: uservec</code></li>
<li><code>kernel/trap.c: usertrap()</code></li>
<li><code>syscall.c: syscall()</code></li>
<li><code>sysproc.c: sys_getpid()</code></li>
<li><code>myproc()</code></li>
<li><code>kernel/trampoline.S: uservec</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_getpid</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">myproc</span>()<span style="color:#f92672">-&gt;</span>pid;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<h3 id="優化版的-getpid-的流程為何">優化版的 <code>getpid()</code> 的流程為何<a hidden class="anchor" aria-hidden="true" href="#優化版的-getpid-的流程為何">#</a></h3>
<ol>
<li><code>user/pgtbltest.c: ugetpid_test()</code></li>
<li><code>ugetpid()</code></li>
<li><code>user/ulib.c: ugetpid()</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// ulib.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ugetpid</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> usyscall <span style="color:#f92672">*</span>u <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> usyscall <span style="color:#f92672">*</span>)USYSCALL;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> u<span style="color:#f92672">-&gt;</span>pid;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<p>如同先前看到的 process address space
<img alt="process_layout2.png" loading="lazy" src="/xv6/lab3/process_layout2.png">
最高的 address 依序是 <code>MAXVA</code>, <code>TRAMPOLINE</code>, <code>TRAPFRAME</code>, 這一題則是要再加上 <code>USYSCALL</code></p>
<h3 id="程式實作">程式實作<a hidden class="anchor" aria-hidden="true" href="#程式實作">#</a></h3>
<h4 id="usyscall-題目幫我們定義好了"><code>usyscall</code> 題目幫我們定義好了<a hidden class="anchor" aria-hidden="true" href="#usyscall-題目幫我們定義好了">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/memlayout.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> usyscall {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> pid;  <span style="color:#75715e">// Process ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><p>之後每一個 process 都會存放一份 <code>usyscall</code></p>
<h4 id="kernelproch-中"><code>kernel/proc.h</code> 中<a hidden class="anchor" aria-hidden="true" href="#kernelproch-中">#</a></h4>
<p>先在 <code>proc_pagetable()</code> 中加入</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Per-process state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> proc {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> spinlock lock;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// p-&gt;lock must be held when using these:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">enum</span> procstate state;        <span style="color:#75715e">// Process state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>chan;                  <span style="color:#75715e">// If non-zero, sleeping on chan
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> killed;                  <span style="color:#75715e">// If non-zero, have been killed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> xstate;                  <span style="color:#75715e">// Exit status to be returned to parent&#39;s wait
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> pid;                     <span style="color:#75715e">// Process ID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// wait_lock must be held when using this:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>parent;         <span style="color:#75715e">// Parent process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// these are private to the process, so p-&gt;lock need not be held.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 kstack;               <span style="color:#75715e">// Virtual address of kernel stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 sz;                   <span style="color:#75715e">// Size of process memory (bytes)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">pagetable_t</span> pagetable;       <span style="color:#75715e">// User page table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> trapframe <span style="color:#f92672">*</span>trapframe; <span style="color:#75715e">// data page for trampoline.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> context context;      <span style="color:#75715e">// swtch() here to run process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>ofile[NOFILE];  <span style="color:#75715e">// Open files
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>cwd;           <span style="color:#75715e">// Current directory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> name[<span style="color:#ae81ff">16</span>];               <span style="color:#75715e">// Process name (debugging)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> usyscall <span style="color:#f92672">*</span>usyscall;   <span style="color:#75715e">// add this !!!!!!!!!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><p>準備好 data 之後，之後要在 allocate 時以及 free 時做一些處理</p>
<h4 id="allocate-時">allocate 時:<a hidden class="anchor" aria-hidden="true" href="#allocate-時">#</a></h4>
<ul>
<li><code>kernel/proc.c: allocproc()</code></li>
<li><code>kernel/proc.c: proc_pagetable()</code></li>
</ul>
<h4 id="free-時">free 時:<a hidden class="anchor" aria-hidden="true" href="#free-時">#</a></h4>
<ul>
<li><code>kernel/proc.c: freeproc()</code></li>
<li><code>kernel/proc.c: proc_freepagetable()</code></li>
</ul>
<h4 id="kernelprocc-allocproc"><code>kernel/proc.c: allocproc()</code><a hidden class="anchor" aria-hidden="true" href="#kernelprocc-allocproc">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> proc<span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">allocproc</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(p <span style="color:#f92672">=</span> proc; p <span style="color:#f92672">&lt;</span> <span style="color:#f92672">&amp;</span>proc[NPROC]; p<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">==</span> UNUSED) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> found;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>found:
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">allocpid</span>();
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> USED;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Allocate a trapframe page.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>((p<span style="color:#f92672">-&gt;</span>trapframe <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> trapframe <span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">freeproc</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Allocate and initialize a usyscall page !!!!!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>((p<span style="color:#f92672">-&gt;</span>usyscall <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> usyscall <span style="color:#f92672">*</span>)<span style="color:#a6e22e">kalloc</span>()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){ <span style="color:#75715e">// here!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">freeproc</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>usyscall<span style="color:#f92672">-&gt;</span>pid <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>pid; <span style="color:#f92672">!!!!!!!!!!!!!!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// An empty user page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  p<span style="color:#f92672">-&gt;</span>pagetable <span style="color:#f92672">=</span> <span style="color:#a6e22e">proc_pagetable</span>(p);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>pagetable <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">freeproc</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Set up new context to start executing at forkret,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// which returns to user space.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>context, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(p<span style="color:#f92672">-&gt;</span>context));
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>context.ra <span style="color:#f92672">=</span> (uint64)forkret;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>context.sp <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>kstack <span style="color:#f92672">+</span> PGSIZE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> p;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="kernelprocc-proc_pagetable"><code>kernel/proc.c: proc_pagetable()</code>:<a hidden class="anchor" aria-hidden="true" href="#kernelprocc-proc_pagetable">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Create a user page table for a given process, with no user memory,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// but with trampoline and trapframe pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pagetable_t</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">proc_pagetable</span>(<span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pagetable_t</span> pagetable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// An empty page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  pagetable <span style="color:#f92672">=</span> <span style="color:#a6e22e">uvmcreate</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(pagetable <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// map the trampoline code (for system call return)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// at the highest user virtual address.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// only the supervisor uses it, on the way
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// to/from user space, so not PTE_U.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(pagetable, TRAMPOLINE, PGSIZE,
</span></span><span style="display:flex;"><span>              (uint64)trampoline, PTE_R <span style="color:#f92672">|</span> PTE_X) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmfree</span>(pagetable, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// map the trapframe page just below the trampoline page, for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// trampoline.S.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(pagetable, TRAPFRAME, PGSIZE,
</span></span><span style="display:flex;"><span>              (uint64)(p<span style="color:#f92672">-&gt;</span>trapframe), PTE_R <span style="color:#f92672">|</span> PTE_W) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAMPOLINE, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmfree</span>(pagetable, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// map one read-only page at USYSCALL !!!!!!!!!!!!!!!!!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">mappages</span>(pagetable, USYSCALL, PGSIZE,
</span></span><span style="display:flex;"><span>              (uint64)(p<span style="color:#f92672">-&gt;</span>usyscall), PTE_R <span style="color:#f92672">|</span> PTE_U) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 注意是 unmap 己經被 map 好的 TRAMPOLINE, TRAPFRAME
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAMPOLINE, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAPFRAME, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">uvmfree</span>(pagetable, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> pagetable;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="kernelprocc-freeproc"><code>kernel/proc.c: freeproc()</code><a hidden class="anchor" aria-hidden="true" href="#kernelprocc-freeproc">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// free a proc structure and the data hanging from it,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// including user pages.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// p-&gt;lock must be held.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">freeproc</span>(<span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>trapframe)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)p<span style="color:#f92672">-&gt;</span>trapframe);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>trapframe <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// free usyscall !!!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (proc<span style="color:#f92672">-&gt;</span>usyscall)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">kfree</span>((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>) p<span style="color:#f92672">-&gt;</span>usyscall);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>usyscall <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>pagetable)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">proc_freepagetable</span>(p<span style="color:#f92672">-&gt;</span>pagetable, p<span style="color:#f92672">-&gt;</span>sz);
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>pagetable <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>sz <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>pid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>parent <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>name[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>chan <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>killed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>xstate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> UNUSED;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="kernelprocc-proc_freepagetable"><code>kernel/proc.c: proc_freepagetable()</code><a hidden class="anchor" aria-hidden="true" href="#kernelprocc-proc_freepagetable">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// Free a process&#39;s page table, and free the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// physical memory it refers to.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">proc_freepagetable</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable, uint64 sz)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAMPOLINE, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(pagetable, TRAPFRAME, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uvmunmap</span>(pagetable, USYSCALL, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>); <span style="color:#75715e">// unmap USYSCALL !!!!!!!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">uvmfree</span>(pagetable, sz);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="print-a-page-table-easy">Print a page table (easy)<a hidden class="anchor" aria-hidden="true" href="#print-a-page-table-easy">#</a></h2>
<p>題目敘述：</p>
<blockquote>
<p>prints the contents of a page table Define a function called <code>vmprint()</code>. It should take a <code>pagetable_t</code> argument, and print that pagetable in the format described below. Insert <code>if(p-&gt;pid==1) vmprint(p-&gt;pagetable)</code> in <code>exec.c</code> just before the return argc, to print the first process&rsquo;s page table. You receive full credit for this part of the lab if you pass the pte printout test of make grade.</p></blockquote>
<ul>
<li>You can put <code>vmprint()</code> in <code>kernel/vm.c</code>.</li>
<li>Use the macros at the end of the file <code>kernel/riscv.h</code>.</li>
<li>The function <code>freewalk()</code> may be inspirational.</li>
<li>Define the prototype for <code>vmprint</code> in <code>kernel/defs.h</code> so that you can call it from <code>exec.c</code>.</li>
<li>Use <code>%p</code> in your <code>printf</code> calls to print out full 64-bit hex PTEs and addresses as shown in the example.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">page</span> <span style="color:#66d9ef">table</span> <span style="color:#ae81ff">0x0000000087f6b000</span>
</span></span><span style="display:flex;"><span> ..0: <span style="color:#a6e22e">pte</span> <span style="color:#ae81ff">0x0000000021fd9c01</span> <span style="color:#66d9ef">pa</span> <span style="color:#ae81ff">0x0000000087f67000</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">..</span> <span style="color:#66d9ef">..0</span>: <span style="color:#66d9ef">pte</span> <span style="color:#ae81ff">0x0000000021fd9801</span> <span style="color:#66d9ef">pa</span> <span style="color:#ae81ff">0x0000000087f66000</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">..</span> <span style="color:#66d9ef">..</span> <span style="color:#66d9ef">..0</span>: <span style="color:#66d9ef">pte</span> <span style="color:#ae81ff">0x0000000021fda01b</span> <span style="color:#66d9ef">pa</span> <span style="color:#ae81ff">0x0000000087f68000</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">..</span> <span style="color:#66d9ef">..</span> <span style="color:#66d9ef">..1</span>: <span style="color:#66d9ef">pte</span> <span style="color:#ae81ff">0x0000000021fd9417</span> <span style="color:#66d9ef">pa</span> <span style="color:#ae81ff">0x0000000087f65000</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">..</span> <span style="color:#66d9ef">..</span> <span style="color:#66d9ef">..2</span>: <span style="color:#66d9ef">pte</span> <span style="color:#ae81ff">0x0000000021fd9007</span> <span style="color:#66d9ef">pa</span> <span style="color:#ae81ff">0x0000000087f64000</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">..</span> <span style="color:#66d9ef">..</span> <span style="color:#66d9ef">..3</span>: <span style="color:#66d9ef">pte</span> <span style="color:#ae81ff">0x0000000021fd8c17</span> <span style="color:#66d9ef">pa</span> <span style="color:#ae81ff">0x0000000087f63000</span>
</span></span><span style="display:flex;"><span> ..255: <span style="color:#a6e22e">pte</span> <span style="color:#ae81ff">0x0000000021fda801</span> <span style="color:#66d9ef">pa</span> <span style="color:#ae81ff">0x0000000087f6a000</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">..</span> <span style="color:#66d9ef">..511</span>: <span style="color:#66d9ef">pte</span> <span style="color:#ae81ff">0x0000000021fda401</span> <span style="color:#66d9ef">pa</span> <span style="color:#ae81ff">0x0000000087f69000</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">..</span> <span style="color:#66d9ef">..</span> <span style="color:#66d9ef">..509</span>: <span style="color:#66d9ef">pte</span> <span style="color:#ae81ff">0x0000000021fdcc13</span> <span style="color:#66d9ef">pa</span> <span style="color:#ae81ff">0x0000000087f73000</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">..</span> <span style="color:#66d9ef">..</span> <span style="color:#66d9ef">..510</span>: <span style="color:#66d9ef">pte</span> <span style="color:#ae81ff">0x0000000021fdd007</span> <span style="color:#66d9ef">pa</span> <span style="color:#ae81ff">0x0000000087f74000</span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">..</span> <span style="color:#66d9ef">..</span> <span style="color:#66d9ef">..511</span>: <span style="color:#66d9ef">pte</span> <span style="color:#ae81ff">0x0000000020001c0b</span> <span style="color:#66d9ef">pa</span> <span style="color:#ae81ff">0x0000000080007000</span>
</span></span><span style="display:flex;"><span>init: <span style="color:#a6e22e">starting</span> <span style="color:#66d9ef">sh</span>
</span></span></code></pre></div><h4 id="kerneldefsh"><code>kernel/defs.h</code><a hidden class="anchor" aria-hidden="true" href="#kerneldefsh">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>            <span style="color:#a6e22e">vmprint</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable);
</span></span></code></pre></div><h4 id="vmc"><code>vm.c</code><a hidden class="anchor" aria-hidden="true" href="#vmc">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">vmprint</span>(<span style="color:#66d9ef">pagetable_t</span> pagetable)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;page table %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pagetable); <span style="color:#75715e">// print level 2 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// there are 2^9 = 512 PTEs in a page table.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">512</span>; i<span style="color:#f92672">++</span>) { <span style="color:#75715e">// iterate PTEs in level 2 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pte_t</span> pte <span style="color:#f92672">=</span> pagetable[i];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">&amp;&amp;</span> (pte <span style="color:#f92672">&amp;</span> (PTE_R<span style="color:#f92672">|</span>PTE_W<span style="color:#f92672">|</span>PTE_X)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { 
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// find a valid PTE in level 2 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      uint64 lv1pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(pte);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">pagetable_t</span> lv1pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pagetable_t</span>) lv1pa;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34; ..%d: pte %p pa %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, i, pte, lv1pagetable); <span style="color:#75715e">// print leve 1 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">512</span>; j<span style="color:#f92672">++</span>) { <span style="color:#75715e">// iterate PTEs in level 1 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">pte_t</span> pte <span style="color:#f92672">=</span> lv1pagetable[j];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">&amp;&amp;</span> (pte <span style="color:#f92672">&amp;</span> (PTE_R<span style="color:#f92672">|</span>PTE_W<span style="color:#f92672">|</span>PTE_X)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) { 
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// find a valid PTE in level 1 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          uint64 lv0pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(pte);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">pagetable_t</span> lv0pagetable <span style="color:#f92672">=</span> (<span style="color:#66d9ef">pagetable_t</span>) lv0pa;
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34; .. ..%d: pte %p pa %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, j, pte, lv0pagetable); <span style="color:#75715e">// print level 0 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> k <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; k <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">512</span>; k<span style="color:#f92672">++</span>) { <span style="color:#75715e">// iterage PTEs in level 0 pagetable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">pte_t</span> pte <span style="color:#f92672">=</span> lv0pagetable[k];
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ((pte <span style="color:#f92672">&amp;</span> PTE_V) <span style="color:#f92672">&amp;&amp;</span> (pte <span style="color:#f92672">&amp;</span> (PTE_R<span style="color:#f92672">|</span>PTE_W<span style="color:#f92672">|</span>PTE_X)) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;vmptint: pagetable PTE in level 0 pagetable&#34;</span>);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (pte <span style="color:#f92672">&amp;</span> PTE_V) { <span style="color:#75715e">// find a leaf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              uint64 pa <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTE2PA</span>(pte);
</span></span><span style="display:flex;"><span>              <span style="color:#75715e">// pagetable_t lv0pagetable = (pagetable_t) lv1pa;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34; .. .. ..%d: pte %p pa %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, k, pte, pa); <span style="color:#75715e">// print leaf
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            }
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (pte <span style="color:#f92672">&amp;</span> PTE_V) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;vmptint: leaf in level 1 pagetable&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (pte <span style="color:#f92672">&amp;</span> PTE_V) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;vmptint: leaf in level 2 pagetable&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>Insert <code>if(p-&gt;pid==1) vmprint(p-&gt;pagetable)</code> in <code>exec.c</code> just before the return argc, to print the first process&rsquo;s page table</p></blockquote>
<p>這裡只是希望 <code>pid == 1</code> 的 process (<code>sh</code>) 可以自動利用 <code>vmprint()</code> print 出 page tabel</p>
<h4 id="kernelexecc"><code>kernel/exec.c</code><a hidden class="anchor" aria-hidden="true" href="#kernelexecc">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">exec</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>path, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ... //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>pid<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vmprint</span>(p<span style="color:#f92672">-&gt;</span>pagetable);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> argc; <span style="color:#75715e">// this ends up in a0, the first argument to main(argc, argv)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ... //
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><blockquote>
<p>Explain the output of <code>vmprint</code> in terms of Fig 3-4 from the text. What does page 0 contain? What is in page 2? When running in user mode, could the process read/write the memory mapped by page 1? What does the third to last page contain?</p></blockquote>
<p>(TODO)</p>
<h2 id="detect-which-pages-have-been-accessed-hard">Detect which pages have been accessed (hard)<a hidden class="anchor" aria-hidden="true" href="#detect-which-pages-have-been-accessed-hard">#</a></h2>
<p>題目敘述：</p>
<blockquote>
<p>Some garbage collectors (a form of automatic memory management) can benefit from information about which pages have been accessed (read or write). In this part of the lab, you will add a new feature to xv6 that detects and reports this information to userspace by inspecting the access bits in the RISC-V page table. The RISC-V hardware page walker marks these bits in the PTE whenever it resolves a TLB miss.</p></blockquote>
<blockquote>
<p>Your job is to implement <code>pgaccess()</code>, a system call that reports which pages have been accessed. The system call takes three arguments. First, it takes the starting virtual address of the first user page to check. Second, it takes the number of pages to check. Finally, it takes a user address to a buffer to store the results into a bitmask (a datastructure that uses one bit per page and where the first page corresponds to the least significant bit). You will receive full credit for this part of the lab if the pgaccess test case passes when running pgtbltest.</p></blockquote>
<p>題目提示：</p>
<ul>
<li>Read <code>pgaccess_test()</code> in <code>user/pgtlbtest.c</code> to see how pgaccess is used.</li>
<li>Start by implementing <code>sys_pgaccess()</code> in <code>kernel/sysproc.c</code>.</li>
<li>You&rsquo;ll need to parse arguments using <code>argaddr()</code> and <code>argint()</code>.</li>
<li>For the output bitmask, it&rsquo;s easier to store a temporary buffer in the kernel and copy it to the user (via <code>copyout()</code>) after filling it with the right bits.</li>
<li>It&rsquo;s okay to set an upper limit on the number of pages that can be scanned.
<ul>
<li>題目的測試是用 <code>unsigned int</code>，因此設定為 32 的 pages 就足夠了</li>
</ul>
</li>
<li><code>walk()</code> in <code>kernel/vm.c</code> is very useful for finding the right PTEs.</li>
<li>You&rsquo;ll need to define <code>PTE_A</code>, the access bit, in <code>kernel/riscv.h</code>. Consult the <a href="https://github.com/riscv/riscv-isa-manual/releases/download/Ratified-IMFDQC-and-Priv-v1.11/riscv-privileged-20190608.pdf">RISC-V privileged architecture manual</a> to determine its value.
<ul>
<li>根據 manual, acessed bit 在 <code>1 &lt;&lt; 6</code> 的位置
<img alt="ptea.png" loading="lazy" src="/xv6/lab3/ptea.png"></li>
<li>並且這個 bit 的賦值是硬體上幫我們做的，不需要用軟體 set</li>
</ul>
</li>
<li>Be sure to clear <code>PTE_A</code> after checking if it is set. Otherwise, it won&rsquo;t be possible to determine if the page was accessed since the last time <code>pgaccess()</code> was called (i.e., the bit will be set forever).</li>
<li><code>vmprint()</code> may come in handy to debug page tables.</li>
</ul>
<p>這題要我們時做出 <code>pgaccess()</code>，先觀察 <code>pgaccess_test()</code> 是如何使用 <code>pgaccess()</code> 的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pgaccess_test</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>buf;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> abits;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;pgaccess_test starting</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  testname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;pgaccess_test&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// buf 有 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 32 個 page == 32 * PGSIZE bytes == 32 * 2 ^ 12 bytes == 32 * 4096 bytes 大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  buf <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">32</span> <span style="color:#f92672">*</span> PGSIZE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// buf 都還沒被 access 過，理論上這時候 abits 應該為 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 0b00000000000000000000000000000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// (32 個 0，代表 buf 的 32 個 page 都還沒被 access 過)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pgaccess</span>(buf, <span style="color:#ae81ff">32</span>, <span style="color:#f92672">&amp;</span>abits) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">err</span>(<span style="color:#e6db74">&#34;pgaccess failed&#34;</span>);
</span></span><span style="display:flex;"><span>  buf[PGSIZE <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// 第 1 個 page 被 access
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  buf[PGSIZE <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// 第 2 個 page 被 access
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  buf[PGSIZE <span style="color:#f92672">*</span> <span style="color:#ae81ff">30</span>] <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// 第 30 個 page 被 access
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 經過上面第 1, 2, 30 個 page 被 access 之後，abits 應該為
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 0b00100000000000000000000000000110
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 第 1, 2, 30 bits 被設定為 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pgaccess</span>(buf, <span style="color:#ae81ff">32</span>, <span style="color:#f92672">&amp;</span>abits) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">err</span>(<span style="color:#e6db74">&#34;pgaccess failed&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (abits <span style="color:#f92672">!=</span> ((<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">|</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">|</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">30</span>)))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">err</span>(<span style="color:#e6db74">&#34;incorrect access bits set&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">free</span>(buf);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;pgaccess_test: OK</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>這就是一個 <code>pgaccess</code> 的使用例子</p>
<h3 id="程式實做">程式實做<a hidden class="anchor" aria-hidden="true" href="#程式實做">#</a></h3>
<ul>
<li><code>kernel/riscv.h</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define PTE_V (1L &lt;&lt; 0) </span><span style="color:#75715e">// valid
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define PTE_R (1L &lt;&lt; 1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTE_W (1L &lt;&lt; 2)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTE_X (1L &lt;&lt; 3)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PTE_U (1L &lt;&lt; 4) </span><span style="color:#75715e">// user can access
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define PTE_A (1L &lt;&lt; 6)
</span></span></span></code></pre></div><p>在這裡加上 <code>PTE_A</code> 的定義，並且這個 bit 是硬體上會幫我們 set 好的，所以我們<strong>不需要</strong>考慮 <code>buf[PGSIZE * 1] += 1;</code> 時還要特地去更改這個 bit。</p>
<ul>
<li><code>kernel/sysproc.c: sys_pgaccess()</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_pgaccess</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 base;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> npages;
</span></span><span style="display:flex;"><span>  uint64 umask;
</span></span><span style="display:flex;"><span>  uint64 mask;
</span></span><span style="display:flex;"><span>  uint64 abits;
</span></span><span style="display:flex;"><span>  uint64 va;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>pte;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argaddr</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>base);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>npages);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">argaddr</span>(<span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span>umask);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (npages <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">32</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  mask <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  abits <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (va <span style="color:#f92672">=</span> base; va <span style="color:#f92672">&lt;</span> base <span style="color:#f92672">+</span> npages <span style="color:#f92672">*</span> PGSIZE; va <span style="color:#f92672">+=</span> PGSIZE) {
</span></span><span style="display:flex;"><span>    pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">walk</span>(p<span style="color:#f92672">-&gt;</span>pagetable, va, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (pte <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> PTE_A) {
</span></span><span style="display:flex;"><span>      abits <span style="color:#f92672">|=</span> mask;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>pte <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>pte <span style="color:#f92672">&amp;</span> (<span style="color:#f92672">~</span>PTE_A);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    mask <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">copyout</span>(p<span style="color:#f92672">-&gt;</span>pagetable, umask, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>) <span style="color:#f92672">&amp;</span>abits, <span style="color:#ae81ff">4</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接著就一個 page 一個 page 的檢查 <code>PTE_A</code>，如果為 1 則 unset 並且紀錄在 <code>abits</code> 中，最後在用 <code>copyout()</code> 把答案寫回給 user process 就行了。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/xv6/lab3.1/">
    <span class="title">« Prev</span>
    <br>
    <span>[xv6 學習紀錄 03-1] Virtual Memory 程式碼解析</span>
  </a>
  <a class="next" href="http://localhost:1313/xv6/lab4.1/">
    <span class="title">Next »</span>
    <br>
    <span>[xv6 學習紀錄 04-1] 使用 GDB 追蹤 xv6 以了解 RISC-V 的 Calling Convention 與 Stack Frames</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/">Yama&#39;s Trail</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>

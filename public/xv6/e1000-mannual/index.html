<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>[xv6 學習紀錄 11-3] E1000 mannual 與其中概念的程式碼實做 | Yama&#39;s Trail</title>
<meta name="keywords" content="">
<meta name="description" content="Initialize
我們首先觀察 lab net 所提供的初始化過程，大致上了解要如何從 E1000 manual 轉換到程式碼


kernel/main.c: main()

kernel/pci.c: pci_init()

kernel/e1000.c: e1000_init(uint32 *xregs)

regs[XXX] = OOO




kernel/sysnet.c: sockinit()

initlock()





kernel/pci.c: pci_init()


void
pci_init()
{
  // we&#39;ll place the e1000 registers at this address.
  // vm.c maps this range.
  // 我們會把 e1000 registers 放到這個位置
  // 如下圖，他會被放在 unused and other I/O devices 的區塊
  // vm.c 會負責做這個 mapping
  uint64 e1000_regs = 0x40000000L;

  // qemu -machine virt puts PCIe config space here.
  // vm.c maps this range.
  // 這裡則是在 mapping PCIe config
  // 跟前面一樣，是放在 unused and other I/O devices 的區塊
  // ECAM for Extended Configuration Access Mechanism
  uint32  *ecam = (uint32 *) 0x30000000L;
  
  // look at each possible PCI device on bus 0.
  // bus == 0 是固定的，只掃描 Primary Bus
  // dev: 0 ~ 31 設備號碼，每一個代表一個獨立設備例如 E1000 網卡、顯示卡，現在要尋找 E1000
  // func: 功能號碼，每一個設備可以有多個 function, 這裡只需要尋找第 0 個功能，E1000 也只有一個功能
  // offset: 指向配置空間中特定 4 位元組暫存器的偏移量, 設為 0
  // off: 透過上面的資訊取得總 offset
  for(int dev = 0; dev &lt; 32; dev&#43;&#43;){
    int bus = 0;
    int func = 0;
    int offset = 0;
    uint32 off = (bus &lt;&lt; 16) | (dev &lt;&lt; 11) | (func &lt;&lt; 8) | (offset);
    volatile uint32 *base = ecam &#43; off;
    uint32 id = base[0];
    
    // 100e:8086 is an e1000
    if(id == 0x100e8086){
      // command and status register.
      // bit 0 : I/O access enable
      // bit 1 : memory access enable
      // bit 2 : enable mastering
      base[1] = 7;
      __sync_synchronize();

      for(int i = 0; i &lt; 6; i&#43;&#43;){
        uint32 old = base[4&#43;i];

        // writing all 1&#39;s to the BAR causes it to be
        // replaced with its size.
        base[4&#43;i] = 0xffffffff;
        __sync_synchronize();

        base[4&#43;i] = old;
      }

      // tell the e1000 to reveal its registers at
      // physical address 0x40000000.
      base[4&#43;0] = e1000_regs;

      e1000_init((uint32*)e1000_regs);
    }
  }
}
">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/xv6/e1000-mannual/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e1f5c4cae44599655f7ff95195ff89c8cb3adbda94f2b1581a434ab2b4d4e6cf.css" integrity="sha256-4fXEyuRFmWVff/lRlf&#43;JyMs629qU8rFYGkNKsrTU5s8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon_io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon_io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon_io/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon_io/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/xv6/e1000-mannual/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Yama&#39;s Trail (Alt + H)">Yama&#39;s Trail</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/dev-log/" title="這個網站的誕生">
                    <span>這個網站的誕生</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/leetcode/" title="LeetCode 解題">
                    <span>LeetCode 解題</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/xv6/" title="xv6 學習紀錄">
                    <span>xv6 學習紀錄</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/linux-kernel-programming/" title="Linux Kernel Programming">
                    <span>Linux Kernel Programming</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      [xv6 學習紀錄 11-3] E1000 mannual 與其中概念的程式碼實做
    </h1>
    <div class="post-meta"><span title='2025-11-21 15:49:48 +0800 CST'>November 21, 2025</span>

</div>
  </header> 
  <div class="post-content"><h2 id="initialize">Initialize<a hidden class="anchor" aria-hidden="true" href="#initialize">#</a></h2>
<p>我們首先觀察 lab net 所提供的初始化過程，大致上了解要如何從 E1000 manual 轉換到程式碼</p>
<ul>
<li>
<p><code>kernel/main.c: main()</code></p>
<ul>
<li><code>kernel/pci.c: pci_init()</code>
<ul>
<li><code>kernel/e1000.c: e1000_init(uint32 *xregs)</code>
<ul>
<li><code>regs[XXX] = OOO</code></li>
</ul>
</li>
</ul>
</li>
<li><code>kernel/sysnet.c: sockinit()</code>
<ul>
<li><code>initlock()</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>kernel/pci.c: pci_init()</code></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pci_init</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// we&#39;ll place the e1000 registers at this address.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// vm.c maps this range.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 我們會把 e1000 registers 放到這個位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 如下圖，他會被放在 unused and other I/O devices 的區塊
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// vm.c 會負責做這個 mapping
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint64 e1000_regs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x40000000L</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// qemu -machine virt puts PCIe config space here.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// vm.c maps this range.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 這裡則是在 mapping PCIe config
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 跟前面一樣，是放在 unused and other I/O devices 的區塊
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// ECAM for Extended Configuration Access Mechanism
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  uint32  <span style="color:#f92672">*</span>ecam <span style="color:#f92672">=</span> (uint32 <span style="color:#f92672">*</span>) <span style="color:#ae81ff">0x30000000L</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// look at each possible PCI device on bus 0.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// bus == 0 是固定的，只掃描 Primary Bus
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// dev: 0 ~ 31 設備號碼，每一個代表一個獨立設備例如 E1000 網卡、顯示卡，現在要尋找 E1000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// func: 功能號碼，每一個設備可以有多個 function, 這裡只需要尋找第 0 個功能，E1000 也只有一個功能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// offset: 指向配置空間中特定 4 位元組暫存器的偏移量, 設為 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// off: 透過上面的資訊取得總 offset
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> dev <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; dev <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">32</span>; dev<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> bus <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> func <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> offset <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    uint32 off <span style="color:#f92672">=</span> (bus <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">|</span> (dev <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">11</span>) <span style="color:#f92672">|</span> (func <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">|</span> (offset);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">volatile</span> uint32 <span style="color:#f92672">*</span>base <span style="color:#f92672">=</span> ecam <span style="color:#f92672">+</span> off;
</span></span><span style="display:flex;"><span>    uint32 id <span style="color:#f92672">=</span> base[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 100e:8086 is an e1000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(id <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x100e8086</span>){
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// command and status register.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// bit 0 : I/O access enable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// bit 1 : memory access enable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// bit 2 : enable mastering
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      base[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__sync_synchronize</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">6</span>; i<span style="color:#f92672">++</span>){
</span></span><span style="display:flex;"><span>        uint32 old <span style="color:#f92672">=</span> base[<span style="color:#ae81ff">4</span><span style="color:#f92672">+</span>i];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// writing all 1&#39;s to the BAR causes it to be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// replaced with its size.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        base[<span style="color:#ae81ff">4</span><span style="color:#f92672">+</span>i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__sync_synchronize</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        base[<span style="color:#ae81ff">4</span><span style="color:#f92672">+</span>i] <span style="color:#f92672">=</span> old;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// tell the e1000 to reveal its registers at
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// physical address 0x40000000.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      base[<span style="color:#ae81ff">4</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> e1000_regs;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">e1000_init</span>((uint32<span style="color:#f92672">*</span>)e1000_regs);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img loading="lazy" src="/xv6/e1000-mannual/kernel_layout.png"></p>
<h2 id="e1000_init"><code>e1000_init()</code><a hidden class="anchor" aria-hidden="true" href="#e1000_init">#</a></h2>
<ul>
<li><code>kernel/e1000.c: e1000_init(uint32 *xregs)</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// called by pci_init().
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// xregs is the memory address at which the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// e1000&#39;s registers are mapped.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e1000_init</span>(uint32 <span style="color:#f92672">*</span>xregs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">initlock</span>(<span style="color:#f92672">&amp;</span>e1000_lock, <span style="color:#e6db74">&#34;e1000&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  regs <span style="color:#f92672">=</span> xregs;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Reset the device
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  regs[E1000_IMS] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// disable interrupts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  regs[E1000_CTL] <span style="color:#f92672">|=</span> E1000_CTL_RST;
</span></span><span style="display:flex;"><span>  regs[E1000_IMS] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// redisable interrupts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">__sync_synchronize</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// [E1000 14.5] Transmit initialization
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">memset</span>(tx_ring, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(tx_ring));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> TX_RING_SIZE; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    tx_ring[i].status <span style="color:#f92672">=</span> E1000_TXD_STAT_DD;
</span></span><span style="display:flex;"><span>    tx_mbufs[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  regs[E1000_TDBAL] <span style="color:#f92672">=</span> (uint64) tx_ring;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">sizeof</span>(tx_ring) <span style="color:#f92672">%</span> <span style="color:#ae81ff">128</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;e1000&#34;</span>);
</span></span><span style="display:flex;"><span>  regs[E1000_TDLEN] <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(tx_ring);
</span></span><span style="display:flex;"><span>  regs[E1000_TDH] <span style="color:#f92672">=</span> regs[E1000_TDT] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// [E1000 14.4] Receive initialization
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">memset</span>(rx_ring, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(rx_ring));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> RX_RING_SIZE; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    rx_mbufs[i] <span style="color:#f92672">=</span> <span style="color:#a6e22e">mbufalloc</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>rx_mbufs[i])
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;e1000&#34;</span>);
</span></span><span style="display:flex;"><span>    rx_ring[i].addr <span style="color:#f92672">=</span> (uint64) rx_mbufs[i]<span style="color:#f92672">-&gt;</span>head;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  regs[E1000_RDBAL] <span style="color:#f92672">=</span> (uint64) rx_ring;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">sizeof</span>(rx_ring) <span style="color:#f92672">%</span> <span style="color:#ae81ff">128</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;e1000&#34;</span>);
</span></span><span style="display:flex;"><span>  regs[E1000_RDH] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  regs[E1000_RDT] <span style="color:#f92672">=</span> RX_RING_SIZE <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  regs[E1000_RDLEN] <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(rx_ring);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// filter by qemu&#39;s MAC address, 52:54:00:12:34:56
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  regs[E1000_RA] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12005452</span>;
</span></span><span style="display:flex;"><span>  regs[E1000_RA<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5634</span> <span style="color:#f92672">|</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">31</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// multicast table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4096</span><span style="color:#f92672">/</span><span style="color:#ae81ff">32</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    regs[E1000_MTA <span style="color:#f92672">+</span> i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// transmitter control bits.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  regs[E1000_TCTL] <span style="color:#f92672">=</span> E1000_TCTL_EN <span style="color:#f92672">|</span>  <span style="color:#75715e">// enable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    E1000_TCTL_PSP <span style="color:#f92672">|</span>                  <span style="color:#75715e">// pad short packets
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    (<span style="color:#ae81ff">0x10</span> <span style="color:#f92672">&lt;&lt;</span> E1000_TCTL_CT_SHIFT) <span style="color:#f92672">|</span>   <span style="color:#75715e">// collision stuff
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    (<span style="color:#ae81ff">0x40</span> <span style="color:#f92672">&lt;&lt;</span> E1000_TCTL_COLD_SHIFT);
</span></span><span style="display:flex;"><span>  regs[E1000_TIPG] <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span> (<span style="color:#ae81ff">8</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">10</span>) <span style="color:#f92672">|</span> (<span style="color:#ae81ff">6</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">20</span>); <span style="color:#75715e">// inter-pkt gap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// receiver control bits.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  regs[E1000_RCTL] <span style="color:#f92672">=</span> E1000_RCTL_EN <span style="color:#f92672">|</span> <span style="color:#75715e">// enable receiver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    E1000_RCTL_BAM <span style="color:#f92672">|</span>                 <span style="color:#75715e">// enable broadcast
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    E1000_RCTL_SZ_2048 <span style="color:#f92672">|</span>             <span style="color:#75715e">// 2048-byte rx buffers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    E1000_RCTL_SECRC;                <span style="color:#75715e">// strip CRC
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ask e1000 for receive interrupts.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  regs[E1000_RDTR] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// interrupt after every received packet (no timer)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  regs[E1000_RADV] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// interrupt after every packet (no timer)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  regs[E1000_IMS] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">7</span>); <span style="color:#75715e">// RXDW -- Receiver Descriptor Write Back
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h3 id="e1000-145-transmit-initialization">[E1000 14.5] Transmit initialization<a hidden class="anchor" aria-hidden="true" href="#e1000-145-transmit-initialization">#</a></h3>
<p>閱讀 manual 對應的章節</p>
<p>需要關注的 registers</p>
<ul>
<li><code>TDBAL/TDBAH</code>: Transmit Descriptor Base Address
<ul>
<li>總共有 64 bits 的，但切分為兩個 32 bits (Low/High)</li>
<li><code>TDBAL/TDBAH</code> 在 e1000 中，但它的值指向 main memory</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  regs[E1000_TDBAL] <span style="color:#f92672">=</span> (uint64) tx_ring;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">sizeof</span>(tx_ring) <span style="color:#f92672">%</span> <span style="color:#ae81ff">128</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;e1000&#34;</span>);
</span></span></code></pre></div></li>
<li><code>TDLEN</code>: Transmit Descriptor Length
<ul>
<li>得知 descripror ring 的大小</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>regs[E1000_TDLEN] <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(tx_ring);
</span></span></code></pre></div></li>
<li><code>TDH/TDT</code>: Transmit Descriptor Head and Tail
<ul>
<li>initialized (by hardware) to 0b</li>
<li>這裡需要先了解 ring 的架構</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  regs[E1000_TDH] <span style="color:#f92672">=</span> regs[E1000_TDT] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div></li>
<li><code>TCTL</code>: Transmit Control Register
<ul>
<li>Set the Enable (<code>TCTL.EN</code>) bit to 1b for normal operation.</li>
<li>Set the Pad Short Packets (<code>TCTL.PSP</code>) bit to 1b.</li>
<li>Set the Pad Short Packets (<code>TCTL.PSP</code>) bit to 1b.</li>
<li>Configure the Collision Distance (<code>TCTL.COLD</code>) to its expected value. For full duplex operation, this value should be set to 40h. For gigabit half duplex, this value should be set to 200h. For 10/100 half duplex, this value should be set to 40h.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  regs[E1000_TCTL] <span style="color:#f92672">=</span> E1000_TCTL_EN <span style="color:#f92672">|</span>  <span style="color:#75715e">// enable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    E1000_TCTL_PSP <span style="color:#f92672">|</span>                  <span style="color:#75715e">// pad short packets
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    (<span style="color:#ae81ff">0x10</span> <span style="color:#f92672">&lt;&lt;</span> E1000_TCTL_CT_SHIFT) <span style="color:#f92672">|</span>   <span style="color:#75715e">// collision stuff
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    (<span style="color:#ae81ff">0x40</span> <span style="color:#f92672">&lt;&lt;</span> E1000_TCTL_COLD_SHIFT);
</span></span><span style="display:flex;"><span>  regs[E1000_TIPG] <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">|</span> (<span style="color:#ae81ff">8</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">10</span>) <span style="color:#f92672">|</span> (<span style="color:#ae81ff">6</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">20</span>); <span style="color:#75715e">// inter-pkt gap
</span></span></span></code></pre></div></li>
</ul>
<h3 id="e1000-144-receive-initialization">[E1000 14.4] Receive initialization<a hidden class="anchor" aria-hidden="true" href="#e1000-144-receive-initialization">#</a></h3>
<p>閱讀 manual 對應的章節</p>
<p>需要關注的 registers</p>
<ul>
<li><code>RDBAL/RDBAH</code>: Receive Descriptor Base Address
<ul>
<li>跟前面一樣，指向 ring，並且把 64-bits 切分為兩個 register</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  regs[E1000_RDBAL] <span style="color:#f92672">=</span> (uint64) rx_ring;
</span></span></code></pre></div></li>
<li><code>RDH</code>: Receive Descriptor Head
<ul>
<li>初始化為 0</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  regs[E1000_RDH] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div></li>
<li><code>RDT</code>: Receive Descriptor Tail
<ul>
<li>初始化為 0</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  regs[E1000_RDT] <span style="color:#f92672">=</span> RX_RING_SIZE <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span></code></pre></div></li>
<li><code>RDLEN</code>: Receive Descriptor Length
<ul>
<li>must be 128-byte aligned</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#66d9ef">sizeof</span>(rx_ring) <span style="color:#f92672">%</span> <span style="color:#ae81ff">128</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">panic</span>(<span style="color:#e6db74">&#34;e1000&#34;</span>);
</span></span><span style="display:flex;"><span>  regs[E1000_RDLEN] <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(rx_ring);
</span></span></code></pre></div></li>
<li><code>RAL/RAH</code>: Receive Address Register
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#75715e">// filter by qemu&#39;s MAC address, 52:54:00:12:34:56
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  regs[E1000_RA] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12005452</span>;
</span></span><span style="display:flex;"><span>  regs[E1000_RA<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x5634</span> <span style="color:#f92672">|</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">31</span>);
</span></span></code></pre></div></li>
<li><code>RCTL</code>: Receive Control
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#75715e">// receiver control bits.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  regs[E1000_RCTL] <span style="color:#f92672">=</span> E1000_RCTL_EN <span style="color:#f92672">|</span> <span style="color:#75715e">// enable receiver
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    E1000_RCTL_BAM <span style="color:#f92672">|</span>                 <span style="color:#75715e">// enable broadcast
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    E1000_RCTL_SZ_2048 <span style="color:#f92672">|</span>             <span style="color:#75715e">// 2048-byte rx buffers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    E1000_RCTL_SECRC;                <span style="color:#75715e">// strip CRC
</span></span></span></code></pre></div></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ask e1000 for receive interrupts.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>regs[E1000_RDTR] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// interrupt after every received packet (no timer)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>regs[E1000_RADV] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// interrupt after every packet (no timer)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>regs[E1000_IMS] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">7</span>); <span style="color:#75715e">// RXDW -- Receiver Descriptor Write Back
</span></span></span></code></pre></div><p>看完 lab 所提供的 Receive/Transmit 的 Initialization code 之後，大概有個如何從 manual 轉換到 code 的概念，接下來來了解 Receive/Transmit 的運行過程的原理</p>
<h2 id="receive">Receive<a hidden class="anchor" aria-hidden="true" href="#receive">#</a></h2>
<h3 id="e1000-3231-descriptor-中的-status">[E1000 3.2.3.1] Descriptor 中的 status<a hidden class="anchor" aria-hidden="true" href="#e1000-3231-descriptor-中的-status">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* Receive Descriptor bit definitions [E1000 3.2.3.1] */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define E1000_RXD_STAT_DD       0x01    </span><span style="color:#75715e">/* Descriptor Done */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define E1000_RXD_STAT_EOP      0x02    </span><span style="color:#75715e">/* End of Packet */</span><span style="color:#75715e">
</span></span></span></code></pre></div><p><img alt="RDESC.STATUS.png" loading="lazy" src="/xv6/e1000-mannual/RDESC.STATUS.png"></p>
<ul>
<li><code>E1000_TXD_STAT_DD</code> Descriptor Done
<ul>
<li>表示 Hardware 是否處理完這個 Descriptor</li>
<li>如果 <code>E1000_TXD_STAT_DD</code> &amp; <code>E1000_TXD_CMD_EOP</code> 代表這個 packet 已經完全存放於 main memory</li>
</ul>
</li>
<li><code>E1000_TXD_CMD_EOP</code>: End of Packet
<ul>
<li>表示這個 descriptor 是所屬 packet 的最後一個 descriptor</li>
</ul>
</li>
</ul>
<h3 id="e1000-323-receive-的-descriptor">[E1000 3.2.3] Receive 的 descriptor<a hidden class="anchor" aria-hidden="true" href="#e1000-323-receive-的-descriptor">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// [E1000 3.2.3]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> rx_desc
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 addr;       <span style="color:#75715e">/* Address of the descriptor&#39;s data buffer */</span>
</span></span><span style="display:flex;"><span>  uint16 length;     <span style="color:#75715e">/* Length of data DMAed into data buffer */</span>
</span></span><span style="display:flex;"><span>  uint16 csum;       <span style="color:#75715e">/* Packet checksum */</span>
</span></span><span style="display:flex;"><span>  uint8 status;      <span style="color:#75715e">/* Descriptor status */</span>
</span></span><span style="display:flex;"><span>  uint8 errors;      <span style="color:#75715e">/* Descriptor Errors */</span>
</span></span><span style="display:flex;"><span>  uint16 special;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p><img alt="RDESC-layout.png" loading="lazy" src="/xv6/e1000-mannual/RDESC-layout.png"></p>
<ul>
<li><code>addr</code>: 指向所屬的 <code>mbuf</code></li>
<li><code>status</code>: 前一小結提及的，需要注意的只有 <code>DD</code> 與 <code>EOP</code></li>
<li><code>length</code>: 大小，應該是 HW 幫我們做設定的，driver 的責任在於接續設定到 <code>mbuf</code></li>
</ul>
<h3 id="receive-ring">Receive Ring<a hidden class="anchor" aria-hidden="true" href="#receive-ring">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define RX_RING_SIZE 16
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> rx_desc rx_ring[RX_RING_SIZE] <span style="color:#a6e22e">__attribute__</span>((<span style="color:#a6e22e">aligned</span>(<span style="color:#ae81ff">16</span>)));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> mbuf <span style="color:#f92672">*</span>rx_mbufs[RX_RING_SIZE];
</span></span></code></pre></div><p><img alt="RRing.png" loading="lazy" src="/xv6/e1000-mannual/RRing.png"></p>
<ul>
<li>full: <code>RDH == (RDT + 1) % SIZE</code></li>
<li>empty: <code>RDT == RDH</code></li>
<li>先回顧一下，在初始化的階段
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>regs[E1000_RDH] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>regs[E1000_RDT] <span style="color:#f92672">=</span> RX_RING_SIZE <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span></code></pre></div><ul>
<li>這代表的意義是整個 ring 都 owned by hardware</li>
<li>owned by hard ware 代表所有區塊都是可以放入資料的，在初始化的時候也是蠻合理的</li>
</ul>
</li>
</ul>
<h2 id="transmit">Transmit<a hidden class="anchor" aria-hidden="true" href="#transmit">#</a></h2>
<h3 id="cmd">CMD<a hidden class="anchor" aria-hidden="true" href="#cmd">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* Transmit Descriptor command definitions [E1000 3.3.3.1] */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define E1000_TXD_CMD_EOP    0x01 </span><span style="color:#75715e">/* End of Packet */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define E1000_TXD_CMD_RS     0x08 </span><span style="color:#75715e">/* Report Status */</span><span style="color:#75715e">
</span></span></span></code></pre></div><p><img alt="TDESC.CMD.png" loading="lazy" src="/xv6/e1000-mannual/TDESC.CMD.png"></p>
<ul>
<li><code>EOP</code>: End Of Packet
<ul>
<li>
<blockquote>
<p>When set, indicates the last descriptor making up the packet. One or many descriptors can be used to form a packet.</p></blockquote>
</li>
<li>這在寫 driver 的時候要特別注意，傳送最後一個 Packet 的時候要 set <code>EOP</code></li>
</ul>
</li>
<li><code>RS</code> (bit 3): Report Status
<ul>
<li>
<blockquote>
<p>When set, the Ethernet controller needs to report the status information. This ability may be used by software that does in-memory checks of the transmit descriptors to determine which ones are done and packets have been buffered in the transmit FIFO. Software does it by looking at the descriptor status byte and checking the Descriptor Done (DD) bit.</p></blockquote>
</li>
<li>有可能 software 會想要知道哪些 packets 已經完成了，Software 可以經由 Descriptor Done (DD) 得知</li>
</ul>
</li>
</ul>
<h3 id="status">Status<a hidden class="anchor" aria-hidden="true" href="#status">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* Transmit Descriptor status definitions [E1000 3.3.3.2] */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define E1000_TXD_STAT_DD    0x00000001 </span><span style="color:#75715e">/* Descriptor Done */</span><span style="color:#75715e">
</span></span></span></code></pre></div><p><img alt="TSTAT.png" loading="lazy" src="/xv6/e1000-mannual/TSTAT.png"></p>
<ul>
<li><code>DD</code>: Descriptor Done
<ul>
<li>
<blockquote>
<p>Indicates that the descriptor is finished and is written back either after the descriptor has been processed (with RS set) or for the 82544GC/EI, after the packet has been transmitted on the wire (with RPS set).</p></blockquote>
</li>
<li>這個跟先前的 Report Status 是配合的，有了 RS，DD 才會有用</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// [E1000 3.3.3]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> tx_desc
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 addr;
</span></span><span style="display:flex;"><span>  uint16 length;
</span></span><span style="display:flex;"><span>  uint8 cso;
</span></span><span style="display:flex;"><span>  uint8 cmd;
</span></span><span style="display:flex;"><span>  uint8 status;
</span></span><span style="display:flex;"><span>  uint8 css;
</span></span><span style="display:flex;"><span>  uint16 special;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p><img alt="TDESC-layout.png" loading="lazy" src="/xv6/e1000-mannual/TDESC-layout.png"></p>
<ul>
<li><code>addr</code>
<ul>
<li>指向對應的 <code>mbuf</code></li>
</ul>
</li>
<li><code>CMD</code>
<ul>
<li>如同先前提及的，只需要了解 <code>RS</code> 與 <code>EOP</code></li>
</ul>
</li>
<li><code>STA</code>
<ul>
<li>裡面有 <code>DD</code> 可以查看</li>
</ul>
</li>
<li><code>length</code>
<ul>
<li>這個跟 <code>m-&gt;len</code> 應該要互相呼應</li>
</ul>
</li>
</ul>
<h3 id="transmit-ring">Transmit Ring<a hidden class="anchor" aria-hidden="true" href="#transmit-ring">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define TX_RING_SIZE 16
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> tx_desc tx_ring[TX_RING_SIZE] <span style="color:#a6e22e">__attribute__</span>((<span style="color:#a6e22e">aligned</span>(<span style="color:#ae81ff">16</span>)));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> mbuf <span style="color:#f92672">*</span>tx_mbufs[TX_RING_SIZE];
</span></span></code></pre></div><p><img alt="TRing.png" loading="lazy" src="/xv6/e1000-mannual/TRing.png"></p>
<ul>
<li>這個跟剛剛的 receive ring 很像，ring 的內容同樣是 owned by hardware</li>
<li>注意 <code>tx_ring</code> 在初始化的時候
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>regs[E1000_TDH] <span style="color:#f92672">=</span> regs[E1000_TDT] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><ul>
<li>這代表的是 empty，這也算合理，也合理，因為 transmit 的時候要先是全部 owned by software，software 把資料放進去之後，才是 owned by hardware，給 hardware 處理</li>
</ul>
</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/xv6/ch5-interrupt-and-device-drivers/">
    <span class="title">« Prev</span>
    <br>
    <span>[xv6 學習紀錄 11-2] xv6 book ch5: Interrupts and device drivers</span>
  </a>
  <a class="next" href="http://localhost:1313/xv6/lab11/">
    <span class="title">Next »</span>
    <br>
    <span>[xv6 學習紀錄 11] Lab net: Network driver</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="http://localhost:1313/">Yama&#39;s Trail</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
